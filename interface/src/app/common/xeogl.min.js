/*
 * xeogl V1.0.0
 *
 * A WebGL-based 3D visualization engine from xeoLabs
 * http://xeogl.org/
 *
 * Built on 2017-11-22
 *
 * MIT License
 * Copyright 2017, Lindsay Kay
 * http://xeolabs.com/
 *
 */

!function(){"use strict";var a=function(){var a=[],b=0,c=[],d=0;this.length=0,this.shift=function(){if(d>=b){var e=a;if(e.length=0,a=c,c=e,d=0,!(b=a.length))return}var f=a[d];return d<0?delete a[d++]:a[d++]=void 0,this.length--,f},this.push=function(a){return this.length++,c.push(a),this},this.unshift=function(b){return a[--d]=b,this.length++,this}},b=function(){this.version=null,this.WEBGL_INFO=function(){var a={WEBGL:!1},b=document.createElement("canvas");if(!b)return a;var c=b.getContext("webgl",{antialias:!0})||b.getContext("experimental-webgl",{antialias:!0});return a.WEBGL=!!c,a.WEBGL?(a.ANTIALIAS=c.getContextAttributes().antialias,c.getShaderPrecisionFormat?c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.HIGH_FLOAT).precision>0?a.FS_MAX_FLOAT_PRECISION="highp":c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.MEDIUM_FLOAT).precision>0?a.FS_MAX_FLOAT_PRECISION="mediump":a.FS_MAX_FLOAT_PRECISION="lowp":a.FS_MAX_FLOAT_PRECISION="mediump",a.DEPTH_BUFFER_BITS=c.getParameter(c.DEPTH_BITS),a.MAX_TEXTURE_SIZE=c.getParameter(c.MAX_TEXTURE_SIZE),a.MAX_CUBE_MAP_SIZE=c.getParameter(c.MAX_CUBE_MAP_TEXTURE_SIZE),a.MAX_RENDERBUFFER_SIZE=c.getParameter(c.MAX_RENDERBUFFER_SIZE),a.MAX_TEXTURE_UNITS=c.getParameter(c.MAX_COMBINED_TEXTURE_IMAGE_UNITS),a.MAX_TEXTURE_IMAGE_UNITS=c.getParameter(c.MAX_TEXTURE_IMAGE_UNITS),a.MAX_VERTEX_ATTRIBS=c.getParameter(c.MAX_VERTEX_ATTRIBS),a.MAX_VERTEX_UNIFORM_VECTORS=c.getParameter(c.MAX_VERTEX_UNIFORM_VECTORS),a.MAX_FRAGMENT_UNIFORM_VECTORS=c.getParameter(c.MAX_FRAGMENT_UNIFORM_VECTORS),a.MAX_VARYING_VECTORS=c.getParameter(c.MAX_VARYING_VECTORS),a.SUPPORTED_EXTENSIONS={},c.getSupportedExtensions().forEach(function(b){a.SUPPORTED_EXTENSIONS[b]=!0}),a):a}(),this.stats={build:{version:b.version},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,entities:0},memory:{meshes:0,positions:0,colors:0,normals:0,tangents:0,uvs:0,indices:0,textures:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,tasksRun:0,tasksScheduled:0}},this._sceneIDMap=null,this._scene=null,this.scenes={},this._scenesRenderInfo={},this._superTypes={},this._taskQueue=new a;var c=this;!function(){function a(){g=Date.now();var a=c._runScheduledTasks(g+k),b=c._taskQueue.length;c.stats.frame.tasksRun=a,c.stats.frame.tasksScheduled=b,c.stats.frame.tasksBudget=k,j.time=g;for(h in c.scenes)c.scenes.hasOwnProperty(h)&&(i=c.scenes[h],j.sceneId=h,j.startTime=i.startTime,j.deltaTime=null!=j.prevTime?j.time-j.prevTime:0,i.fire("tick",j,!0));j.prevTime=g}function b(){var a,b,d,e=c.scenes,f=c._scenesRenderInfo;for(h in e)e.hasOwnProperty(h)&&(a=e[h],b=f[h],d=a.ticksPerRender,b.ticksPerRender!==d&&(b.ticksPerRender=d,b.renderCountdown=d),0==--b.renderCountdown&&(a.render(!1),b.renderCountdown=d))}var d,e,f,g,h,i,j={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},k=10,l=0,m=[],n=30,o=0,p=function(){d=Date.now(),l>0&&(e=d-l,f=1e3/e,o+=f,m.push(f),m.length>=n&&(o-=m.shift()),c.stats.frame.fps=Math.round(o/m.length)),a(),b(),l=d,window.requestAnimationFrame(p)};window.requestAnimationFrame(p)}()};b.prototype={constructor:b,get scene(){return this._scene||(this._scene=new window.xeogl.Scene({id:"default.scene"}))},set scene(a){this._scene=a},_addScene:function(a){if(this._sceneIDMap=this._sceneIDMap||new window.xeogl.utils.Map,a.id){if(this.scenes[a.id])return void console.error("[ERROR] Scene "+b._inQuotes(a.id)+" already exists")}else a.id=this._sceneIDMap.addItem(a);this.scenes[a.id]=a;var c=a.ticksPerRender;this._scenesRenderInfo[a.id]={ticksPerRender:c,renderCountdown:c},this.stats.components.scenes++;var d=this;a.on("destroyed",function(){d._sceneIDMap.removeItem(a.id),delete d.scenes[a.id],delete d._scenesRenderInfo[a.id],d.stats.components.scenes--})},scheduleTask:function(a,b){this._taskQueue.push(a),this._taskQueue.push(b)},deferTask:function(a,b){b?a.call(b):a()},_runScheduledTasks:function(a){for(var b,c,d=(new Date).getTime(),e=this._taskQueue,f=0;e.length>0&&d<a;)b=e.shift(),c=e.shift(),c?b.call(c):b(),d=(new Date).getTime(),f++;return f},clear:function(){var a;for(var b in this.scenes)this.scenes.hasOwnProperty(b)&&(a=this.scenes[b],"default.scene"===b?a.clear():a.destroy());this.scenes={}},_isArray:function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},_isString:function(a){return"string"==typeof a||a instanceof String},_isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},_isID:function(a){return b._isString(a)||b._isNumeric(a)},_isSameComponent:function(a,c){return!(!a||!c)&&(b.prototype._isNumeric(a)||b.prototype._isString(a)?""+a:a.id)===(b.prototype._isNumeric(c)||b.prototype._isString(c)?""+c:c.id)},_isFunction:function(a){return"function"==typeof a},_isObject:function(){var a={}.constructor;return function(b){return!!b&&b.constructor===a}}(),_isComponentType:function(a,b){if(b=b||"xeogl.Component",a===b)return!0;var c=this._superTypes[a];if(!c)return!1;for(var d=c.length-1;d>=0;d--)if(c[d]===b)return!0;return!1},_copy:function(a){return this._apply(a,{})},_apply:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_apply2:function(a,b){for(var c in a)a.hasOwnProperty(c)&&void 0!==a[c]&&null!==a[c]&&(b[c]=a[c]);return b},_applyIf:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0!==b[c]&&null!==b[c]||(b[c]=a[c]));return b},_isEmptyObject:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},_inQuotes:function(a){return this._isNumeric(a)?""+a:"'"+a+"'"},_concat:function(a,b){var c=new a.constructor(a.length+b.length);return c.set(a),c.set(b,a.length),c}},window.xeogl=window.xeogl=new b}();var Canvas2Image=function(){var a=document.createElement("canvas"),b=String.fromCharCode,c="image/octet-stream",d=!1;if(!a.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var e=!!a.getContext("2d").getImageData,f=!!a.toDataURL,g=!!window.btoa,h=function(a){var b=parseInt(a.width),c=parseInt(a.height);return a.getContext("2d").getImageData(0,0,b,c)},i=function(a){var c,d,e="";if("string"==typeof a)e=a;else for(d=a,c=0;c<d.length;c++)e+=b(d[c]);return btoa(e)},j=function(a){var c="",d=a.width,e=a.height;c+="BM";var f=d*e*4+54;c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),c+=b(0,0,0,0,54,0,0,0),c+=b(40,0,0,0);var g=d;c+=b(g%256),g=Math.floor(g/256),c+=b(g%256),g=Math.floor(g/256),c+=b(g%256),g=Math.floor(g/256),c+=b(g%256);var h=e;c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),c+=b(1,0,32,0),c+=b(0,0,0,0);var j=d*e*4;c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),c+=b(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var k,l,m,n,o=a.data,p="",q=e;do{for(m=d*(q-1)*4,n="",k=0;k<d;k++)l=4*k,n+=b(o[m+l+2],o[m+l+1],o[m+l],o[m+l+3]);p+=n}while(--q);return i(c+p)},k=function(a){window.open(a)||(document.location.href=a)},l=function(a,b){return"data:"+b+";base64,"+a},m=function(a){var b=document.createElement("img");return b.src=a,b},n=function(a,b,c){if(b&&c){var d=document.createElement("canvas");d.width=b,d.height=c,d.style.width=b+"px",d.style.height=c+"px";return d.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,b,b),d}return a};return{saveAsPNG:function(a,b,e,g){if(!f)return!1;var h=n(a,e,g),i="image/png",j=h.toDataURL(i);return b?m(j):(k(d?j.replace(i,c):j),!0)},saveAsJPEG:function(a,b,e,g){if(!f)return!1;var h=n(a,e,g),i="image/jpeg",j=h.toDataURL(i);return 5==j.indexOf(i)&&(b?m(j):(k(d?j.replace(i,c):j),!0))},saveAsBMP:function(a,b,c,d){if(!(f&&e&&g))return!1;var i=n(a,c,d),o="image/bmp",p=h(i),q=j(p);return b?m(l(q,o)):(k(l(q,o)),!0)}}}();!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(d){function e(){!a&&this.__init&&this.__init.apply(this,arguments)}var f=this.prototype;a=!0;var g=new this;a=!1;for(var h in d)if("_props"!==h)g[h]="function"==typeof d[h]&&"function"==typeof f[h]&&b.test(d[h])?function(a,b){return function(){var c=this._super;this._super=f[a];var d=b.apply(this,arguments);return this._super=c,d}}(h,d[h]):d[h];else{var i,j=d[h];for(var k in j)i=j[k],i.set||function(){var a=k;i.set=function(){this.warn("Property '"+a+"' is read-only, ignoring assignment")}}(),i.enumerable=!0,Object.defineProperty(g,k,i)}return g.superTypes=f.superTypes?f.superTypes.concat(f.type):[],d.type?xeogl._superTypes[d.type]=g.superTypes:d.type=f.type+"_"+c(),e.prototype=g,e.prototype.constructor=e,e.extend=arguments.callee,window[d.type]=e,e};var c=function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;e<36;e++)8===e||13===e||18===e||23===e?c[e]="-":14===e?c[e]="4":(d<=2&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19===e?3&a|8:a]);return c.join("")}}()}(),function(){"use strict";xeogl.utils=xeogl.utils||{},xeogl.utils.Map=function(a,b){this.items=a||[],b=b||0;var c=b+1;this.addItem=function(){var a;if(2===arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(;;){a=arguments[0]||{};var d=c++;if(!this.items[d])return this.items[d]=a,d}},this.removeItem=function(a){var b=this.items[a];return delete this.items[a],b}}}(),function(){"use strict";var a=new Float32Array(16),b=new Float32Array(16),c=new Float32Array(4),d=xeogl.math={MAX_DOUBLE:1e8,MIN_DOUBLE:-1e8,DEGTORAD:.0174532925,vec2:function(a){return new Float32Array(a||2)},vec3:function(a){return new Float32Array(a||3)},vec4:function(a){return new Float32Array(a||4)},mat3:function(a){return new Float32Array(a||9)},mat3ToMat4:function(a,b){},mat4:function(a){return new Float32Array(a||16)},mat4ToMat3:function(a,b){},createUUID:function(){for(var a=[],b=0;b<256;b++)a[b]=(b<16?"0":"")+b.toString(16);return function(){var b=4294967295*Math.random()|0,c=4294967295*Math.random()|0,d=4294967295*Math.random()|0,e=4294967295*Math.random()|0;return a[255&b]+a[b>>8&255]+a[b>>16&255]+a[b>>24&255]+"-"+a[255&c]+a[c>>8&255]+"-"+a[c>>16&15|64]+a[c>>24&255]+"-"+a[63&d|128]+a[d>>8&255]+"-"+a[d>>16&255]+a[d>>24&255]+a[255&e]+a[e>>8&255]+a[e>>16&255]+a[e>>24&255]}}(),clamp:function(a,b,c){return Math.max(b,Math.min(c,a))},fmod:function(a,b){if(a<b)return console.error("xeogl.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),a;for(;b<=a;)a-=b;return a},negateVec4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},addVec4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},addVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},addVec3:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},addVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},subVec4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},subVec3:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},subVec2:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},subVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},subScalarVec4:function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},mulVec4:function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},mulVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},mulVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},mulVec2Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},divVec3:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},divVec4:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},divScalarVec3:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},divVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},divVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},divScalarVec4:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},dotVec4:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},cross3Vec4:function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},cross3Vec3:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},sqLenVec4:function(a){return d.dotVec4(a,a)},lenVec4:function(a){return Math.sqrt(d.sqLenVec4(a))},dotVec3:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},dotVec2:function(a,b){return a[0]*b[0]+a[1]*b[1]},sqLenVec3:function(a){return d.dotVec3(a,a)},sqLenVec2:function(a){return d.dotVec2(a,a)},lenVec3:function(a){return Math.sqrt(d.sqLenVec3(a))},lenVec2:function(a){return Math.sqrt(d.sqLenVec2(a))},distVec2:function(){var a=new Float32Array(2);return function(b,c){return d.lenVec2(d.subVec2(b,c,a))}}(),rcpVec3:function(a,b){return d.divScalarVec3(1,a,b)},normalizeVec4:function(a,b){var c=1/d.lenVec4(a);return d.mulVec4Scalar(a,c,b)},normalizeVec3:function(a,b){var c=1/d.lenVec3(a);return d.mulVec3Scalar(a,c,b)},normalizeVec2:function(a,b){var c=1/d.lenVec2(a);return d.mulVec2Scalar(a,c,b)},angleVec3:function(a,b){var c=xeogl.math.dotVec3(a,b)/Math.sqrt(xeogl.math.sqLenVec3(a)*xeogl.math.sqLenVec3(b));return c=c<-1?-1:c>1?1:c,Math.acos(c)},vec3FromMat4Scale:function(){var a=new Float32Array(3);return function(b,c){return a[0]=b[0],a[1]=b[1],a[2]=b[2],c[0]=d.lenVec3(a),a[0]=b[4],a[1]=b[5],a[2]=b[6],c[1]=d.lenVec3(a),a[0]=b[8],a[1]=b[9],a[2]=b[10],c[2]=d.lenVec3(a),c}}(),vecToArray:function(){function a(a){return Math.round(100*a)/100}return function(b){b=Array.prototype.slice.call(b);for(var c=0,d=b.length;c<d;c++)b[c]=a(b[c]);return b}}(),dupMat4:function(a){return a.slice(0,16)},mat4To3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},m4s:function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},setMat4ToZeroes:function(){return d.m4s(0)},setMat4ToOnes:function(){return d.m4s(1)},diagonalMat4v:function(a){return new Float32Array([a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]])},diagonalMat4c:function(a,b,c,e){return d.diagonalMat4v([a,b,c,e])},diagonalMat4s:function(a){return d.diagonalMat4c(a,a,a,a)},identityMat4:function(a){return a=a||new Float32Array(16),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},isIdentityMat4:function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},negateMat4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},addMat4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},addMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},addScalarMat4:function(a,b,c){return d.addMat4Scalar(b,a,c)},subMat4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},subMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},subScalarMat4:function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c},mulMat4:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},mulMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},mulMat4v4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},transposeMat4:function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a===b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},determinantMat4:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},inverseMat4:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},traceMat4:function(a){return a[0]+a[5]+a[10]+a[15]},translationMat4v:function(a,b){var c=b||d.identityMat4();return c[12]=a[0],c[13]=a[1],c[14]=a[2],c},translationMat4c:function(){var a=new Float32Array(3);return function(b,c,e,f){return a[0]=b,a[1]=c,a[2]=e,d.translationMat4v(a,f)}}(),translationMat4s:function(a,b){return d.translationMat4c(a,a,a,b)},translateMat4v:function(a,b){return d.translateMat4c(a[0],a[1],a[2],b)},OLDtranslateMat4c:function(a,b,c,d){var e=d[12];d[0]+=e*a,d[4]+=e*b,d[8]+=e*c;var f=d[13];d[1]+=f*a,d[5]+=f*b,d[9]+=f*c;var g=d[14];d[2]+=g*a,d[6]+=g*b,d[10]+=g*c;var h=d[15];return d[3]+=h*a,d[7]+=h*b,d[11]+=h*c,d},translateMat4c:function(a,b,c,d){var e=d[3];d[0]+=e*a,d[1]+=e*b,d[2]+=e*c;var f=d[7];d[4]+=f*a,d[5]+=f*b,d[6]+=f*c;var g=d[11];d[8]+=g*a,d[9]+=g*b,d[10]+=g*c;var h=d[15];return d[12]+=h*a,d[13]+=h*b,d[14]+=h*c,d},rotationMat4v:function(a,b,c){var e,f,g,h,i,j,k=d.normalizeVec4([b[0],b[1],b[2],0],[]),l=Math.sin(a),m=Math.cos(a),n=1-m,o=k[0],p=k[1],q=k[2];return e=o*p,f=p*q,g=q*o,h=o*l,i=p*l,j=q*l,c=c||d.mat4(),c[0]=n*o*o+m,c[1]=n*e+j,c[2]=n*g-i,c[3]=0,c[4]=n*e-j,c[5]=n*p*p+m,c[6]=n*f+h,c[7]=0,c[8]=n*g+i,c[9]=n*f-h,c[10]=n*q*q+m,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c},rotationMat4c:function(a,b,c,e,f){return d.rotationMat4v(a,[b,c,e],f)},scalingMat4v:function(a,b){return b=b||d.identityMat4(),b[0]=a[0],b[5]=a[1],b[10]=a[2],b},scalingMat4c:function(){var a=new Float32Array(3);return function(b,c,e,f){return a[0]=b,a[1]=c,a[2]=e,d.scalingMat4v(a,f)}}(),scaleMat4c:function(a,b,c,d){return d[0]*=a,d[4]*=b,d[8]*=c,d[1]*=a,d[5]*=b,d[9]*=c,d[2]*=a,d[6]*=b,d[10]*=c,d[3]*=a,d[7]*=b,d[11]*=c,d},scaleMat4v:function(a,b){var c=a[0],d=a[1],e=a[2];return b[0]*=c,b[4]*=d,b[8]*=e,b[1]*=c,b[5]*=d,b[9]*=e,b[2]*=c,b[6]*=d,b[10]*=e,b[3]*=c,b[7]*=d,b[11]*=e,b},scalingMat4s:function(a){return d.scalingMat4c(a,a,a)},rotationTranslationMat4:function(a,b,c){c=c||d.mat4();var e=a[0],f=a[1],g=a[2],h=a[3],i=e+e,j=f+f,k=g+g,l=e*i,m=e*j,n=e*k,o=f*j,p=f*k,q=g*k,r=h*i,s=h*j,t=h*k;return c[0]=1-(o+q),c[1]=m+t,c[2]=n-s,c[3]=0,c[4]=m-t,c[5]=1-(l+q),c[6]=p+r,c[7]=0,c[8]=n+s,c[9]=p-r,c[10]=1-(l+o),c[11]=0,c[12]=b[0],c[13]=b[1],c[14]=b[2],c[15]=1,c},mat4ToEuler:function(a,b,c){c=c||d.vec4();var e=d.clamp,f=a[0],g=a[4],h=a[8],i=a[1],j=a[5],k=a[9],l=a[2],m=a[6],n=a[10];return"XYZ"===b?(c[1]=Math.asin(e(h,-1,1)),Math.abs(h)<.99999?(c[0]=Math.atan2(-k,n),c[2]=Math.atan2(-g,f)):(c[0]=Math.atan2(m,j),c[2]=0)):"YXZ"===b?(c[0]=Math.asin(-e(k,-1,1)),Math.abs(k)<.99999?(c[1]=Math.atan2(h,n),c[2]=Math.atan2(i,j)):(c[1]=Math.atan2(-l,f),c[2]=0)):"ZXY"===b?(c[0]=Math.asin(e(m,-1,1)),Math.abs(m)<.99999?(c[1]=Math.atan2(-l,n),c[2]=Math.atan2(-g,j)):(c[1]=0,c[2]=Math.atan2(i,f))):"ZYX"===b?(c[1]=Math.asin(-e(l,-1,1)),Math.abs(l)<.99999?(c[0]=Math.atan2(m,n),c[2]=Math.atan2(i,f)):(c[0]=0,c[2]=Math.atan2(-g,j))):"YZX"===b?(c[2]=Math.asin(e(i,-1,1)),Math.abs(i)<.99999?(c[0]=Math.atan2(-k,j),c[1]=Math.atan2(-l,f)):(c[0]=0,c[1]=Math.atan2(h,n))):"XZY"===b&&(c[2]=Math.asin(-e(g,-1,1)),Math.abs(g)<.99999?(c[0]=Math.atan2(m,j),c[1]=Math.atan2(h,f)):(c[0]=Math.atan2(-k,n),c[1]=0)),c},lookAtMat4v:function(a,b,c,e){e||(e=d.mat4());var f=a[0],g=a[1],h=a[2],i=c[0],j=c[1],k=c[2],l=b[0],m=b[1],n=b[2];if(f===l&&g===m&&h===n)return d.identityMat4();var o,p,q,r,s,t,u,v,w,x;return o=f-l,p=g-m,q=h-n,x=1/Math.sqrt(o*o+p*p+q*q),o*=x,p*=x,q*=x,r=j*q-k*p,s=k*o-i*q,t=i*p-j*o,x=Math.sqrt(r*r+s*s+t*t),x?(x=1/x,r*=x,s*=x,t*=x):(r=0,s=0,t=0),u=p*t-q*s,v=q*r-o*t,w=o*s-p*r,x=Math.sqrt(u*u+v*v+w*w),x?(x=1/x,u*=x,v*=x,w*=x):(u=0,v=0,w=0),e[0]=r,e[1]=u,e[2]=o,e[3]=0,e[4]=s,e[5]=v,e[6]=p,e[7]=0,e[8]=t,e[9]=w,e[10]=q,e[11]=0,e[12]=-(r*f+s*g+t*h),e[13]=-(u*f+v*g+w*h),e[14]=-(o*f+p*g+q*h),e[15]=1,e},lookAtMat4c:function(a,b,c,e,f,g,h,i,j){return d.lookAtMat4v([a,b,c],[e,f,g],[h,i,j],[])},orthoMat4c:function(a,b,c,e,f,g,h){h||(h=d.mat4());var i=b-a,j=e-c,k=g-f;return h[0]=2/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2/j,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=-2/k,h[11]=0,h[12]=-(a+b)/i,h[13]=-(e+c)/j,h[14]=-(g+f)/k,h[15]=1,h},frustumMat4v:function(c,e,f){f||(f=d.mat4());var g=[c[0],c[1],c[2],0],h=[e[0],e[1],e[2],0];d.addVec4(h,g,a),d.subVec4(h,g,b);var i=2*g[2],j=b[0],k=b[1],l=b[2];return f[0]=i/j,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=i/k,f[6]=0,f[7]=0,f[8]=a[0]/j,f[9]=a[1]/k,f[10]=-a[2]/l,f[11]=-1,f[12]=0,f[13]=0,f[14]=-i*h[2]/l,f[15]=0,f},frustumMat4:function(a,b,c,e,f,g,h){h||(h=d.mat4());var i=b-a,j=e-c,k=g-f;return h[0]=2*f/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2*f/j,h[6]=0,h[7]=0,h[8]=(b+a)/i,h[9]=(e+c)/j,h[10]=-(g+f)/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-g*f*2/k,h[15]=0,h},perspectiveMat4:function(a,b,c,e,f){var g=[],h=[];return g[2]=c,h[2]=e,h[1]=g[2]*Math.tan(a/2),g[1]=-h[1],h[0]=h[1]*b,g[0]=-h[0],d.frustumMat4v(g,h,f)},transformPoint3:function(a,b,c){return c=c||d.vec3(),c[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12],c[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13],c[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14],c},transformPoint4:function(a,b,c){return c=c||d.vec4(),c[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3],c[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3],c[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3],c[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3],c},transformPoints3:function(a,b,c){for(var d,e,f,g,h,i=c||[],j=b.length,k=a[0],l=a[1],m=a[2],n=a[3],o=a[4],p=a[5],q=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11],w=a[12],x=a[13],y=a[14],z=a[15],A=0;A<j;++A)g=b[A],d=g[0],e=g[1],f=g[2],h=i[A]||(i[A]=[0,0,0]),h[0]=k*d+o*e+s*f+w,h[1]=l*d+p*e+t*f+x,h[2]=m*d+q*e+u*f+y,h[3]=n*d+r*e+v*f+z;return i.length=j,i},transformPositions3:function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=3)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},transformPositions4:function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=4)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},transformVec3:function(a,b,c){var d=b[0],e=b[1],f=b[2];return c=c||this.vec3(),c[0]=a[0]*d+a[4]*e+a[8]*f,c[1]=a[1]*d+a[5]*e+a[9]*f,c[2]=a[2]*d+a[6]*e+a[10]*f,c},transformVec4:function(a,b,c){var e=b[0],f=b[1],g=b[2],h=b[3];return c=c||d.vec4(),c[0]=a[0]*e+a[4]*f+a[8]*g+a[12]*h,c[1]=a[1]*e+a[5]*f+a[9]*g+a[13]*h,c[2]=a[2]*e+a[6]*f+a[10]*g+a[14]*h,c[3]=a[3]*e+a[7]*f+a[11]*g+a[15]*h,c},rotateVec3X:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[0],f[1]=e[1]*Math.cos(c)-e[2]*Math.sin(c),f[2]=e[1]*Math.sin(c)+e[2]*Math.cos(c),d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},rotateVec3Y:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[2]*Math.sin(c)+e[0]*Math.cos(c),f[1]=e[1],f[2]=e[2]*Math.cos(c)-e[0]*Math.sin(c),d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},rotateVec3Z:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[0]*Math.cos(c)-e[1]*Math.sin(c),f[1]=e[0]*Math.sin(c)+e[1]*Math.cos(c),f[2]=e[2],d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},projectVec4:function(a,b){var c=1/a[3];return b=b||d.vec2(),b[0]=v[0]*c,b[1]=v[1]*c,b},lerpVec3:function(a,b,c,e,f,g){var h=g||d.vec3(),i=(a-b)/(c-b);return h[0]=e[0]+i*(f[0]-e[0]),h[1]=e[1]+i*(f[1]-e[1]),h[2]=e[2]+i*(f[2]-e[2]),h},flatten:function(a){var b,c,d,e,f,g=[];for(b=0,c=a.length;b<c;b++)for(f=a[b],d=0,e=f.length;d<e;d++)g.push(f[d]);return g},identityQuaternion:function(a){return a=a||d.vec4(),a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},eulerToQuaternion:function(a,b,c){c=c||d.vec4();var e=a[0]*d.DEGTORAD/2,f=a[1]*d.DEGTORAD/2,g=a[2]*d.DEGTORAD/2,h=Math.cos(e),i=Math.cos(f),j=Math.cos(g),k=Math.sin(e),l=Math.sin(f),m=Math.sin(g);return"XYZ"===b?(c[0]=k*i*j+h*l*m,c[1]=h*l*j-k*i*m,c[2]=h*i*m+k*l*j,c[3]=h*i*j-k*l*m):"YXZ"===b?(c[0]=k*i*j+h*l*m,c[1]=h*l*j-k*i*m,c[2]=h*i*m-k*l*j,c[3]=h*i*j+k*l*m):"ZXY"===b?(c[0]=k*i*j-h*l*m,c[1]=h*l*j+k*i*m,c[2]=h*i*m+k*l*j,c[3]=h*i*j-k*l*m):"ZYX"===b?(c[0]=k*i*j-h*l*m,c[1]=h*l*j+k*i*m,c[2]=h*i*m-k*l*j,c[3]=h*i*j+k*l*m):"YZX"===b?(c[0]=k*i*j+h*l*m,c[1]=h*l*j+k*i*m,c[2]=h*i*m-k*l*j,c[3]=h*i*j-k*l*m):"XZY"===b&&(c[0]=k*i*j-h*l*m,c[1]=h*l*j-k*i*m,c[2]=h*i*m+k*l*j,c[3]=h*i*j+k*l*m),c},mat4ToQuaternion:function(a,b){b=b||d.vec4();var c,e=a[0],f=a[4],g=a[8],h=a[1],i=a[5],j=a[9],k=a[2],l=a[6],m=a[10],n=e+i+m;return n>0?(c=.5/Math.sqrt(n+1),b[3]=.25/c,b[0]=(l-j)*c,b[1]=(g-k)*c,b[2]=(h-f)*c):e>i&&e>m?(c=2*Math.sqrt(1+e-i-m),b[3]=(l-j)/c,b[0]=.25*c,b[1]=(f+h)/c,b[2]=(g+k)/c):i>m?(c=2*Math.sqrt(1+i-e-m),b[3]=(g-k)/c,b[0]=(f+h)/c,b[1]=.25*c,b[2]=(j+l)/c):(c=2*Math.sqrt(1+m-e-i),b[3]=(h-f)/c,b[0]=(g+k)/c,b[1]=(j+l)/c,b[2]=.25*c),b},vec3PairToQuaternion:function(a,b,c){c=c||d.vec4();var e=Math.sqrt(d.dotVec3(a,a)*d.dotVec3(b,b)),f=e+d.dotVec3(a,b);return f<1e-8*e?(f=0,Math.abs(a[0])>Math.abs(a[2])?(c[0]=-a[1],c[1]=a[0],c[2]=0):(c[0]=0,c[1]=-a[2],c[2]=a[1])):d.cross3Vec3(a,b,c),c[3]=f,d.normalizeQuaternion(c)},angleAxisToQuaternion:function(a,b){b=b||d.vec4();var c=a[3]/2,e=Math.sin(c);return b[0]=e*a[0],b[1]=e*a[1],b[2]=e*a[2],b[3]=Math.cos(c),b},quaternionToEuler:function(a,b,c){c=c||d.vec4();var e=a[3]/2,f=Math.sin(e);return c[0]=f*a[0],c[1]=f*a[1],c[2]=f*a[2],c[3]=Math.cos(e),c},mulQuaternions:function(a,b,c){c=c||d.vec4();var e=a[0],f=a[1],g=a[2],h=a[3],i=b[0],j=b[1],k=b[2],l=b[3];return c[0]=h*i+e*l+f*k-g*j,c[1]=h*j+f*l+g*i-e*k,c[2]=h*k+g*l+e*j-f*i,c[3]=h*l-e*i-f*j-g*k,c},vec3ApplyQuaternion:function(a,b,c){c=c||d.vec3();var e=b[0],f=b[1],g=b[2],h=a[0],i=a[1],j=a[2],k=a[3],l=k*e+i*g-j*f,m=k*f+j*e-h*g,n=k*g+h*f-i*e,o=-h*e-i*f-j*g;return c[0]=l*k+o*-h+m*-j-n*-i,c[1]=m*k+o*-i+n*-h-l*-j,c[2]=n*k+o*-j+l*-i-m*-h,c},quaternionToMat4:function(a,b){b=d.identityMat4(b);var c=a[0],e=a[1],f=a[2],g=a[3],h=2*c,i=2*e,j=2*f,k=h*g,l=i*g,m=j*g,n=h*c,o=i*c,p=j*c,q=i*e,r=j*e,s=j*f;return b[0]=1-(q+s),b[1]=o+m,b[2]=p-l,b[4]=o-m,b[5]=1-(n+s),b[6]=r+k,b[8]=p+l,b[9]=r-k,b[10]=1-(n+q),b},quaternionToRotationMat4:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return b[0]=1-(m+o),b[4]=k-r,b[8]=l+q,b[1]=k+r,b[5]=1-(j+o),b[9]=n-p,b[2]=l-q,b[6]=n+p,b[10]=1-(j+m),b[3]=0,b[7]=0,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},normalizeQuaternion:function(a,b){b=b||a;var c=d.lenVec4([a[0],a[1],a[2],a[3]]);return b[0]=a[0]/c,b[1]=a[1]/c,b[2]=a[2]/c,b[3]=a[3]/c,b},conjugateQuaternion:function(a,b){return b=b||a,b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=a[3],b},inverseQuaternion:function(a,b){return d.normalizeQuaternion(d.conjugateQuaternion(a,b))},quaternionToAngleAxis:function(a,b){b=b||d.vec4(),a=d.normalizeQuaternion(a,c);var e=a[3],f=2*Math.acos(e),g=Math.sqrt(1-e*e);return g<.001?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=a[0]/g,b[0]=a[1]/g,b[0]=a[2]/g),b[3]=f,b}}}(),function(){"use strict";var a=xeogl.math;a.AABB3=function(a){return new Float32Array(a||6)},a.AABB2=function(a){return new Float32Array(a||4)},a.OBB3=function(a){return new Float32Array(a||32)},a.OBB2=function(a){return new Float32Array(a||16)},a.transformOBB3=function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=4)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},a.getAABB3Diag=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e){return b[0]=e[0],b[1]=e[1],b[2]=e[2],c[0]=e[3],c[1]=e[4],c[2]=e[5],a.subVec3(c,b,d),Math.abs(a.lenVec3(d))}}(),a.getAABB3DiagPoint=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e,f){b[0]=e[0],b[1]=e[1],b[2]=e[2],c[0]=e[3],c[1]=e[4],c[2]=e[5];var g=a.subVec3(c,b,d),h=f[0]-e[0],i=e[3]-f[0],j=f[1]-e[1],k=e[4]-f[1],l=f[2]-e[2],m=e[5]-f[2];return g[0]+=h>i?h:i,g[1]+=j>k?j:k,g[2]+=l>m?l:m,Math.abs(a.lenVec3(g))}}(),a.getAABB3Center=function(b,c){var d=c||a.vec3();return d[0]=(b[0]+b[3])/2,d[1]=(b[1]+b[4])/2,d[2]=(b[2]+b[5])/2,d},a.getAABB2Center=function(b,c){var d=c||a.vec2();return d[0]=(b[2]+b[0])/2,d[1]=(b[3]+b[1])/2,d},a.collapseAABB3=function(b){return b=b||a.AABB3(),b[0]=xeogl.math.MAX_DOUBLE,b[1]=xeogl.math.MAX_DOUBLE,b[2]=xeogl.math.MAX_DOUBLE,b[3]=-xeogl.math.MAX_DOUBLE,b[4]=-xeogl.math.MAX_DOUBLE,b[5]=-xeogl.math.MAX_DOUBLE,b},a.AABB3ToOBB3=function(b,c){return c=c||a.OBB3(),c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=1,c[4]=b[3],c[5]=b[1],c[6]=b[2],c[7]=1,c[8]=b[3],c[9]=b[4],c[10]=b[2],c[11]=1,c[12]=b[0],c[13]=b[4],c[14]=b[2],c[15]=1,c[16]=b[0],c[17]=b[1],c[18]=b[5],c[19]=1,c[20]=b[3],c[21]=b[1],c[22]=b[5],c[23]=1,c[24]=b[3],c[25]=b[4],c[26]=b[5],c[27]=1,c[28]=b[0],c[29]=b[4],c[30]=b[5],c[31]=1,c},a.positions3ToAABB3=function(b,c){c=c||a.AABB3()
;for(var d,e,f,g=xeogl.math.MAX_DOUBLE,h=xeogl.math.MAX_DOUBLE,i=xeogl.math.MAX_DOUBLE,j=-xeogl.math.MAX_DOUBLE,k=-xeogl.math.MAX_DOUBLE,l=-xeogl.math.MAX_DOUBLE,m=0,n=b.length;m<n;m+=3)d=b[m+0],e=b[m+1],f=b[m+2],d<g&&(g=d),e<h&&(h=e),f<i&&(i=f),d>j&&(j=d),e>k&&(k=e),f>l&&(l=f);return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c},a.OBB3ToAABB3=function(b,c){c=c||a.AABB3();for(var d,e,f,g=xeogl.math.MAX_DOUBLE,h=xeogl.math.MAX_DOUBLE,i=xeogl.math.MAX_DOUBLE,j=-xeogl.math.MAX_DOUBLE,k=-xeogl.math.MAX_DOUBLE,l=-xeogl.math.MAX_DOUBLE,m=0,n=b.length;m<n;m+=4)d=b[m+0],e=b[m+1],f=b[m+2],d<g&&(g=d),e<h&&(h=e),f<i&&(i=f),d>j&&(j=d),e>k&&(k=e),f>l&&(l=f);return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c},a.points3ToAABB3=function(b,c){c=c||a.AABB3();for(var d,e,f,g=xeogl.math.MAX_DOUBLE,h=xeogl.math.MAX_DOUBLE,i=xeogl.math.MAX_DOUBLE,j=-xeogl.math.MAX_DOUBLE,k=-xeogl.math.MAX_DOUBLE,l=-xeogl.math.MAX_DOUBLE,m=0,n=b.length;m<n;m++)d=b[m][0],e=b[m][1],f=b[m][2],d<g&&(g=d),e<h&&(h=e),f<i&&(i=f),d>j&&(j=d),e>k&&(k=e),f>l&&(l=f);return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c},a.points3ToSphere3=function(){var b=new Float32Array(3);return function(c,d){d=d||a.vec4();var e,f=0,g=0,h=0,i=c.length;for(e=0;e<i;e++)f+=c[e][0],g+=c[e][1],h+=c[e][2];d[0]=f/i,d[1]=g/i,d[2]=h/i;var j,k=0;for(e=0;e<i;e++)(j=Math.abs(a.lenVec3(a.subVec3(c[e],d,b))))>k&&(k=j);return d[3]=k,d}}(),a.OBB3ToSphere3=function(){var b=new Float32Array(3),c=new Float32Array(3);return function(d,e){e=e||a.vec4();var f,g=0,h=0,i=0,j=d.length,k=j/4;for(f=0;f<j;f+=4)g+=d[f+0],h+=d[f+1],i+=d[f+2];e[0]=g/k,e[1]=h/k,e[2]=i/k;var l,m=0;for(f=0;f<j;f+=4)b[0]=d[f+0],b[1]=d[f+1],b[2]=d[f+2],(l=Math.abs(a.lenVec3(a.subVec3(b,e,c))))>m&&(m=l);return e[3]=m,e}}(),a.getSphere3Center=function(b,c){return c=c||a.vec3(),c[0]=b[0],c[1]=b[1],c[2]=b[2],c},a.expandAABB3=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]>b[2]&&(a[2]=b[2]),a[3]<b[3]&&(a[3]=b[3]),a[4]<b[4]&&(a[4]=b[4]),a[5]<b[5]&&(a[5]=b[5]),a},a.expandAABB3Point3=function(a,b){return a[0]<b[0]&&(a[0]=b[0]),a[1]<b[1]&&(a[1]=b[1]),a[2]<b[2]&&(a[2]=b[2]),a[3]>b[0]&&(a[3]=b[0]),a[4]>b[1]&&(a[4]=b[1]),a[5]>b[2]&&(a[5]=b[2]),a},a.collapseAABB2=function(b){return b=b||a.AABB2(),b[0]=xeogl.math.MAX_DOUBLE,b[1]=xeogl.math.MAX_DOUBLE,b[2]=-xeogl.math.MAX_DOUBLE,b[3]=-xeogl.math.MAX_DOUBLE,b},a.OBB3ToAABB2=function(b,c){c=c||a.AABB2();for(var d,e,f,g,h=xeogl.math.MAX_DOUBLE,i=xeogl.math.MAX_DOUBLE,j=-xeogl.math.MAX_DOUBLE,k=-xeogl.math.MAX_DOUBLE,l=0,m=b.length;l<m;l+=4)d=b[l+0],e=b[l+1],f=b[l+3]||1,g=1/f,d*=g,e*=g,d<h&&(h=d),e<i&&(i=e),d>j&&(j=d),e>k&&(k=e);return c[0]=h,c[1]=i,c[2]=j,c[3]=k,c},a.expandAABB2=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]<b[2]&&(a[2]=b[2]),a[3]<b[3]&&(a[3]=b[3]),a},a.expandAABB2Point2=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]<b[0]&&(a[2]=b[0]),a[3]<b[1]&&(a[3]=b[1]),a},a.AABB2ToCanvas=function(a,b,c,d){d=d||a;var e=.5*(a[0]+1),f=.5*(a[1]+1),g=.5*(a[2]+1),h=.5*(a[3]+1);return d[0]=Math.floor(e*b),d[1]=c-Math.floor(h*c),d[2]=Math.floor(g*b),d[3]=c-Math.floor(f*c),d}}(),function(){"use strict";var a=xeogl.math;a.triangleNormal=function(b,c,d,e){e=e||a.vec3();var f=c[0]-b[0],g=c[1]-b[1],h=c[2]-b[2],i=d[0]-b[0],j=d[1]-b[1],k=d[2]-b[2],l=g*k-h*j,m=h*i-f*k,n=f*j-g*i,o=Math.sqrt(l*l+m*m+n*n);return 0===o?(e[0]=0,e[1]=0,e[2]=0):(e[0]=l/o,e[1]=m/o,e[2]=n/o),e},a.rayTriangleIntersect=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3);return function(g,h,i,j,k,l){l=l||a.vec3();var m=a.subVec3(j,i,b),n=a.subVec3(k,i,c),o=a.cross3Vec3(h,n,d),p=a.dotVec3(m,o);if(p<1e-6)return null;var q=a.subVec3(g,i,e),r=a.dotVec3(q,o);if(r<0||r>p)return null;var s=a.cross3Vec3(q,m,f),t=a.dotVec3(h,s);if(t<0||r+t>p)return null;var u=a.dotVec3(n,s)/p;return l[0]=g[0]+u*h[0],l[1]=g[1]+u*h[1],l[2]=g[2]+u*h[2],l}}(),a.rayPlaneIntersect=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3);return function(f,g,h,i,j,k){k=k||a.vec3(),g=a.normalizeVec3(g,b);var l=a.subVec3(i,h,c),m=a.subVec3(j,h,d),n=a.cross3Vec3(l,m,e);a.normalizeVec3(n,n);var o=-a.dotVec3(h,n),p=-(a.dotVec3(f,n)+o)/a.dotVec3(g,n);return k[0]=f[0]+p*g[0],k[1]=f[1]+p*g[1],k[2]=f[2]+p*g[2],k}}(),a.cartesianToBarycentric=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e,f,g,h,i){var j=a.subVec3(h,f,b),k=a.subVec3(g,f,c),l=a.subVec3(e,f,d),m=a.dotVec3(j,j),n=a.dotVec3(j,k),o=a.dotVec3(j,l),p=a.dotVec3(k,k),q=a.dotVec3(k,l),r=m*p-n*n;if(0===r)return null;var s=1/r,t=(p*o-n*q)*s,u=(m*q-n*o)*s;return i[0]=1-t-u,i[1]=u,i[2]=t,i}}(),a.barycentricInsideTriangle=function(a){var b=a[1],c=a[2];return c>=0&&b>=0&&c+b<1},a.barycentricToCartesian=function(b,c,d,e,f){f=f||a.vec3();var g=b[0],h=b[1],i=b[2];return f[0]=c[0]*g+d[0]*h+e[0]*i,f[1]=c[1]*g+d[1]*h+e[1]*i,f[2]=c[2]*g+d[2]*h+e[2]*i,f}}(),function(){"use strict";var a=xeogl.math;a.buildNormals=function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3(),g=a.vec3();return function(h,i,j){var k,l,m,n,o,p=new Array(h.length/3);for(k=0,l=i.length;k<l;k+=3){m=i[k],n=i[k+1],o=i[k+2],b[0]=h[3*m],b[1]=h[3*m+1],b[2]=h[3*m+2],c[0]=h[3*n],c[1]=h[3*n+1],c[2]=h[3*n+2],d[0]=h[3*o],d[1]=h[3*o+1],d[2]=h[3*o+2],a.subVec3(c,b,e),a.subVec3(d,b,f);var q=a.vec3();a.normalizeVec3(a.cross3Vec3(e,f,g),q),p[m]||(p[m]=[]),p[n]||(p[n]=[]),p[o]||(p[o]=[]),p[m].push(q),p[n].push(q),p[o].push(q)}j=j&&j.length===h.length?j:new Float32Array(h.length);var r,s,t,u;for(k=0,l=p.length;k<l;k++){r=p[k].length,s=0,t=0,u=0;for(var v=0;v<r;v++)s+=p[k][v][0],t+=p[k][v][1],u+=p[k][v][2];j[3*k]=s/r,j[3*k+1]=t/r,j[3*k+2]=u/r}return j}}(),a.buildTangents=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3),g=new Float32Array(3),h=new Float32Array(3);return function(i,j,k){for(var l=new Float32Array(i.length),m=0;m<j.length;m+=3){var n=j[m],o=i.subarray(3*n,3*n+3),p=k.subarray(2*n,2*n+2);n=j[m+1];var q=i.subarray(3*n,3*n+3),r=k.subarray(2*n,2*n+2);n=j[m+2];for(var s,t=i.subarray(3*n,3*n+3),u=k.subarray(2*n,2*n+2),v=a.subVec3(q,o,b),w=a.subVec3(t,o,c),x=a.subVec2(r,p,d),y=a.subVec2(u,p,e),z=1/(x[0]*y[1]-x[1]*y[0]),A=a.mulVec3Scalar(a.subVec3(a.mulVec3Scalar(v,y[1],f),a.mulVec3Scalar(w,x[1],g),h),z,g),B=0;B<3;B++)s=3*j[m+B],l[s]+=A[0],l[s+1]+=A[1],l[s+2]+=A[2]}return l}}(),a.buildPickTriangles=function(a,b){for(var c,d,e,f,g,h,i,j,k=b.length,l=new Float32Array(30*k),m=new Float32Array(40*k),n=0,o=0;o<k;o+=3)d=3*o,e=4*o,j=(n>>24&255)/255,i=(n>>16&255)/255,h=(n>>8&255)/255,g=(255&n)/255,f=b[o],c=3*f,l[d]=a[c],l[d+1]=a[c+1],l[d+2]=a[c+2],m[e]=g,m[e+1]=h,m[e+2]=i,m[e+3]=j,f=b[o+1],c=3*f,l[d+3]=a[c],l[d+4]=a[c+1],l[d+5]=a[c+2],m[e+4]=g,m[e+5]=h,m[e+6]=i,m[e+7]=j,f=b[o+2],c=3*f,l[d+6]=a[c],l[d+7]=a[c+1],l[d+8]=a[c+2],m[e+8]=g,m[e+9]=h,m[e+10]=i,m[e+11]=j,n++;return{positions:l,colors:m}}}(),function(){"use strict";var a=xeogl.math;a.tangentQuadraticBezier=function(a,b,c,d){return 2*(1-a)*(c-b)+2*a*(d-c)},a.tangentQuadraticBezier=function(a,b,c,d,e){return-3*b*(1-a)*(1-a)+3*c*(1-a)*(1-a)-6*a*c*(1-a)+6*a*d*(1-a)-3*a*a*d+3*a*a*e},a.tangentSpline=function(a){return 6*a*a-6*a+(3*a*a-4*a+1)+(-6*a*a+6*a)+(3*a*a-2*a)},a.catmullRomInterpolate=function(a,b,c,d,e){var f=.5*(c-a),g=.5*(d-b),h=e*e;return(2*b-2*c+f+g)*(e*h)+(-3*b+3*c-2*f-g)*h+f*e+b},a.b2p0=function(a,b){var c=1-a;return c*c*b},a.b2p1=function(a,b){return 2*(1-a)*a*b},a.b2p2=function(a,b){return a*a*b},a.b2=function(a,b,c,d){return this.b2p0(a,b)+this.b2p1(a,c)+this.b2p2(a,d)},a.b3p0=function(a,b){var c=1-a;return c*c*c*b},a.b3p1=function(a,b){var c=1-a;return 3*c*c*a*b},a.b3p2=function(a,b){return 3*(1-a)*a*a*b},a.b3p3=function(a,b){return a*a*a*b},a.b3=function(a,b,c,d,e){return this.b3p0(a,b)+this.b3p1(a,c)+this.b3p2(a,d)+this.b3p3(a,e)}}(),function(){"use strict";var a=xeogl.math;a.canvasPosToWorldRay=function(){var b=a.mat4(),c=a.mat4(),d=a.vec4(),e=a.vec4(),f=a.vec4(),g=a.vec4();return function(h,i,j,k){var l=h.scene.canvas.canvas,m=h.view.matrix,n=h.project.matrix,o=a.mulMat4(n,m,b),p=a.inverseMat4(o,c),q=l.width,r=l.height,s=(i[0]-q/2)/(q/2),t=-(i[1]-r/2)/(r/2);d[0]=s,d[1]=t,d[2]=-1,d[3]=1,a.transformVec4(p,d,e),a.mulVec4Scalar(e,1/e[3]),f[0]=s,f[1]=t,f[2]=1,f[3]=1,a.transformVec4(p,f,g),a.mulVec4Scalar(g,1/g[3]),j[0]=g[0],j[1]=g[1],j[2]=g[2],a.subVec3(g,e,k),a.normalizeVec3(k)}}(),a.canvasPosToLocalRay=function(){var b=a.vec3(),c=a.vec3();return function(d,e,f,g,h){a.canvasPosToWorldRay(d,f,b,c),a.worldRayToLocalRay(e,b,c,g,h)}}(),a.worldRayToLocalRay=function(){var b=a.mat4(),c=a.vec4(),d=a.vec4();return function(e,f,g,h,i){var j=e.transform.leafMatrix,k=a.inverseMat4(j,b);c[0]=f[0],c[1]=f[1],c[2]=f[2],c[3]=1,a.transformVec4(k,c,d),h[0]=d[0],h[1]=d[1],h[2]=d[2],a.transformVec3(k,g,i)}}()}(),function(){"use strict";function a(e,f,g,h){var i=new Float32Array(6),j={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:i};i[0]=i[1]=i[2]=Number.POSITIVE_INFINITY,i[3]=i[4]=i[5]=Number.NEGATIVE_INFINITY;var k,l;for(k=0,l=e.length;k<l;++k)for(var m=3*e[k],n=0;n<3;++n){var o=3*f[m+n];g[o]<i[0]&&(i[0]=g[o]),g[o]>i[3]&&(i[3]=g[o]),g[o+1]<i[1]&&(i[1]=g[o+1]),g[o+1]>i[4]&&(i[4]=g[o+1]),g[o+2]<i[2]&&(i[2]=g[o+2]),g[o+2]>i[5]&&(i[5]=g[o+2])}if(e.length<c||h>b)return j.triangles=e,j.leaf=!0,j;d[0]=i[3]-i[0],d[1]=i[4]-i[1],d[2]=i[5]-i[2];var p=0;d[1]>d[p]&&(p=1),d[2]>d[p]&&(p=2),j.splitDim=p;var q=(i[p]+i[p+3])/2,r=new Array(e.length),s=0,t=new Array(e.length),u=0;for(k=0,l=e.length;k<l;++k){var m=3*e[k],v=f[m],w=f[m+1],x=f[m+2],y=3*v,z=3*w,A=3*x;g[y+p]<=q||g[z+p]<=q||g[A+p]<=q?r[s++]=e[k]:t[u++]=e[k]}return r.length=s,t.length=u,j.left=a(r,f,g,h+1),j.right=a(t,f,g,h+1),j}var b=10,c=20;xeogl.math.buildKDTree=function(b,c){for(var d=b.length/3,e=new Array(d),f=0;f<d;++f)e[f]=f;return a(e,b,c,0)};var d=new Float32Array}(),function(){"use strict";const a=12;xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Renderer=function(a,b,c,d){d=d||{},this.stats=a||{},this.gl=c,this.canvas=b,this._programFactory=new xeogl.renderer.ProgramFactory(this.stats,c),this._objectFactory=new xeogl.renderer.ObjectFactory,this._chunkFactory=new xeogl.renderer.ChunkFactory,this._shadowLightObjects={},this.transparent=!0===d.transparent,this.bindOutputFramebuffer=null,this.unbindOutputFramebuffer=null,this.objects={},this._ambient=null,this.ambientColor=xeogl.math.vec4([0,0,0,1]),this._objectList=[],this._objectListLen=0,this._objectPickList=[],this._objectPickListLen=0,this._shadowObjectLists={},this.lights=null,this.material=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.clips=null,this.geometry=null,this.viewport=null,this.outline=null,this.xray=null,this.modes=null,this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.imageDirty=!0},xeogl.renderer.Renderer.prototype.webglRestored=function(a){this.gl=a,this._programFactory.webglRestored(a),this._chunkFactory.webglRestored(),this._pickBuf&&this._pickBuf.webglRestored(a),this.imageDirty=!0},xeogl.renderer.Renderer.prototype.buildObject=function(a){var b=this.objects[a];b||(b=this._objectFactory.get(a),b.hash=""),b.material=this.material,b.geometry=this.geometry,b.viewport=this.viewport,b.lights=this.lights,b.outline=this.outline,b.xray=this.xray,b.modes=this.modes;var c=[this.geometry.hash,this.clips.hash,this.material.hash,this.lights.hash,this.modes.hash].join(";");if(c!==b.hash){b.program&&this._programFactory.put(b.program),b.program=this._programFactory.get(c,this),b.hash=c;var d=b.program;if(d){var e=d.program;if(!(e.allocated&&e.compiled&&e.validated&&e.linked))return this.objects[a]&&this.removeObject(a),{error:!0,errorLog:e.errorLog}}}return this._setChunk(b,0,"program",b.program),this._setChunk(b,1,"modes",this.modes),this._setChunk(b,2,"modelTransform",this.modelTransform),this._setChunk(b,3,"viewTransform",this.viewTransform),this._setChunk(b,4,"projTransform",this.projTransform),this._setChunk(b,5,"lights",this.lights),this._setChunk(b,6,this.material.type,this.material),this._setChunk(b,7,"clips",this.clips),this._setChunk(b,8,"viewport",this.viewport),this._setChunk(b,9,"outline",this.outline),this._setChunk(b,10,"xray",this.xray),this._setChunk(b,11,"geometry",this.geometry),this._setChunk(b,12,"draw",this.geometry,!0),this._setAmbientLights(this.lights),this.objects[a]?this.stateOrderDirty=!0:(this.objects[a]=b,this.objectListDirty=!0),b.compiled=!0,b},xeogl.renderer.Renderer.prototype._mapShadowLightObject=function(a,b){for(var c,d,e=0,f=a.length;e<f;e++)(c=a[e].shadow)&&(d=this._shadowLightObjects[c.id]||(this._shadowLightObjects[c.id]={}),d[b.id]=b)},xeogl.renderer.Renderer.prototype._setChunk=function(a,b,c,d,e){var f,g=this._chunkFactory.types[c];f="program"===c?1e8*(a.program.id+1):g.constructor.prototype.programGlobal?d.id:1e8*(a.program.id+1)+(d.id+1),e&&(f*=1e5);var h=a.chunks[b];h&&this._chunkFactory.putChunk(h),a.chunks[b]=this._chunkFactory.getChunk(f,c,a.program.program,d)},xeogl.renderer.Renderer.prototype._setAmbientLights=function(a){for(var b,c=a.lights,d=0,e=c.length;d<e;d++)b=c[d],"ambient"===b.type&&(this._ambient=b)},xeogl.renderer.Renderer.prototype.removeObject=function(a){var b=this.objects[a];if(b){for(var c=b.chunks,d=0,e=c.length;d<e;d++)this._chunkFactory.putChunk(c[d]),c[d]=null;this._programFactory.put(b.program),b.program=null,b.hash=null,this._objectFactory.put(b),delete this.objects[a],this.objectListDirty=!0}},xeogl.renderer.Renderer.prototype.render=function(a){a=a||{},this._update(),(this.imageDirty||a.force)&&(xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&this.gl.getExtension("OES_element_index_uint"),this._drawShadowMap(),this._drawObjects(a),this.stats.frame.frameCount++,this.imageDirty=!1)},xeogl.renderer.Renderer.prototype._update=function(){this.objectListDirty&&(this._buildObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this._buildShadowObjectLists(),this.stateSortDirty=!1,this.imageDirty=!0)},xeogl.renderer.Renderer.prototype._buildObjectList=function(){this._objectListLen=0;for(var a in this.objects)this.objects.hasOwnProperty(a)&&(this._objectList[this._objectListLen++]=this.objects[a]);for(var b=this._objectListLen,c=this._objectList.length;b<c;b++)this._objectList[b]=null;this._objectList.length=this._objectListLen},xeogl.renderer.Renderer.prototype._makeStateSortKeys=function(){for(var a,b=0,c=this._objectListLen;b<c;b++)a=this._objectList[b],a.program?a.sortKey=1e13*(a.modes.layer+1)+1e8*(a.program.id+1)+1e4*(a.material.id+1)+a.geometry.id:a.sortKey=-1},xeogl.renderer.Renderer.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(function(a,b){return a.sortKey-b.sortKey})},xeogl.renderer.Renderer.prototype._buildShadowObjectLists=function(){var a,b,c,d,e,f,g,h;for(this._shadowObjectLists={},a=0,b=this._objectListLen;a<b;a++)if(c=this._objectList[a],c.compiled&&c.modes.castShadow&&!c.modes.visible)for(f=c.lights.lights,d=0,e=f.length;d<e;d++)g=f[d],g.shadow&&(h=this._shadowObjectLists[g.id],h||(h=this._shadowObjectLists[g.id]={light:g,objects:[]}),h.objects.push(c))},xeogl.renderer.Renderer.prototype._drawShadowMap=function(){var a,b,c,d=this._shadowObjectLists;for(a in d)d.hasOwnProperty(a)&&(b=d[a],c=b.light,this._drawLightShadows(c,b.objects))},xeogl.renderer.Renderer.prototype._drawLightShadows=function(){function b(){for(var b=0;b<a;b++)e[b]=null}function c(a,b){for(var c,d=b.chunks,f=0,g=d.length;f<g;f++)(c=d[f])&&c.shadow&&(c.unique||e[f]!==c.id)&&(c.shadow(a),e[f]=c.id)}var d={},e=new Int32Array(a);return function(a,e){if(a.shadow){var f=a.getShadowRenderBuf();if(f){f.bind(),f.clear(),d.backfaces=!0,d.frontface=!0,d.drawElements=0,d.useProgram=0,d.shadowViewMatrix=a.getShadowViewMatrix(),d.shadowProjMatrix=a.getShadowProjMatrix();var g=this.gl;g.viewport(0,0,g.drawingBufferWidth,g.drawingBufferHeight),g.enable(g.DEPTH_TEST),g.disable(g.BLEND),g.clear(g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT);var h,i,j;for(b(),h=0,i=e.length;h<i;h++)j=e[h],j.compiled&&j.modes.visible&&c(d,j);g.finish(),f.unbind()}}}}(),xeogl.renderer.Renderer.prototype._drawObjects=function(){function b(){for(var b=0;b<a;b++)h[b]=null}function c(a,b){for(var c,d=b.chunks,e=0,f=d.length;e<f;e++)(c=d[e])&&c.draw&&(c.unique||h[e]!==c.id)&&(c.draw(a),h[e]=c.id)}function d(a,b){for(var c,d=b.chunks,e=0,f=d.length;e<f;e++)(c=d[e])&&c.outline&&(c.unique||h[e]!==c.id)&&(c.outline(a),h[e]=c.id)}var e=[],f=[],g=0,h=new Int32Array(a),i={};return function(a){var h=this.gl,j=this._ambient;if(j){var k=j.color,l=j.intensity;this.ambientColor[0]=k[0]*l,this.ambientColor[1]=k[1]*l,this.ambientColor[2]=k[2]*l}else this.ambientColor[0]=0,this.ambientColor[1]=0,this.ambientColor[2]=0;i.backfaces=!1,i.frontface=!0,i.textureUnit=0,i.ambientColor=this.ambientColor,i.drawElements=0,i.useProgram=0,i.bindTexture=0,i.bindArray=0,i.pass=a.pass,h.viewport(0,0,h.drawingBufferWidth,h.drawingBufferHeight),this.transparent?h.clearColor(0,0,0,0):h.clearColor(this.ambientColor[0],this.ambientColor[1],this.ambientColor[2],1),h.enable(h.DEPTH_TEST),h.frontFace(h.CCW),h.enable(h.CULL_FACE),h.depthMask(!0);var m,n,o,p=(new Date).getTime();this.bindOutputFramebuffer&&this.bindOutputFramebuffer(a.pass),!1!==a.clear&&h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT|h.STENCIL_BUFFER_BIT);var q=0;for(g=0,b(),m=0,n=this._objectListLen;m<n;m++)o=this._objectList[m],o.compiled&&!0!==o.modes.culled&&!1!==o.modes.visible&&(2===o.material.alphaMode||o.modes.xray?f[g++]=o:o.modes.outlined?e[q++]=o:c(i,o));if(q>0){for(h.enable(h.STENCIL_TEST),h.stencilFunc(h.ALWAYS,1,1),h.stencilOp(h.KEEP,h.KEEP,h.REPLACE),h.stencilMask(1),h.clearStencil(0),h.clear(h.STENCIL_BUFFER_BIT),b(),m=0;m<q;m++)c(i,e[m]);for(h.stencilFunc(h.EQUAL,0,1),h.stencilOp(h.KEEP,h.KEEP,h.KEEP),h.stencilMask(0),h.disable(h.CULL_FACE),b(),m=0;m<q;m++)d(i,e[m]);h.disable(h.STENCIL_TEST)}var r=!0,s=!0;if(g>0){for(h.enable(h.CULL_FACE),h.enable(h.BLEND),i.backfaces=!1,s||h.depthMask(!1),r?h.blendFunc(h.ONE,h.ONE_MINUS_SRC_ALPHA):(h.blendEquation(h.FUNC_ADD),h.blendFuncSeparate(h.SRC_ALPHA,h.ONE_MINUS_SRC_ALPHA,h.ONE,h.ONE_MINUS_SRC_ALPHA)),q=0,b(),m=0;m<g;m++)o=f[m],o.modes.outlined?e[q++]=o:c(i,o);h.disable(h.BLEND)}var t=Date.now(),u=this.stats.frame;u.renderTime=(t-p)/1e3,u.drawElements=i.drawElements,u.useProgram=i.useProgram,u.bindTexture=i.bindTexture,u.bindArray=i.bindArray;for(var v=xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,w=0;w<v;w++)h.activeTexture(h.TEXTURE0+w),h.bindTexture(h.TEXTURE_CUBE_MAP,null),h.bindTexture(h.TEXTURE_2D,null);this.unbindOutputFramebuffer&&this.unbindOutputFramebuffer(a.pass)}}(),xeogl.renderer.Renderer.prototype.pick=function(){var a=xeogl.math,b=a.vec3(),c=a.mat4(),d=a.vec3([0,1,0]),e=a.frustumMat4(-1,1,-1,1,.1,1e4);return function(f){var g=null;this._update(),xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&this.gl.getExtension("OES_element_index_uint");var h=this._pickBuf||(this._pickBuf=new xeogl.renderer.webgl.RenderBuffer(this.canvas,this.gl));h.bind(),h.clear();var i,j,k,l,m,n=null,o=null;f.canvasPos?f.canvasPos?(i=f.canvasPos[0],j=f.canvasPos[1]):(i=.5*this.canvas.clientWidth,j=.5*this.canvas.clientHeight):(k=f.origin||a.vec3([0,0,0]),l=f.direction||a.vec3([0,0,1]),m=a.addVec3(k,l,b),n=a.lookAtMat4v(k,m,d,c),o=e,i=.5*this.canvas.clientWidth,j=.5*this.canvas.clientHeight),this._pickObjectPass(n,o);var p=h.read(i,j),q=p[0]+256*p[1]+65536*p[2];q=q>=1?q-1:-1;var r=this._objectPickList[q];if(r&&(g={entity:r.id},f.pickSurface)){h.clear(),this._pickPrimitivePass(r,n,o),this.gl.finish(),p=h.read(i,j);var s=p[0]+256*p[1]+256*p[2]*256+256*p[3]*256*256;s*=3,g.primIndex=s,n&&(g.origin=k,g.direction=l)}return h.unbind(),g}}(),xeogl.renderer.Renderer.prototype._pickObjectPass=function(){function b(){for(var b=0;b<a;b++)e[b]=null}function c(a,b){for(var c,d=b.chunks,f=0,g=d.length;f<g;f++)(c=d[f])&&c.pickObject&&(c.unique||e[f]!==c.id)&&(c.pickObject(a),e[f]=c.id)}var d={},e=new Int32Array(a);return function(a,e){d.backfaces=!0,d.frontface=!0,d.pickViewMatrix=a,d.pickProjMatrix=e,d.pickObjectIndex=0;var f=this.gl;f.viewport(0,0,f.drawingBufferWidth,f.drawingBufferHeight),f.clearColor(0,0,0,0),f.enable(f.DEPTH_TEST),f.disable(f.CULL_FACE),f.disable(f.BLEND),f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT),b(),this._objectPickListLen=0;var g,h,i;for(g=0,h=this._objectListLen;g<h;g++)i=this._objectList[g],i.compiled&&!0!==i.modes.culled&&!1!==i.modes.visible&&!1!==i.modes.pickable&&(this._objectPickList[this._objectPickListLen++]=i,c(d,i))}}(),xeogl.renderer.Renderer.prototype._pickPrimitivePass=function(){var a={};return function(b,c,d){a.backfaces=!0,a.frontface=!0,a.pickViewMatrix=c,a.pickProjMatrix=d;var e=this.gl;e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.clearColor(0,0,0,0),e.enable(e.DEPTH_TEST),e.disable(e.CULL_FACE),e.disable(e.BLEND),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var f,g,h,i;for(h=b.chunks,f=0,g=h.length;f<g;f++)i=h[f],i.pickPrimitive&&i.pickPrimitive(a)}}(),xeogl.renderer.Renderer.prototype.readPixels=function(a,b,c,d){var e=this._readPixelBuf||(this._readPixelBuf=new xeogl.renderer.webgl.RenderBuffer(this.canvas,this.gl));e.bind(),e.clear(),this.render({force:!0,opaqueOnly:d});var f,g,h,i;for(g=0;g<c;g++)h=2*g,i=4*g,f=e.read(a[h],a[h+1]),b[i]=f[0],b[i+1]=f[1],b[i+2]=f[2],b[i+3]=f[3];e.unbind(),this.imageDirty=!0},xeogl.renderer.Renderer.prototype.destroy=function(){this._programFactory.destroy(),this._pickBuf&&this._pickBuf.destroy(),this._readPixelBuf&&this._readPixelBuf.destroy()}}(),function(){"use strict";xeogl.renderer.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}}}(),function(){"use strict";xeogl.renderer.webgl.ArrayBuffer=function(a,b,c,d,e,f){switch(this.allocated=!1,this.gl=a,this.type=b,c.constructor){case Uint8Array:this.itemType=a.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=a.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=a.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=a.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=a.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=a.INT,this.itemByteSize=4;break;default:this.itemType=a.FLOAT,this.itemByteSize=4}this.usage=f,this.length=0,this.numItems=0,this.itemSize=e,this._allocate(c)},xeogl.renderer.webgl.ArrayBuffer.prototype._allocate=function(a){if(this.allocated=!1,this._handle=this.gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this.gl.bindBuffer(this.type,this._handle),this.gl.bufferData(this.type,a,this.usage),this.gl.bindBuffer(this.type,null),this.length=a.length,this.numItems=this.length/this.itemSize,this.allocated=!0)},xeogl.renderer.webgl.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):(this.gl.bindBuffer(this.type,this._handle),b||0===b?this.gl.bufferSubData(this.type,b*this.itemByteSize,a):this.gl.bufferData(this.type,a,this.usage),this.gl.bindBuffer(this.type,null)))},xeogl.renderer.webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this._handle)},xeogl.renderer.webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},xeogl.renderer.webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}(),function(){"use strict";xeogl.renderer.webgl.Attribute=function(a,b){this.gl=a,this.location=b},xeogl.renderer.webgl.Attribute.prototype.bindFloatArrayBuffer=function(a){a&&(a.bind(),this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a.itemSize,this.gl.FLOAT,!1,0,0))},xeogl.renderer.webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(a,b,c){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a,this.gl.FLOAT,!1,b,c)}}(),function(){"use strict";function a(a){for(var b,c,d=[],e=0,f=a.length;e<f;e++)b=a[e],c=b.indexOf("/"),c>0&&"/"===b.charAt(c+1)&&(b=b.substring(0,c)),d.push(b);return d.join("\n")}xeogl.renderer.webgl.Program=function(b,c,d,e){if(this.stats=b,this.gl=c,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new xeogl.renderer.webgl.Shader(c,c.VERTEX_SHADER,a(d)),this._fragmentShader=new xeogl.renderer.webgl.Shader(c,c.FRAGMENT_SHADER,a(e)),!this._vertexShader.allocated)return void(this.errorLog=["Vertex shader failed to allocate"].concat(this._vertexShader.errorLog));if(!this._fragmentShader.allocated)return void(this.errorLog=["Fragment shader failed to allocate"].concat(this._fragmentShader.errorLog));if(this.allocated=!0,!this._vertexShader.compiled)return void(this.errorLog=["Vertex shader failed to compile"].concat(this._vertexShader.errorLog));if(!this._fragmentShader.compiled)return void(this.errorLog=["Fragment shader failed to compile"].concat(this._fragmentShader.errorLog));this.compiled=!0;var f,g,h,i,j;if(this.handle=c.createProgram(),!this.handle)return void(this.errorLog=["Failed to allocate program"]);if(c.attachShader(this.handle,this._vertexShader.handle),c.attachShader(this.handle,this._fragmentShader.handle),c.linkProgram(this.handle),this.linked=c.getProgramParameter(this.handle,c.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errorLog=[],this.errorLog.push(""),this.errorLog.push(c.getProgramInfoLog(this.handle)),this.errorLog.push("\nVertex shader:\n"),this.errorLog=this.errorLog.concat(d),this.errorLog.push("\nFragment shader:\n"),void(this.errorLog=this.errorLog.concat(e));var k=c.getProgramParameter(this.handle,c.ACTIVE_UNIFORMS);for(g=0;g<k;++g)(h=c.getActiveUniform(this.handle,g))&&(i=h.name,"\0"===i[i.length-1]&&(i=i.substr(0,i.length-1)),j=c.getUniformLocation(this.handle,i),h.type===c.SAMPLER_2D||h.type===c.SAMPLER_CUBE||35682===h.type?this.samplers[i]=new xeogl.renderer.webgl.Sampler(c,j):this.uniforms[i]=new xeogl.renderer.webgl.Uniform(b.frame,c,h.type,j));var l=c.getProgramParameter(this.handle,c.ACTIVE_ATTRIBUTES);for(g=0;g<l;g++)(f=c.getActiveAttrib(this.handle,g))&&(j=c.getAttribLocation(this.handle,f.name),this.attributes[f.name]=new xeogl.renderer.webgl.Attribute(c,j));this.allocated=!0},xeogl.renderer.webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},xeogl.renderer.webgl.Program.prototype.setUniform=function(a,b){if(this.allocated){var c=this.uniforms[a];c&&c.setValue(b)}},xeogl.renderer.webgl.Program.prototype.getUniform=function(a){if(this.allocated)return this.uniforms[a]},xeogl.renderer.webgl.Program.prototype.getAttribute=function(a){if(this.allocated)return this.attributes[a]},xeogl.renderer.webgl.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this.samplers[a];return!!d&&d.bindTexture(b,c)},xeogl.renderer.webgl.Program.prototype.destroy=function(){this.allocated&&(this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}(),function(){"use strict";xeogl.renderer.webgl.RenderBuffer=function(a,b,c){c=c||{},this.allocated=!1,this.canvas=a,this.gl=b,this.buffer=null,this.bound=!1,this.size=c.size},xeogl.renderer.webgl.RenderBuffer.prototype.setSize=function(a){this.size=a},xeogl.renderer.webgl.RenderBuffer.prototype.webglRestored=function(a){this.gl=a,this.buffer=null,this.allocated=!1,this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0)},xeogl.renderer.webgl.RenderBuffer.prototype._touch=function(){var a,b;if(this.size?(a=this.size[0],b=this.size[1]):(a=this.canvas.clientWidth,b=this.canvas.clientHeight),this.buffer){if(this.buffer.width===a&&this.buffer.height===b)return;this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf)}this.buffer={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:a,height:b},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buffer.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(e){var c=new WebGLUnsignedByteArray(a*b*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,c)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buffer.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),!this.gl.isFramebuffer(this.buffer.framebuf))throw"Invalid framebuffer";this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);var d=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(d){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case this.gl.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+d}this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},
xeogl.renderer.webgl.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.height-b,e=new Uint8Array(4);return this.gl.readPixels(c,d,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),e},xeogl.renderer.webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},xeogl.renderer.webgl.RenderBuffer.prototype.getTexture=function(){var a=this;return{renderBuffer:this,bind:function(b){return!(!a.buffer||!a.buffer.texture)&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buffer.texture),!0)},unbind:function(b){a.buffer&&a.buffer.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},xeogl.renderer.webgl.RenderBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1)}}(),function(){"use strict";xeogl.renderer.webgl.Sampler=function(a,b){this.bindTexture=function(c,d){return!!c.bind(d)&&(a.uniform1i(b,d),!0)}}}(),function(){"use strict";xeogl.renderer.webgl.Shader=function(a,b,c){if(this.allocated=!1,this.compiled=!1,this.errorLog=null,this.source=c,this.handle=a.createShader(b),!this.handle)return void(this.errorLog=["Failed to allocate"]);if(this.allocated=!0,a.shaderSource(this.handle,c),a.compileShader(this.handle),this.compiled=a.getShaderParameter(this.handle,a.COMPILE_STATUS),!this.compiled&&!a.isContextLost()){for(var d=this.source.split("\n"),e=[],f=0;f<d.length;f++)e.push(f+1+": "+d[f]+"\n");this.errorLog=[],this.errorLog.push(""),this.errorLog.push(a.getShaderInfoLog(this.handle)),this.errorLog=this.errorLog.concat(e.join(""))}}}(),function(){"use strict";xeogl.renderer.webgl.Texture2D=function(a,b){this.gl=a,this.target=b||a.TEXTURE_2D,this.texture=a.createTexture(),this.allocated=!0},xeogl.renderer.webgl.Texture2D.prototype.setPreloadColor=function(){var a=new Uint8Array([0,0,0,1]);return function(b){b?(a[0]=Math.floor(255*b[0]),a[1]=Math.floor(255*b[1]),a[2]=Math.floor(255*b[2]),a[3]=Math.floor(255*(void 0!==b[3]?b[3]:1))):(a[0]=0,a[1]=0,a[2]=0,a[3]=255);var c=this.gl;if(c.bindTexture(this.target,this.texture),c.texParameteri(this.target,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(this.target,c.TEXTURE_MIN_FILTER,c.NEAREST),this.target===c.TEXTURE_CUBE_MAP)for(var d=[c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y,c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z],e=0,f=d.length;e<f;e++)c.texImage2D(d[e],0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,a);else c.texImage2D(this.target,0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,a);c.bindTexture(this.target,null)}}(),xeogl.renderer.webgl.Texture2D.prototype.setTarget=function(a){this.target=a||this.gl.TEXTURE_2D},xeogl.renderer.webgl.Texture2D.prototype.setImage=function(a,b){var c=this.gl;if(c.bindTexture(this.target,this.texture),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,b.flipY),this.target===c.TEXTURE_CUBE_MAP){if(xeogl._isArray(a))for(var d=a,e=[c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y,c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z],f=0,g=e.length;f<g;f++)c.texImage2D(e[f],0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,d[f])}else c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a);c.bindTexture(this.target,null)},xeogl.renderer.webgl.Texture2D.prototype.setProps=function(a){var b=this.gl;if(b.bindTexture(this.target,this.texture),a.minFilter){var c=this._getGLEnum(a.minFilter);c&&(b.texParameteri(this.target,b.TEXTURE_MIN_FILTER,c),c!==b.NEAREST_MIPMAP_NEAREST&&c!==b.LINEAR_MIPMAP_NEAREST&&c!==b.NEAREST_MIPMAP_LINEAR&&c!==b.LINEAR_MIPMAP_LINEAR||b.generateMipmap(this.target))}if(a.magFilter){var d=this._getGLEnum(a.magFilter);d&&b.texParameteri(this.target,b.TEXTURE_MAG_FILTER,d)}if(a.wrapS){var e=this._getGLEnum(a.wrapS);e&&b.texParameteri(this.target,b.TEXTURE_WRAP_S,e)}if(a.wrapT){var f=this._getGLEnum(a.wrapT);f&&b.texParameteri(this.target,b.TEXTURE_WRAP_T,f)}b.bindTexture(this.target,null)},xeogl.renderer.webgl.Texture2D.prototype._getGLEnum=function(a,b){if(void 0===a)return b;var c=xeogl.renderer.webgl.enums[a];return void 0===c?b:this.gl[c]},xeogl.renderer.webgl.Texture2D.prototype.bind=function(a){if(this.allocated){if(this.texture){var b=this.gl;return b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,this.texture),!0}return!1}},xeogl.renderer.webgl.Texture2D.prototype.unbind=function(a){if(this.allocated&&this.texture){var b=this.gl;b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,null)}},xeogl.renderer.webgl.Texture2D.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)},xeogl.renderer.webgl.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=xeogl.renderer.webgl.nextHighestPowerOfTwo(e),g.height=xeogl.renderer.webgl.nextHighestPowerOfTwo(f);g.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},xeogl.renderer.webgl.ensureImageSizePowerOfTwo=function(a){if(!xeogl.renderer.webgl.isPowerOfTwo(a.width)||!xeogl.renderer.webgl.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=xeogl.renderer.webgl.nextHighestPowerOfTwo(a.width),b.height=xeogl.renderer.webgl.nextHighestPowerOfTwo(a.height);b.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},xeogl.renderer.webgl.isPowerOfTwo=function(a){return 0==(a&a-1)},xeogl.renderer.webgl.nextHighestPowerOfTwo=function(a){--a;for(var b=1;b<32;b<<=1)a|=a>>b;return a+1}}(),function(){"use strict";xeogl.renderer.webgl.Uniform=function(a,b,c,d){var e=null,f=null;if(c===b.BOOL)e=function(a){f!==a&&(f=a,b.uniform1i(d,a))};else if(c===b.BOOL_VEC2)f=new Array(2),e=function(a){f[0]===a[0]&&f[1]===a[1]||(f[0]=a[0],f[1]=a[1],b.uniform2iv(d,a))};else if(c===b.BOOL_VEC3)f=new Array(3),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]||(f[0]=a[0],f[1]=a[1],f[2]=a[2],b.uniform3iv(d,a))};else if(c===b.BOOL_VEC4)f=new Array(4),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]||(f[0]=a[0],f[1]=a[1],f[2]=a[2],f[3]=a[3],b.uniform4iv(d,a))};else if(c===b.INT)e=function(a){f!==a&&(f=a,b.uniform1iv(d,a))};else if(c===b.INT_VEC2)f=new Uint32Array(2),e=function(a){f[0]===a[0]&&f[1]===a[1]||(f.set(a),b.uniform2iv(d,a))};else if(c===b.INT_VEC3)f=new Uint32Array(3),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]||(f.set(a),b.uniform3iv(d,a))};else if(c===b.INT_VEC4)f=new Uint32Array(4),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]||(f.set(a),b.uniform4iv(d,a))};else if(c===b.FLOAT)e=function(a){f!==a&&(f=a,b.uniform1f(d,a))};else if(c===b.FLOAT_VEC2)f=new Float32Array(2),e=function(a){f[0]===a[0]&&f[1]===a[1]||(f.set(a),b.uniform2fv(d,a))};else if(c===b.FLOAT_VEC3)f=new Float32Array(3),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]||(f.set(a),b.uniform3fv(d,a))};else if(c===b.FLOAT_VEC4)f=new Float32Array(4),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]||(f.set(a),b.uniform4fv(d,a))};else if(c===b.FLOAT_MAT2)f=new Float32Array(4),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]||(f.set(a),b.uniformMatrix2fv(d,b.FALSE,a))};else if(c===b.FLOAT_MAT3)f=new Float32Array(9),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]&&f[4]===a[4]&&f[5]===a[5]&&f[6]===a[6]&&f[7]===a[7]&&f[8]===a[8]||(f.set(a),b.uniformMatrix3fv(d,b.FALSE,a))};else{if(c!==b.FLOAT_MAT4)throw"Unsupported shader uniform type: "+c;f=new Float32Array(16),e=function(a){f[0]===a[0]&&f[1]===a[1]&&f[2]===a[2]&&f[3]===a[3]&&f[4]===a[4]&&f[5]===a[5]&&f[6]===a[6]&&f[7]===a[7]&&f[8]===a[8]&&f[9]===a[9]&&f[10]===a[10]&&f[11]===a[11]&&f[12]===a[12]&&f[13]===a[13]&&f[14]===a[14]&&f[15]===a[15]||(f.set(a),b.uniformMatrix4fv(d,b.FALSE,a))}}this.setValue=e,this.getLocation=function(){return d}}}(),function(){"use strict";xeogl.renderer=xeogl.renderer||{},xeogl.renderer.State=Class.extend({__init:function(a){this.id=this._ids.addItem({}),this.hash=a.hash||""+this.id;for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])},destroy:function(){this._ids.removeItem(this.id)}}),xeogl.renderer.Visibility=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Cull=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Modes=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Layer=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Lights=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.PhongMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.SpecularMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.MetallicMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Transform=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Billboard=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Clips=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.MorphTargets=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Texture=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.CubeTexture=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Fresnel=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Geometry=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ProgramState=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Viewport=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Outline=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.XRay=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})})}(),function(){"use strict";xeogl.renderer.Object=function(a){this.id=a,this.hash=null,this.sortKey=null,this.chunks=[],this.program=null,this.stage=null,this.modes=null,this.layer=null,this.material=null,this.compiled=!1}}(),function(){"use strict";xeogl.renderer.ObjectFactory=function(){var a=[],b=0;this.get=function(c){var d;return b>0?(d=a[--b],d.id=c,d.compiled=!1,d):new xeogl.renderer.Object(c)},this.put=function(c){a[b++]=c}}}(),function(){"use strict";xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Program=function(a,b,c,d){this.stats=a,this.hash=c.hash,this.source=c,this.gl=d,this.draw=null,this.pickObject=null,this.pickPrimitive=null,this.outline=null,this.useCount=0,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.build(d)},xeogl.renderer.Program.prototype.build=function(a){return this.gl=a,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.draw=new xeogl.renderer.webgl.Program(this.stats,a,this.source.vertexDraw,this.source.fragmentDraw),this.shadow=new xeogl.renderer.webgl.Program(this.stats,a,this.source.vertexShadow,this.source.fragmentShadow),this.pickObject=new xeogl.renderer.webgl.Program(this.stats,a,this.source.vertexPickObject,this.source.fragmentPickObject),this.pickPrimitive=new xeogl.renderer.webgl.Program(this.stats,a,this.source.vertexPickPrimitive,this.source.fragmentPickPrimitive),this.outline=new xeogl.renderer.webgl.Program(this.stats,a,this.source.vertexOutline,this.source.fragmentOutline),this.draw.allocated?this.shadow.allocated?this.pickObject.allocated?this.pickPrimitive.allocated?this.outline.allocated?(this.allocated=!0,this.draw.compiled?this.shadow.compiled?this.pickObject.compiled?this.pickPrimitive.compiled?this.outline.compiled?(this.compiled=!0,this.draw.linked?this.shadow.linked?this.pickObject.linked?this.pickPrimitive.linked?this.outline.linked?(this.linked=!0,this.draw.validated?this.shadow.validated?this.pickObject.validated?this.pickPrimitive.validated?this.outline.validated?void(this.validated=!0):void(this.errorLog=["Outline effect program failed to validate"].concat(this.outline.errorLog)):void(this.errorLog=["Primitive-picking program failed to validate"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to validate"].concat(this.pickObject.errorLog)):void(this.errorLog=["Shadow program failed to validate"].concat(this.shadow.errorLog)):void(this.errorLog=["Draw program failed to validate"].concat(this.draw.errorLog))):void(this.errorLog=["Outline effect program failed to link"].concat(this.outline.errorLog)):void(this.errorLog=["Primitive-picking program failed to link"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to link"].concat(this.pickObject.errorLog)):void(this.errorLog=["Shadow program failed to link"].concat(this.shadow.errorLog)):void(this.errorLog=["Draw program failed to link"].concat(this.draw.errorLog))):void(this.errorLog=["Outline effect program failed to compile"].concat(this.outline.errorLog)):void(this.errorLog=["Primitive-picking program failed to compile"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to compile"].concat(this.pickObject.errorLog)):void(this.errorLog=["Shadow program failed to compile"].concat(this.shadow.errorLog)):void(this.errorLog=["Draw program failed to compile"].concat(this.draw.errorLog))):void(this.errorLog=["Outline effect program failed to allocate"].concat(this.outline.errorLog)):void(this.errorLog=["Primitive-picking program failed to allocate"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to allocate"].concat(this.pickObject.errorLog)):void(this.errorLog=["Shadow program failed to allocate"].concat(this.shadow.errorLog)):void(this.errorLog=["Draw program failed to allocate"].concat(this.draw.errorLog))},xeogl.renderer.Program.prototype.destroy=function(){this.draw&&this.draw.destroy(),this.shadow&&this.shadow.destroy(),this.pickObject&&this.pickObject.destroy(),this.pickPrimitive&&this.pickPrimitive.destroy(),this.outline&&this.outline.destroy()}}(),function(){"use strict";xeogl.renderer.ProgramFactory=function(a,b){this.stats=a,this._gl=b,this._programStates={}},xeogl.renderer.ProgramFactory.prototype.get=function(a,b){var c=this._programStates[a];if(!c){var d=xeogl.renderer.ProgramSourceFactory.getSource(a,b),e=new xeogl.renderer.Program(this.stats,a,d,this._gl);c=new xeogl.renderer.ProgramState({program:e,useCount:0}),this._programStates[a]=c,this.stats.memory.programs++}return c.useCount++,c},xeogl.renderer.ProgramFactory.prototype.put=function(a){if(--a.useCount<=0){var b=a.program;xeogl.renderer.ProgramSourceFactory.putSource(b.hash),delete this._programStates[b.hash],b.destroy(),this.stats.memory.programs--}},xeogl.renderer.ProgramFactory.prototype.webglRestored=function(a){this._gl=a;for(var b in this._programStates)this._programStates.hasOwnProperty(b)&&this._programStates[b].build(a)},xeogl.renderer.ProgramFactory.prototype.destroy=function(){}}(),function(){"use strict";xeogl.renderer.ProgramSource=function(a,b,c,d,e,f,g,h,i,j,k){this.hash=a,this.vertexPickObject=b,this.fragmentPickObject=c,this.vertexPickPrimitive=d,this.fragmentPickPrimitive=e,this.vertexDraw=f,this.fragmentDraw=g,this.vertexShadow=h,this.fragmentShadow=i,this.vertexOutline=j,this.fragmentOutline=k,this.useCount=0}}(),function(){"use strict";xeogl.renderer.ProgramSourceFactory=new function(){function a(){if(!t.modes.receiveShadow)return!1;var a=t.lights.lights;if(!a)return!1;for(var b=0,c=a.length;b<c;b++)if(a[b].shadow)return!0;return!1}function b(){if(!t.geometry.uv)return!1;var a=t.material;return a.ambientMap||a.occlusionMap||a.baseColorMap||a.diffuseMap||a.alphaMap||a.specularMap||a.glossinessMap||a.specularGlossinessMap||a.emissiveMap||a.metallicMap||a.roughnessMap||a.metallicRoughnessMap||a.reflectivityMap||t.material.normalMap}function c(){return!1}function d(){var a=t.geometry.primitiveName;return!(!t.geometry.autoNormals&&!t.geometry.normals||"triangles"!==a&&"triangle-strip"!==a&&"triangle-fan"!==a)}function e(){var a=t.geometry;return a.positions&&a.indices&&a.normals&&a.uv&&t.material.normalMap}function f(){return p(),q("// Object picking vertex shader"),q("attribute vec3 position;"),q("uniform mat4 modelMatrix;"),q("uniform mat4 viewMatrix;"),q("uniform mat4 viewNormalMatrix;"),q("uniform mat4 projMatrix;"),q("varying vec4 vViewPosition;"),H&&q("varying vec4 vWorldPosition;"),q("void main(void) {"),q("   vec4 tmpVertex = vec4(position, 1.0); "),q("   vec4 worldPosition = modelMatrix * tmpVertex;"),q("   vViewPosition = viewMatrix * worldPosition;"),H&&q("   vWorldPosition = worldPosition;"),q("   gl_Position = projMatrix * vViewPosition;"),q("}"),r()}function g(){if(p(),q("// Object picking fragment shader"),q("precision "+s(t.gl)+" float;"),q("uniform vec4 pickColor;"),H){q("uniform bool clippable;"),q("varying vec4 vWorldPosition;");for(var a=0;a<t.clips.clips.length;a++)q("uniform bool clipActive"+a+";"),q("uniform vec3 clipPos"+a+";"),q("uniform vec3 clipDir"+a+";")}if(q("void main(void) {"),H){q("if (clippable) {"),q("  float dist = 0.0;");for(var a=0;a<t.clips.clips.length;a++)q("if (clipActive"+a+") {"),q("   dist += clamp(dot(-clipDir"+a+".xyz, vWorldPosition.xyz - clipPos"+a+".xyz), 0.0, 1000.0);"),q("}");q("  if (dist > 0.0) { discard; }"),q("}")}return q("   gl_FragColor = pickColor; "),q("}"),r()}function h(){return p(),q("// Triangle picking vertex shader"),q("attribute vec3 position;"),q("attribute vec4 color;"),q("uniform vec3 pickColor;"),q("uniform mat4 modelMatrix;"),q("uniform mat4 viewMatrix;"),q("uniform mat4 projMatrix;"),q("varying vec4 vViewPosition;"),q("varying vec4 vColor;"),H&&q("varying vec4 vWorldPosition;"),q("void main(void) {"),q("   vec4 tmpVertex = vec4(position, 1.0); "),q("   vec4 worldPosition = modelMatrix * tmpVertex; "),q("   vec4 viewPosition = viewMatrix * worldPosition;"),H&&q("   vWorldPosition = worldPosition;"),q("   vColor = color;"),q("   gl_Position = projMatrix * viewPosition;"),q("}"),r()}function i(){if(p(),q("// Triangle picking fragment shader"),q("precision "+s(t.gl)+" float;"),q("varying vec4 vColor;"),H){q("uniform bool clippable;"),q("varying vec4 vWorldPosition;");for(var a=0;a<t.clips.clips.length;a++)q("uniform bool clipActive"+a+";"),q("uniform vec3 clipPos"+a+";"),q("uniform vec3 clipDir"+a+";")}if(q("void main(void) {"),H){q("if (clippable) {"),q("  float dist = 0.0;");for(var a=0;a<t.clips.clips.length;a++)q("if (clipActive"+a+") {"),q("   dist += clamp(dot(-clipDir"+a+".xyz, vWorldPosition.xyz - clipPos"+a+".xyz), 0.0, 1000.0);"),q("}");q("  if (dist > 0.0) { discard; }"),q("}")}return q("   gl_FragColor = vColor;"),q("}"),r()}function j(){return p(),q("// Shadow map vertex shader"),q("attribute vec3 position;"),q("uniform mat4 modelMatrix;"),q("uniform mat4 shadowViewMatrix;"),q("uniform mat4 shadowProjMatrix;"),H&&q("varying vec4 vWorldPosition;"),q("void main(void) {"),q("   vec4 worldPosition = modelMatrix * (vec4(position, 1.0));"),H&&q("   vWorldPosition = worldPosition;"),q("   gl_Position = shadowProjMatrix * (shadowViewMatrix * (worldPosition));"),q("}"),r()}function k(){if(p(),q("// Shadow map fragment shader"),q("precision "+s(t.gl)+" float;"),H){q("varying vec4 vWorldPosition;"),q("uniform bool clippable;");for(var a=0;a<t.clips.clips.length;a++)q("uniform bool clipActive"+a+";"),q("uniform vec3 clipPos"+a+";"),q("uniform vec3 clipDir"+a+";")}if(q("void main(void) {"),H){q("if (clippable) {"),q("  float dist = 0.0;");for(var a=0;a<t.clips.clips.length;a++)q("if (clipActive"+a+") {"),q("   dist += clamp(dot(-clipDir"+a+".xyz, vWorldPosition.xyz - clipPos"+a+".xyz), 0.0, 1000.0);"),q("}");q("  if (dist > 0.0) { discard; }"),q("}")}return q("   gl_FragColor = vec4(gl_FragCoord.z, 0.0, 0.0, 0.0);"),q("}"),r()}function l(){p(),q("attribute vec4 position;"),q("uniform mat4 modelMatrix;"),q("uniform mat4 viewMatrix;"),q("uniform mat4 projMatrix;"),q("uniform float thickness;"),y&&q("attribute vec3 normal;");var a=t.modes.billboard;return"spherical"!==a&&"cylindrical"!==a||(q("void billboard(inout mat4 mat) {"),q("   mat[0][0] = 1.0;"),q("   mat[0][1] = 0.0;"),q("   mat[0][2] = 0.0;"),"spherical"===a&&(q("   mat[1][0] = 0.0;"),q("   mat[1][1] = 1.0;"),q("   mat[1][2] = 0.0;")),q("   mat[2][0] = 0.0;"),q("   mat[2][1] = 0.0;"),q("   mat[2][2] =1.0;"),q("}")),H&&q("varying vec4 vWorldPosition;"),q("void main(void) {"),q("mat4 viewMatrix2 = viewMatrix;"),q("mat4 modelMatrix2 = modelMatrix;"),t.modes.stationary&&q("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"!==a&&"cylindrical"!==a||(q("billboard(modelMatrix2);"),q("billboard(viewMatrix2);")),y?(q("vec4 projPos = projMatrix * viewMatrix2 * modelMatrix2 * vec4(position.xyz, 1.0); "),q("  vec3 offset = (normalize(normal) * (thickness * 0.0005 * (projPos.z/1.0)));")):q("  vec3 offset = vec3(0.0, 0.0, 0.0);"),q("vec4 worldPosition = modelMatrix * vec4(position.xyz + offset, 1.0); "),H&&q("   vWorldPosition = worldPosition;"),q("  gl_Position = projMatrix * (viewMatrix * worldPosition);"),q("}"),r()}function m(){if(p(),q("precision "+s(t.gl)+" float;"),q("uniform vec3  color;"),H){q("uniform bool clippable;"),q("varying vec4 vWorldPosition;");for(var a=0;a<t.clips.clips.length;a++)q("uniform bool clipActive"+a+";"),q("uniform vec3 clipPos"+a+";"),q("uniform vec3 clipDir"+a+";")}if(q("void main(void) {"),H){q("if (clippable) {"),q("  float dist = 0.0;");for(var a=0;a<t.clips.clips.length;a++)q("if (clipActive"+a+") {"),q("   dist += clamp(dot(-clipDir"+a+".xyz, vWorldPosition.xyz - clipPos"+a+".xyz), 0.0, 1000.0);"),q("}");q("  if (dist > 0.0) { discard; }"),q("}")}return q("   gl_FragColor = vec4(color, 1.0);"),q("}"),r()}function n(){var a,b,c,d=t.lights.lights;if(p(),q("// Drawing vertex shader"),q("attribute  vec3 position;"),q("uniform    mat4 modelMatrix;"),q("uniform    mat4 viewMatrix;"),q("uniform    mat4 projMatrix;"),q("varying    vec3 vViewPosition;"),H&&q("varying vec4 vWorldPosition;"),t.lights.lightMap&&q("varying    vec3 vWorldNormal;"),y)for(q("attribute  vec3 normal;"),q("uniform    mat4 modelNormalMatrix;"),q("uniform    mat4 viewNormalMatrix;"),q("varying    vec3 vViewNormal;"),t.material.normalMap&&q("varying    mat3 vTBN;"),a=0,b=t.lights.lights.length;a<b;a++)c=t.lights.lights[a],"ambient"!==c.type&&("dir"===c.type&&q("uniform vec3 lightDir"+a+";"),"point"===c.type&&q("uniform vec3 lightPos"+a+";"),"spot"===c.type&&q("uniform vec3 lightPos"+a+";"),"dir"===c.type&&"view"===c.space||q("varying vec4 vViewLightReverseDirAndDist"+a+";"));z&&q("attribute vec3 tangent;"),x&&(q("attribute vec2 uv;"),q("varying vec2 vUV;")),t.geometry.colors&&(q("attribute vec4 color;"),q("varying vec4 vColor;")),"points"===t.geometry.primitiveName&&q("uniform float pointSize;");var e=t.modes.billboard;if("spherical"!==e&&"cylindrical"!==e||(q("void billboard(inout mat4 mat) {"),q("   mat[0][0] = 1.0;"),q("   mat[0][1] = 0.0;"),q("   mat[0][2] = 0.0;"),"spherical"===e&&(q("   mat[1][0] = 0.0;"),q("   mat[1][1] = 1.0;"),q("   mat[1][2] = 0.0;")),q("   mat[2][0] = 0.0;"),q("   mat[2][1] = 0.0;"),q("   mat[2][2] =1.0;"),q("}")),G)for(a=0,b=d.length;a<b;a++)d[a].shadow&&(q("uniform mat4 shadowViewMatrix"+a+";"),q("uniform mat4 shadowProjMatrix"+a+";"),q("varying vec4 vShadowPosFromLight"+a+";"));if(q("void main(void) {"),q("vec4 localPosition = vec4(position, 1.0); "),q("vec4 worldPosition;"),y&&(q("vec4 localNormal = vec4(normal, 0.0); "),q("mat4 modelNormalMatrix2    = modelNormalMatrix;"),q("mat4 viewNormalMatrix2     = viewNormalMatrix;")),q("mat4 viewMatrix2           = viewMatrix;"),q("mat4 modelMatrix2          = modelMatrix;"),t.modes.stationary&&q("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===e||"cylindrical"===e?(q("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),q("billboard(modelMatrix2);"),q("billboard(viewMatrix2);"),q("billboard(modelViewMatrix);"),y&&(q("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),q("billboard(modelNormalMatrix2);"),q("billboard(viewNormalMatrix2);"),q("billboard(modelViewNormalMatrix);")),q("worldPosition = modelMatrix2 * localPosition;"),q("vec4 viewPosition = modelViewMatrix * localPosition;")):(q("worldPosition = modelMatrix2 * localPosition;"),q("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),y)for(q("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),t.lights.lightMap&&q("vWorldNormal = worldNormal;"),q("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),z&&(q("mat4 mat =  viewMatrix2 * modelMatrix2;"),q("vec3 n = normalize( ( mat * vec4( normal, 0.0 ) ).xyz );"),q("vec3 t = normalize( ( mat * vec4( tangent, 0.0 ) ).xyz );"),q("vec3 b = normalize( ( mat * vec4( ( cross(normal, tangent.xyz ) * 1.0 ), 0.0 ) ).xyz );"),q("vTBN = mat3(t, b, n);")),q("vec3 tmpVec3;"),q("float lightDist;"),a=0,b=t.lights.lights.length;a<b;a++)c=t.lights.lights[a],"ambient"!==c.type&&("dir"===c.type&&"world"===c.space&&(q("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+a+", 0.0) ).xyz;"),q("vViewLightReverseDirAndDist"+a+" = vec4(-tmpVec3, 0.0);")),"point"===c.type&&("world"===c.space?(q("tmpVec3 = (viewMatrix2 * vec4(lightPos"+a+", 1.0)).xyz - viewPosition.xyz;"),q("lightDist = abs(length(tmpVec3));")):(q("tmpVec3 = lightPos"+a+".xyz - viewPosition.xyz;"),q("lightDist = abs(length(tmpVec3));")),q("vViewLightReverseDirAndDist"+a+" = vec4(tmpVec3, lightDist);")));if(x&&q("vUV = uv;"),t.geometry.colors&&q("vColor = color;"),"points"===t.geometry.primitiveName&&q("gl_PointSize = pointSize;"),H&&q("vWorldPosition = worldPosition;"),q("   vViewPosition = viewPosition.xyz;"),q("   gl_Position = projMatrix * viewPosition;"),G)for(q("vec4 tempx; "),a=0,b=d.length;a<b;a++)d[a].shadow&&q("vShadowPosFromLight"+a+" = shadowProjMatrix"+a+" * (shadowViewMatrix"+a+" * worldPosition); ");return q("}"),r()}function o(){var a,b,c,d=t.material,e=t.geometry,f="phongMaterial"===d.type,g="MetallicMaterial"===d.type,h="SpecularMaterial"===d.type,i=t.lights.lights;if(p(),q("// Drawing fragment shader"),q("precision "+s(t.gl)+" float;"),q("vec4 LinearTosRGB( in vec4 value ) {"),q("   return vec4(mix(pow(value.rgb,vec3(0.41666))*1.055-vec3(0.055), value.rgb*12.92, vec3(lessThanEqual(value.rgb,vec3(0.0031308)))),value.w);"),q("}"),H){q("varying vec4 vWorldPosition;"),q("uniform bool clippable;");for(var a=0;a<t.clips.clips.length;a++)q("uniform bool clipActive"+a+";"),q("uniform vec3 clipPos"+a+";"),q("uniform vec3 clipDir"+a+";")}if(e.normals&&(t.lights.lightMap&&(q("uniform samplerCube lightMap;"),q("uniform mat4 viewNormalMatrix;")),t.lights.reflectionMap&&q("uniform samplerCube reflectionMap;"),(t.lights.lightMap||t.lights.reflectionMap)&&q("uniform mat4 viewMatrix;"),q("#define PI 3.14159265359"),q("#define RECIPROCAL_PI 0.31830988618"),q("#define RECIPROCAL_PI2 0.15915494"),q("#define EPSILON 1e-6"),q("#define saturate(a) clamp( a, 0.0, 1.0 )"),q("float pow2(const in float x) {"),q("   return x*x;"),q("}"),q("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),q("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),q("}"),q("struct IncidentLight {"),q("   vec3 color;"),q("   vec3 direction;"),q("};"),q("struct ReflectedLight {"),q("   vec3 diffuse;"),q("   vec3 specular;"),q("};"),q("struct Geometry {"),q("   vec3 position;"),q("   vec3 viewNormal;"),q("   vec3 worldNormal;"),q("   vec3 viewEyeDir;"),q("};"),q("struct Material {"),q("   vec3    diffuseColor;"),q("   float   specularRoughness;"),q("   vec3    specularColor;"),q("   float   shine;"),q("};"),q("vec3 BRDF_Diffuse_Lambert(const in vec3 diffuseColor) {"),q("   return RECIPROCAL_PI * diffuseColor;"),q("}"),f&&((t.lights.lightMap||t.lights.reflectionMap)&&(q("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),t.lights.lightMap&&(q("   vec3 irradiance = textureCube(lightMap, geometry.worldNormal).rgb;"),q("   irradiance *= PI;"),q("   vec3 diffuseBRDFContrib = BRDF_Diffuse_Lambert(material.diffuseColor);"),q("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),t.lights.reflectionMap,q("}")),q("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),q("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),q("   vec3 irradiance = dotNL * directLight.color * PI;"),q("   reflectedLight.diffuse  += irradiance * BRDF_Diffuse_Lambert(material.diffuseColor);"),q("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),q("}")),(g||h)&&(q("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),q("   return (2.0 / pow2(ggxRoughness + 0.0001) - 2.0);"),q("}"),q("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),q("   float maxMIPLevelScalar = float( maxMIPLevel );"),q("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );"),q("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),q("}"),t.lights.reflectionMap&&(q("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),q("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),q("   vec3 envMapColor = textureCube(reflectionMap, reflectVec, mipLevel).rgb;"),q("   return envMapColor;"),q("}")),q("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),q("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),q("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),q("}"),q("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),q("   float a2 = pow2( alpha );"),q("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );"),q("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );"),q("   return 1.0 / ( gl * gv );"),q("}"),q("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),q("   float a2 = pow2( alpha );"),q("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );"),q("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );"),q("   return 0.5 / max( gv + gl, EPSILON );"),q("}"),q("float D_GGX(const in float alpha, const in float dotNH) {"),q("   float a2 = pow2( alpha );"),q("   float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;"),q("   return RECIPROCAL_PI * a2 / pow2( denom );"),q("}"),q("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),q("   float alpha = pow2( roughness );"),q("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),q("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),q("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),q("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),q("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),q("   vec3  F = F_Schlick( specularColor, dotLH );"),q("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),q("   float D = D_GGX( alpha, dotNH );"),q("   return F * (G * D);"),q("}"),q("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),q("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),q("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),q("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),q("   vec4 r = roughness * c0 + c1;"),
q("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),q("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),q("   return specularColor * AB.x + AB.y;"),q("}"),(t.lights.lightMap||t.lights.reflectionMap)&&(q("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),t.lights.lightMap&&(q("   vec3 irradiance = textureCube(lightMap, geometry.worldNormal).rgb;"),q("   irradiance *= PI;"),q("   vec3 diffuseBRDFContrib = BRDF_Diffuse_Lambert(material.diffuseColor);"),q("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),t.lights.reflectionMap&&(q("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),q("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),q("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),q("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),q("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),q("   reflectedLight.specular     += radiance * specularBRDFContrib;")),q("}")),q("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),q("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),q("   vec3 irradiance = dotNL * incidentLight.color * PI;"),q("   reflectedLight.diffuse  += irradiance * BRDF_Diffuse_Lambert(material.diffuseColor);"),q("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),q("}"))),q("varying vec3 vViewPosition;"),e.colors&&q("varying vec4 vColor;"),e.uv&&(e.normals&&d.normalMap||d.ambientMap||d.baseColorMap||d.diffuseMap||d.emissiveMap||d.metallicMap||d.roughnessMap||d.metallicRoughnessMap||d.specularMap||d.glossinessMap||d.specularGlossinessMap||d.occlusionMap||d.alphaMap)&&q("varying vec2 vUV;"),e.normals&&(t.lights.lightMap&&q("varying vec3 vWorldNormal;"),q("varying vec3 vViewNormal;")),d.ambient&&q("uniform vec3 materialAmbient;"),d.baseColor&&q("uniform vec3 materialBaseColor;"),void 0!==d.alpha&&null!==d.alpha&&q("uniform vec4 materialAlphaModeCutoff;"),d.emissive&&q("uniform vec3 materialEmissive;"),d.diffuse&&q("uniform vec3 materialDiffuse;"),void 0!==d.glossiness&&null!==d.glossiness&&q("uniform float materialGlossiness;"),void 0!==d.shininess&&null!==d.shininess&&q("uniform float materialShininess;"),d.specular&&q("uniform vec3 materialSpecular;"),void 0!==d.metallic&&null!==d.metallic&&q("uniform float materialMetallic;"),void 0!==d.roughness&&null!==d.roughness&&q("uniform float materialRoughness;"),void 0!==d.specularF0&&null!==d.specularF0&&q("uniform float materialSpecularF0;"),e.uv&&d.ambientMap&&(q("uniform sampler2D ambientMap;"),d.ambientMap.matrix&&q("uniform mat4 ambientMapMatrix;")),e.uv&&d.baseColorMap&&(q("uniform sampler2D baseColorMap;"),d.baseColorMap.matrix&&q("uniform mat4 baseColorMapMatrix;")),e.uv&&d.diffuseMap&&(q("uniform sampler2D diffuseMap;"),d.diffuseMap.matrix&&q("uniform mat4 diffuseMapMatrix;")),e.uv&&d.emissiveMap&&(q("uniform sampler2D emissiveMap;"),d.emissiveMap.matrix&&q("uniform mat4 emissiveMapMatrix;")),e.normals&&e.uv&&d.metallicMap&&(q("uniform sampler2D metallicMap;"),d.metallicMap.matrix&&q("uniform mat4 metallicMapMatrix;")),e.normals&&e.uv&&d.roughnessMap&&(q("uniform sampler2D roughnessMap;"),d.roughnessMap.matrix&&q("uniform mat4 roughnessMapMatrix;")),e.normals&&e.uv&&d.metallicRoughnessMap&&(q("uniform sampler2D metallicRoughnessMap;"),d.metallicRoughnessMap.matrix&&q("uniform mat4 metallicRoughnessMapMatrix;")),e.normals&&d.normalMap&&(q("varying mat3 vTBN;"),q("uniform sampler2D normalMap;"),d.normalMap.matrix&&q("uniform mat4 normalMapMatrix;")),e.uv&&d.occlusionMap&&(q("uniform sampler2D occlusionMap;"),d.occlusionMap.matrix&&q("uniform mat4 occlusionMapMatrix;")),e.uv&&d.alphaMap&&(q("uniform sampler2D alphaMap;"),d.alphaMap.matrix&&q("uniform mat4 alphaMapMatrix;")),e.normals&&e.uv&&d.specularMap&&(q("uniform sampler2D specularMap;"),d.specularMap.matrix&&q("uniform mat4 specularMapMatrix;")),e.normals&&e.uv&&d.glossinessMap&&(q("uniform sampler2D glossinessMap;"),d.glossinessMap.matrix&&q("uniform mat4 glossinessMapMatrix;")),e.normals&&e.uv&&d.specularGlossinessMap&&(q("uniform sampler2D materialSpecularGlossinessMap;"),d.specularGlossinessMap.matrix&&q("uniform mat4 materialSpecularGlossinessMapMatrix;")),e.normals&&(d.diffuseFresnel||d.specularFresnel||d.alphaFresnel||d.emissiveFresnel||d.reflectivityFresnel)&&(q("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),q("    float fr = abs(dot(eyeDir, normal));"),q("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),q("    return pow(finalFr, power);"),q("}"),d.diffuseFresnel&&(q("uniform float  diffuseFresnelCenterBias;"),q("uniform float  diffuseFresnelEdgeBias;"),q("uniform float  diffuseFresnelPower;"),q("uniform vec3   diffuseFresnelCenterColor;"),q("uniform vec3   diffuseFresnelEdgeColor;")),d.specularFresnel&&(q("uniform float  specularFresnelCenterBias;"),q("uniform float  specularFresnelEdgeBias;"),q("uniform float  specularFresnelPower;"),q("uniform vec3   specularFresnelCenterColor;"),q("uniform vec3   specularFresnelEdgeColor;")),d.alphaFresnel&&(q("uniform float  alphaFresnelCenterBias;"),q("uniform float  alphaFresnelEdgeBias;"),q("uniform float  alphaFresnelPower;"),q("uniform vec3   alphaFresnelCenterColor;"),q("uniform vec3   alphaFresnelEdgeColor;")),d.reflectivityFresnel&&(q("uniform float  materialSpecularF0FresnelCenterBias;"),q("uniform float  materialSpecularF0FresnelEdgeBias;"),q("uniform float  materialSpecularF0FresnelPower;"),q("uniform vec3   materialSpecularF0FresnelCenterColor;"),q("uniform vec3   materialSpecularF0FresnelEdgeColor;")),d.emissiveFresnel&&(q("uniform float  emissiveFresnelCenterBias;"),q("uniform float  emissiveFresnelEdgeBias;"),q("uniform float  emissiveFresnelPower;"),q("uniform vec3   emissiveFresnelCenterColor;"),q("uniform vec3   emissiveFresnelEdgeColor;"))),q("uniform vec3   lightAmbient;"),q("uniform float  lightAmbientIntensity;"),e.normals)for(a=0,b=i.length;a<b;a++)c=i[a],"ambient"!==c.type&&(q("uniform vec3 lightColor"+a+";"),q("uniform float lightIntensity"+a+";"),"point"===c.type&&q("uniform vec3 lightAttenuation"+a+";"),"dir"===c.type&&"view"===c.space&&q("uniform vec3 lightDir"+a+";"),q("point"===c.type&&"view"===c.space?"uniform vec3 lightPos"+a+";":"varying vec4 vViewLightReverseDirAndDist"+a+";"));if(G)for(a=0,b=i.length;a<b;a++)i[a].shadow&&(q("varying vec4 vShadowPosFromLight"+a+";"),q("uniform sampler2D shadowMap"+a+";"));if(q("void main(void) {"),H){q("if (clippable) {"),q("  float dist = 0.0;");for(var a=0;a<t.clips.clips.length;a++)q("if (clipActive"+a+") {"),q("   dist += clamp(dot(-clipDir"+a+".xyz, vWorldPosition.xyz - clipPos"+a+".xyz), 0.0, 1000.0);"),q("}");q("  if (dist > 0.0) { discard; }"),q("}")}if("points"===e.primitiveName&&(q("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),q("float r = dot(cxy, cxy);"),q("if (r > 1.0) {"),q("   discard;"),q("}")),q("float occlusion = 1.0;"),q(d.ambient?"vec3 ambientColor = materialAmbient;":"vec3 ambientColor = vec3(1.0, 1.0, 1.0);"),q(d.diffuse?"vec3 diffuseColor = materialDiffuse;":d.baseColor?"vec3 diffuseColor = materialBaseColor;":"vec3 diffuseColor = vec3(1.0, 1.0, 1.0);"),e.colors&&q("diffuseColor *= vColor.rgb;"),q(d.emissive?"vec3 emissiveColor = materialEmissive;":"vec3  emissiveColor = vec3(0.0, 0.0, 0.0);"),q(d.specular?"vec3 specular = materialSpecular;":"vec3 specular = vec3(1.0, 1.0, 1.0);"),q(void 0!==d.alpha?"float alpha = materialAlphaModeCutoff[0];":"float alpha = 1.0;"),e.colors&&q("alpha *= vColor.a;"),q(void 0!==d.glossiness?"float glossiness = materialGlossiness;":"float glossiness = 1.0;"),q(void 0!==d.metallic?"float metallic = materialMetallic;":"float metallic = 1.0;"),q(void 0!==d.roughness?"float roughness = materialRoughness;":"float roughness = 1.0;"),q(void 0!==d.specularF0?"float specularF0 = materialSpecularF0;":"float specularF0 = 1.0;"),e.uv&&(e.normals&&d.normalMap||d.ambientMap||d.baseColorMap||d.diffuseMap||d.occlusionMap||d.emissiveMap||d.metallicMap||d.roughnessMap||d.metallicRoughnessMap||d.specularMap||d.glossinessMap||d.specularGlossinessMap||d.alphaMap)&&(q("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),q("vec2 textureCoord;")),e.uv&&d.ambientMap&&(q(d.ambientMap.matrix?"textureCoord = (ambientMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("ambientColor *= texture2D(ambientMap, textureCoord).rgb;")),e.uv&&d.diffuseMap&&(q(d.diffuseMap.matrix?"textureCoord = (diffuseMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),q("diffuseColor *= diffuseTexel.rgb;"),q("alpha *= diffuseTexel.a;")),e.uv&&d.baseColorMap&&(q(d.baseColorMap.matrix?"textureCoord = (baseColorMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),q("diffuseColor *= baseColorTexel.rgb;"),q("alpha *= baseColorTexel.a;")),e.uv&&d.emissiveMap&&(q(d.emissiveMap.matrix?"textureCoord = (emissiveMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("emissiveColor *= texture2D(emissiveMap, textureCoord).rgb;")),e.uv&&d.alphaMap&&(q(d.alphaMap.matrix?"textureCoord = (alphaMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("alpha *= texture2D(alphaMap, textureCoord).r;")),e.uv&&d.occlusionMap&&(q(d.occlusionMap.matrix?"textureCoord = (occlusionMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("occlusion *= texture2D(occlusionMap, textureCoord).r;")),e.normals&&(i.length>0||t.lights.lightMap||t.lights.reflectionMap)){e.uv&&d.normalMap?(q(d.normalMap.matrix?"textureCoord = (normalMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("vec3 viewNormal = vTBN * normalize( texture2D(normalMap, vec2(textureCoord.x, textureCoord.y) ).rgb * 2.0 - 1.0);")):q("vec3 viewNormal = normalize(vViewNormal);"),e.uv&&d.specularMap&&(q(d.specularMap.matrix?"textureCoord = (specularMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("specular *= texture2D(specularMap, textureCoord).rgb;")),e.uv&&d.glossinessMap&&(q(d.glossinessMap.matrix?"textureCoord = (glossinessMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("glossiness *= texture2D(glossinessMap, textureCoord).r;")),e.uv&&d.specularGlossinessMap&&(q(d.specularGlossinessMap.matrix?"textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),q("specular *= specGlossRGB.rgb;"),q("glossiness *= specGlossRGB.a;")),e.uv&&d.metallicMap&&(q(d.metallicMap.matrix?"textureCoord = (metallicMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("metallic *= texture2D(metallicMap, textureCoord).r;")),e.uv&&d.roughnessMap&&(q(d.roughnessMap.matrix?"textureCoord = (roughnessMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("roughness *= texture2D(roughnessMap, textureCoord).r;")),e.uv&&d.metallicRoughnessMap&&(q(d.metallicRoughnessMap.matrix?"textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),q("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),q("metallic *= metalRoughRGB.b;"),q("roughness *= metalRoughRGB.g;")),q("vec3 viewEyeDir = normalize(-vViewPosition);"),(d.diffuseFresnel||d.specularFresnel||d.alphaFresnel||d.emissiveFresnel||d.reflectivityFresnel)&&(d.diffuseFresnel&&(q("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),q("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),d.specularFresnel&&(q("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),q("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),d.alphaFresnel&&(q("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),q("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),d.emissiveFresnel&&(q("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),q("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);"))),q("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),q("   discard;"),q("}"),q("IncidentLight  light;"),q("Material       material;"),q("Geometry       geometry;"),q("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),q("vec3           viewLightDir;"),f&&(q("material.diffuseColor      = diffuseColor;"),q("material.specularColor     = specular;"),q("material.shine             = materialShininess;")),h&&(q("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),q("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),q("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),q("material.specularColor     = specular;")),g&&(q("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),q("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),q("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),q("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),q("geometry.position      = vViewPosition;"),t.lights.lightMap&&q("geometry.worldNormal   = normalize(vWorldNormal);"),q("geometry.viewNormal    = viewNormal;"),q("geometry.viewEyeDir    = viewEyeDir;"),f&&(t.lights.lightMap||t.lights.reflectionMap)&&q("computePhongLightMapping(geometry, material, reflectedLight);"),(h||g)&&(t.lights.lightMap||t.lights.reflectionMap)&&q("computePBRLightMapping(geometry, material, reflectedLight);");var c;for(a=0,b=i.length;a<b;a++)c=i[a],"ambient"!==c.type&&(q("dir"===c.type&&"view"===c.space?"viewLightDir = -normalize(lightDir"+a+");":"point"===c.type&&"view"===c.space?"viewLightDir = normalize(lightPos"+a+" - vViewPosition);":"viewLightDir = normalize(vViewLightReverseDirAndDist"+a+".xyz);"),q("light.direction = viewLightDir;"),q("light.color = lightIntensity"+a+" * lightColor"+a+";"),f&&q("computePhongLighting(light, geometry, material, reflectedLight);"),(h||g)&&q("computePBRLighting(light, geometry, material, reflectedLight);"));if(q("float shadow = 1.0;"),G)for(q("vec3 shadowCoord;"),q("float depth;"),q("vec4 rgbaDepth;"),a=0,b=i.length;a<b;a++)c=i[a],c.shadow&&(q("shadowCoord = (vShadowPosFromLight"+a+".xyz / vShadowPosFromLight"+a+".w) / 2.0 - 1.0;"),q("rgbaDepth = texture2D(shadowMap"+a+", shadowCoord.xy);"),q("depth = rgbaDepth.r;"),q("shadow *= (shadowCoord.z > depth + 0.005) ? 0.7 : 1.0;"));f?(q("ambientColor *= (lightAmbient * lightAmbientIntensity);"),q("vec3 outgoingLight =  (shadow * occlusion * (ambientColor + reflectedLight.diffuse + reflectedLight.specular)) + emissiveColor;")):q("vec3 outgoingLight = (shadow * occlusion * reflectedLight.diffuse) + (shadow * occlusion * reflectedLight.specular) + emissiveColor;")}else q("ambientColor *= (lightAmbient * lightAmbientIntensity);"),q("vec3 outgoingLight = emissiveColor + ambientColor;");return q("gl_FragColor = vec4(outgoingLight, alpha);"),q("}"),r()}function p(){J=[]}function q(a){J.push(a||"")}function r(){return J}function s(a){return a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}var t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I={},J="";this.getSource=function(p,q){var r=I[p];return r?(r.useCount++,r):(t=q,x=b(),y=d(),z=e(),H=t.clips.clips.length>0,u="phongMaterial"===t.material.type,v="MetallicMaterial"===t.material.type,w="SpecularMaterial"===t.material.type,A=c(),B=t.material.diffuseFresnel,C=t.material.specularFresnel,D=t.material.alphaFresnel,E=t.material.reflectivityFresnel,F=t.material.emissiveFresnel,G=a(),r=new xeogl.renderer.ProgramSource(p,f(),g(),h(),i(),n(),o(),j(),k(),l(),m()),I[p]=r,r)},this.putSource=function(a){var b=I[a];b&&0==--b.useCount&&(I[b.hash]=null)}}}(),function(){"use strict";xeogl.renderer.Chunk=function(){},xeogl.renderer.Chunk.prototype.init=function(a,b,c){this.id=a,this.program=b,this.state=c,this.useCount=0,this.build&&this.build()}}(),function(){"use strict";xeogl.renderer.ChunkFactory=function(){this.types=xeogl.renderer.ChunkFactory.types},xeogl.renderer.ChunkFactory.types={},xeogl.renderer.ChunkFactory.createChunkType=function(a){if(!a.type)throw"'type' expected in params";var b=xeogl.renderer.Chunk,c=function(){this.init.apply(this,arguments)};return c.prototype=new b,c.prototype.constructor=c,xeogl._apply(a,c.prototype),xeogl.renderer.ChunkFactory.types[a.type]={constructor:c,chunks:{},freeChunks:[],freeChunksLen:0},c},xeogl.renderer.ChunkFactory.prototype.getChunk=function(a,b,c,d){var e=this.types[b];if(!e)throw"chunk type not supported: '"+b+"'";var f=e.chunks[a];return f?(f.useCount++,f):(e.freeChunksLen>0&&(f=e.freeChunks[--e.freeChunksLen]),f?f.init(a,c,d):f=new e.constructor(a,c,d),f.useCount=1,e.chunks[a]=f,f)},xeogl.renderer.ChunkFactory.prototype.putChunk=function(a){if(0===a.useCount)return void console.error("xeogl.renderer.Chunkfactory.putChunk: chunk put too many times!");if(0===--a.useCount){var b=this.types[a.type];delete b.chunks[a.id],b.freeChunks[b.freeChunksLen++]=a}},xeogl.renderer.ChunkFactory.prototype.webglRestored=function(a){var b,c,d,e=this.types;for(var f in e)if(e.hasOwnProperty(f)){b=e[f],c=b.chunks;for(var g in c)c.hasOwnProperty(g)&&(d=c[g],d.build&&d.build())}}}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"clips",build:function(){var a,b,c,d,e,f,g=this.state.clips;this._uniforms={draw:[],pickObject:[],pickPrimitive:[],outline:[]};for(a in this._uniforms)if(this._uniforms.hasOwnProperty(a))for(d=this._uniforms[a],e=this.program[a],b=0,c=g.length;b<c;b++)f={active:e.getUniform("clipActive"+b),pos:e.getUniform("clipPos"+b),dir:e.getUniform("clipDir"+b)},d.push(f)},_drawAndPick:function(a,b){for(var c,d,e,f,g=this.state.clips,h=this._uniforms[b],i=0,j=h.length;i<j;i++)c=g[i],d=h[i],e=d.active,e&&e.setValue(c.active),f=d.pos,f&&d.pos.setValue(c.pos),d.dir&&d.dir.setValue(c.dir)},draw:function(a){this._drawAndPick(a,"draw")},shadow:function(a){this._drawAndPick(a,"shadow")},pickObject:function(a){this._drawAndPick(a,"pickObject")},pickPrimitive:function(a){this._drawAndPick(a,"pickPrimitive")},outline:function(a){this._drawAndPick(a,"outline")}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"draw",unique:!0,build:function(){this._uPickColorObject=this.program.pickObject.getUniform("pickColor")},draw:function(a){var b=this.state,c=this.program.gl;b.indices?(c.drawElements(b.primitive,b.indices.numItems,b.indices.itemType,0),a.drawElements++):b.positions&&c.drawArrays(c.TRIANGLES,0,b.positions.numItems)},shadow:function(a){var b=this.state,c=this.program.gl;b.indices?(c.drawElements(b.primitive,b.indices.numItems,b.indices.itemType,0),a.drawElements++):b.positions&&c.drawArrays(b.primitive,0,b.positions.numItems)},pickObject:function(a){var b=this.state,c=this.program.gl;if(this._uPickColorObject){a.pickObjectIndex++;var d=a.pickObjectIndex>>16&255,e=a.pickObjectIndex>>8&255,f=255&a.pickObjectIndex;this._uPickColorObject.setValue([f/255,e/255,d/255,1])}b.indices?c.drawElements(b.primitive,b.indices.numItems,b.indices.itemType,0):b.positions&&c.drawArrays(b.primitive,0,b.positions.numItems)},pickPrimitive:function(){var a=this.state,b=this.program.gl,c=a.getPickPositions();c&&b.drawArrays(a.primitive,0,c.numItems)},outline:function(a){this.draw(a)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"geometry",build:function(){var a=this.program.draw;this._aPositionDraw=a.getAttribute("position"),this._aNormalDraw=a.getAttribute("normal"),this._aUVDraw=a.getAttribute("uv"),this._aTangentDraw=a.getAttribute("tangent"),this._aColorDraw=a.getAttribute("color"),this._aPositionShadow=this.program.shadow.getAttribute("position");var b=this.program.pickObject;this._aPositionPickObject=b.getAttribute("position");var c=this.program.pickPrimitive;this._aPositionPickPrimitive=c.getAttribute("position"),this._aColorPickPrimitive=c.getAttribute("color");var d=this.program.outline;this._aPositionOutline=d.getAttribute("position"),this._aNormalOutline=d.getAttribute("normal")},draw:function(a){var b=this.state;this._aPositionDraw&&(this._aPositionDraw.bindFloatArrayBuffer(b.positions),a.bindArray++),this._aNormalDraw&&(this._aNormalDraw.bindFloatArrayBuffer(b.normals),a.bindArray++),this._aUVDraw&&(this._aUVDraw.bindFloatArrayBuffer(b.uv),a.bindArray++),this._aColorDraw&&(this._aColorDraw.bindFloatArrayBuffer(b.colors),a.bindArray++),this._aTangentDraw&&(this._aTangentDraw.bindFloatArrayBuffer(b.getTangents()),a.bindArray++),b.indices&&(b.indices.bind(),a.bindArray++)},shadow:function(a){var b=this.state;this._aPositionShadow&&(this._aPositionShadow.bindFloatArrayBuffer(b.positions),a.bindArray++),b.indices&&(b.indices.bind(),a.bindArray++)},pickObject:function(){var a=this.state;this._aPositionPickObject&&this._aPositionPickObject.bindFloatArrayBuffer(a.positions),a.indices&&a.indices.bind()},pickPrimitive:function(){var a=this.state;this._aPositionPickPrimitive&&this._aPositionPickPrimitive.bindFloatArrayBuffer(a.getPickPositions()),this._aColorPickPrimitive&&this._aColorPickPrimitive.bindFloatArrayBuffer(a.getPickColors())},outline:function(a){var b=this.state;this._aPositionOutline&&(this._aPositionOutline.bindFloatArrayBuffer(b.positions),a.bindArray++),this._aNormalOutline&&(this._aNormalOutline.bindFloatArrayBuffer(b.normals),a.bindArray++),b.indices&&(b.indices.bind(),a.bindArray++)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"lights",build:function(){this._uLightAmbientColor=this._uLightAmbientColor||[],this._uLightAmbientIntensity=this._uLightAmbientIntensity||[],this._uLightColor=this._uLightColor||[],this._uLightIntensity=this._uLightIntensity||[],this._uLightDir=this._uLightDir||[],this._uLightPos=this._uLightPos||[],this._uLightAttenuation=this._uLightAttenuation||[],this._uShadowViewMatrix=this._uShadowViewMatrix||[],this._uShadowProjMatrix=this._uShadowProjMatrix||[];for(var a,b=this.state.lights,c=this.program,d=0,e=b.length;d<e;d++){switch(a=b[d],a.type){case"ambient":this._uLightAmbientColor[d]=c.draw.getUniform("lightAmbient"),this._uLightAmbientIntensity[d]=c.draw.getUniform("lightAmbientIntensity");break;case"dir":this._uLightColor[d]=c.draw.getUniform("lightColor"+d),this._uLightIntensity[d]=c.draw.getUniform("lightIntensity"+d),this._uLightPos[d]=null,this._uLightDir[d]=c.draw.getUniform("lightDir"+d);break;case"point":this._uLightColor[d]=c.draw.getUniform("lightColor"+d),this._uLightIntensity[d]=c.draw.getUniform("lightIntensity"+d),this._uLightPos[d]=c.draw.getUniform("lightPos"+d),this._uLightDir[d]=null,this._uLightAttenuation[d]=c.draw.getUniform("lightAttenuation"+d)}a.shadow&&(this._uShadowViewMatrix[d]=c.draw.getUniform("shadowViewMatrix"+d),this._uShadowProjMatrix[d]=c.draw.getUniform("shadowProjMatrix"+d))}this.state.lightMap&&(this._uLightMap="lightMap"),this.state.reflectionMap&&(this._uReflectionMap="reflectionMap")},draw:function(a){for(var b,c=this.program.draw,d=(this.program.gl,this.state),e=d.lights,f=xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,g=0,h=e.length;g<h;g++)if(b=e[g],this._uLightAmbientColor[g])this._uLightAmbientColor[g].setValue(b.color),this._uLightAmbientIntensity[g]&&this._uLightAmbientIntensity[g].setValue(b.intensity);else if(this._uLightColor[g]&&this._uLightColor[g].setValue(b.color),this._uLightIntensity[g]&&this._uLightIntensity[g].setValue(b.intensity),this._uLightPos[g]&&(this._uLightPos[g].setValue(b.pos),this._uLightAttenuation[g]&&this._uLightAttenuation[g].setValue(b.attenuation)),this._uLightDir[g]&&this._uLightDir[g].setValue(b.dir),b.shadow){this._uShadowViewMatrix[g]&&this._uShadowViewMatrix[g].setValue(b.getShadowViewMatrix()),this._uShadowProjMatrix[g]&&this._uShadowProjMatrix[g].setValue(b.getShadowProjMatrix());var i=b.getShadowRenderBuf();if(i){i.getTexture();c.bindTexture("shadowMap"+g,i.getTexture(),a.textureUnit),a.textureUnit=(a.textureUnit+1)%f,a.bindTexture++}}d.lightMap&&d.lightMap.texture&&this._uLightMap&&(c.bindTexture(this._uLightMap,d.lightMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%f,a.bindTexture++),d.reflectionMap&&d.reflectionMap.texture&&this._uReflectionMap&&(c.bindTexture(this._uReflectionMap,d.reflectionMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%f,a.bindTexture++)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"modelTransform",build:function(){this._uModelMatrixDraw=this.program.draw.getUniform("modelMatrix"),this._uModelNormalMatrixDraw=this.program.draw.getUniform("modelNormalMatrix"),this._uModelMatrixShadow=this.program.shadow.getUniform("modelMatrix"),this._uModelMatrixPickObject=this.program.pickObject.getUniform("modelMatrix"),this._uModelMatrixPickPrimitive=this.program.pickPrimitive.getUniform("modelMatrix"),this._uModelMatrixOutline=this.program.outline.getUniform("modelMatrix")},draw:function(){this._uModelMatrixDraw&&this._uModelMatrixDraw.setValue(this.state.getMatrix()),this._uModelNormalMatrixDraw&&this._uModelNormalMatrixDraw.setValue(this.state.getNormalMatrix())},shadow:function(){this._uModelMatrixShadow&&this._uModelMatrixShadow.setValue(this.state.getMatrix())},pickObject:function(){this._uModelMatrixPickObject&&this._uModelMatrixPickObject.setValue(this.state.getMatrix())},pickPrimitive:function(){this._uModelMatrixPickPrimitive&&this._uModelMatrixPickPrimitive.setValue(this.state.getMatrix())},outline:function(){this._uModelMatrixOutline&&this._uModelMatrixOutline.setValue(this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"modes",build:function(){this._clippableDraw=this.program.draw.getUniform("clippable"),this._clippableShadow=this.program.shadow.getUniform("clippable"),this._clippablePickObject=this.program.pickObject.getUniform("clippable"),this._clippablePickPrimitive=this.program.pickPrimitive.getUniform("clippable")},draw:function(a){this._clippableDraw&&this._clippableDraw.setValue(this.state.clippable)},shadow:function(a){this._clippableShadow&&this._clippableShadow.setValue(this.state.clippable)},pickObject:function(a){this._clippablePickObject&&this._clippablePickObject.setValue(this.state.clippable)},pickPrimitive:function(a){this._clippablePickPrimitive&&this._clippablePickPrimitive.setValue(this.state.clippable)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"outline",build:function(){var a=this.program.outline;this._uColor=a.getUniform("color"),this._uThickness=a.getUniform("thickness")},outline:function(a){var b=this.state;this._uColor&&this._uColor.setValue(b.color),this._uThickness&&this._uThickness.setValue(b.thickness)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"xray",build:function(){this.program.xray},xray:function(a){this.state}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"phongMaterial",build:function(){var a=this.state,b=this.program.draw;this._uAmbient=b.getUniform("materialAmbient"),this._uDiffuse=b.getUniform("materialDiffuse"),this._uSpecular=b.getUniform("materialSpecular"),this._uEmissive=b.getUniform("materialEmissive"),this._uAlphaModeCutoff=b.getUniform("materialAlphaModeCutoff"),this._uShininess=b.getUniform("materialShininess"),this._uPointSize=b.getUniform("pointSize"),a.ambientMap&&(this._uAmbientMap="ambientMap",this._uAmbientMapMatrix=b.getUniform("ambientMapMatrix")),a.diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=b.getUniform("diffuseMapMatrix")),a.specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=b.getUniform("specularMapMatrix")),a.emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=b.getUniform("emissiveMapMatrix")),a.alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=b.getUniform("alphaMapMatrix")),a.reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=b.getUniform("reflectivityMapMatrix")),a.normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=b.getUniform("normalMapMatrix")),a.occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=b.getUniform("occlusionMapMatrix")),a.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=b.getUniform("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=b.getUniform("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=b.getUniform("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=b.getUniform("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=b.getUniform("diffuseFresnelPower")),a.specularFresnel&&(this._uSpecularFresnelEdgeBias=b.getUniform("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=b.getUniform("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=b.getUniform("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=b.getUniform("specularFresnelCenterColor"),this._uSpecularFresnelPower=b.getUniform("specularFresnelPower")),a.alphaFresnel&&(this._uAlphaFresnelEdgeBias=b.getUniform("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=b.getUniform("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=b.getUniform("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=b.getUniform("alphaFresnelCenterColor"),this._uAlphaFresnelPower=b.getUniform("alphaFresnelPower")),a.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=b.getUniform("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=b.getUniform("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=b.getUniform("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=b.getUniform("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=b.getUniform("reflectivityFresnelPower")),a.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=b.getUniform("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=b.getUniform("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=b.getUniform("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=b.getUniform("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=b.getUniform("emissiveFresnelPower"))},draw:function(a){var b=this.program.draw,c=this.state,d=this.program.gl,e=(xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,c.backfaces);a.backfaces!==e&&(e?d.disable(d.CULL_FACE):d.enable(d.CULL_FACE),a.backfaces=e);var f=c.frontface;a.frontface!==f&&(f?d.frontFace(d.CCW):d.frontFace(d.CW),a.frontface=f),this._uShininess&&this._uShininess.setValue(c.shininess),a.lineWidth!==c.lineWidth&&(d.lineWidth(c.lineWidth),a.lineWidth=c.lineWidth),this._uPointSize&&this._uPointSize.setValue(c.pointSize),this._uAmbient&&this._uAmbient.setValue(c.ambient),this._uDiffuse&&this._uDiffuse.setValue(c.diffuse),this._uSpecular&&this._uSpecular.setValue(c.specular),this._uEmissive&&this._uEmissive.setValue(c.emissive),this._uAlphaModeCutoff&&this._uAlphaModeCutoff.setValue([1*c.alpha,1===c.alphaMode?1:0,c.alphaCutoff,0]),c.ambientMap&&c.ambientMap.texture&&this._uAmbientMap&&(b.bindTexture(this._uAmbientMap,c.ambientMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,
this._uAmbientMapMatrix&&this._uAmbientMapMatrix.setValue(c.ambientMap.matrix)),c.diffuseMap&&c.diffuseMap.texture&&this._uDiffuseMap&&(b.bindTexture(this._uDiffuseMap,c.diffuseMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uDiffuseMapMatrix&&this._uDiffuseMapMatrix.setValue(c.diffuseMap.matrix)),c.specularMap&&c.specularMap.texture&&this._uSpecularMap&&(b.bindTexture(this._uSpecularMap,c.specularMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uSpecularMapMatrix&&this._uSpecularMapMatrix.setValue(c.specularMap.matrix)),c.emissiveMap&&c.emissiveMap.texture&&this._uEmissiveMap&&(b.bindTexture(this._uEmissiveMap,c.emissiveMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uEmissiveMapMatrix&&this._uEmissiveMapMatrix.setValue(c.emissiveMap.matrix)),c.alphaMap&&c.alphaMap.texture&&this._uAlphaMap&&(b.bindTexture(this._uAlphaMap,c.alphaMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uAlphaMapMatrix&&this._uAlphaMapMatrix.setValue(c.alphaMap.matrix)),c.reflectivityMap&&c.reflectivityMap.texture&&this._uReflectivityMap&&(b.bindTexture(this._uReflectivityMap,c.reflectivityMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,this._uReflectivityMapMatrix&&this._uReflectivityMapMatrix.setValue(c.reflectivityMap.matrix)),c.normalMap&&c.normalMap.texture&&this._uNormalMap&&(b.bindTexture(this._uNormalMap,c.normalMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uNormalMapMatrix&&this._uNormalMapMatrix.setValue(c.normalMap.matrix)),c.occlusionMap&&c.occlusionMap.texture&&this._uOcclusionMap&&(b.bindTexture(this._uOcclusionMap,c.occlusionMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uOcclusionMapMatrix&&this._uOcclusionMapMatrix.setValue(c.occlusionMap.matrix)),c.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&this._uDiffuseFresnelEdgeBias.setValue(c.diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&this._uDiffuseFresnelCenterBias.setValue(c.diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&this._uDiffuseFresnelEdgeColor.setValue(c.diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&this._uDiffuseFresnelCenterColor.setValue(c.diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&this._uDiffuseFresnelPower.setValue(c.diffuseFresnel.power)),c.specularFresnel&&(this._uSpecularFresnelEdgeBias&&this._uSpecularFresnelEdgeBias.setValue(c.specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&this._uSpecularFresnelCenterBias.setValue(c.specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&this._uSpecularFresnelEdgeColor.setValue(c.specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&this._uSpecularFresnelCenterColor.setValue(c.specularFresnel.centerColor),this._uSpecularFresnelPower&&this._uSpecularFresnelPower.setValue(c.specularFresnel.power)),c.alphaFresnel&&(this._uAlphaFresnelEdgeBias&&this._uAlphaFresnelEdgeBias.setValue(c.alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&this._uAlphaFresnelCenterBias.setValue(c.alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&this._uAlphaFresnelEdgeColor.setValue(c.alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&this._uAlphaFresnelCenterColor.setValue(c.alphaFresnel.centerColor),this._uAlphaFresnelPower&&this._uAlphaFresnelPower.setValue(c.alphaFresnel.power)),c.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&this._uReflectivityFresnelEdgeBias.setValue(c.reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&this._uReflectivityFresnelCenterBias.setValue(c.reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&this._uReflectivityFresnelEdgeColor.setValue(c.reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&this._uReflectivityFresnelCenterColor.setValue(c.reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&this._uReflectivityFresnelPower.setValue(c.reflectivityFresnel.power)),c.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&this._uEmissiveFresnelEdgeBias.setValue(c.emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&this._uEmissiveFresnelCenterBias.setValue(c.emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&this._uEmissiveFresnelEdgeColor.setValue(c.emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&this._uEmissiveFresnelCenterColor.setValue(c.emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&this._uEmissiveFresnelPower.setValue(c.emissiveFresnel.power))},shadow:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)},pickObject:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)},pickPrimitive:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"MetallicMaterial",build:function(){var a=this.state,b=this.program.draw;this._uBaseColor=b.getUniform("materialBaseColor"),this._uMetallic=b.getUniform("materialMetallic"),this._uRoughness=b.getUniform("materialRoughness"),this._uSpecularF0=b.getUniform("materialSpecularF0"),this._uEmissive=b.getUniform("materialEmissive"),this._uAlphaModeCutoff=b.getUniform("materialAlphaModeCutoff"),a.baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=b.getUniform("baseColorMapMatrix")),a.metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=b.getUniform("metallicMapMatrix")),a.roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=b.getUniform("roughnessMapMatrix")),a.metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=b.getUniform("metallicRoughnessMapMatrix")),a.emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=b.getUniform("emissiveMapMatrix")),a.occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=b.getUniform("occlusionMapMatrix")),a.alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=b.getUniform("alphaMapMatrix")),a.normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=b.getUniform("normalMapMatrix"))},draw:function(a){var b=this.program.draw,c=this.state,d=this.program.gl,e=(xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,c.backfaces);a.backfaces!==e&&(e?d.disable(d.CULL_FACE):d.enable(d.CULL_FACE),a.backfaces=e);var f=c.frontface;a.frontface!==f&&(f?d.frontFace(d.CCW):d.frontFace(d.CW),a.frontface=f),this._uBaseColor&&this._uBaseColor.setValue(c.baseColor),this._uMetallic&&this._uMetallic.setValue(c.metallic),this._uRoughness&&this._uRoughness.setValue(c.roughness),this._uSpecularF0&&this._uSpecularF0.setValue(c.specularF0),this._uEmissive&&this._uEmissive.setValue(c.emissive),this._uAlphaModeCutoff&&this._uAlphaModeCutoff.setValue([1*c.alpha,1===c.alphaMode?1:0,c.alphaCutoff,0]),c.baseColorMap&&c.baseColorMap.texture&&this._uBaseColorMap&&(b.bindTexture(this._uBaseColorMap,c.baseColorMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uBaseColorMapMatrix&&this._uBaseColorMapMatrix.setValue(c.baseColorMap.matrix)),c.metallicMap&&c.metallicMap.texture&&this._uMetallicMap&&(b.bindTexture(this._uMetallicMap,c.metallicMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uMetallicMapMatrix&&this._uMetallicMapMatrix.setValue(c.metallicMap.matrix)),c.roughnessMap&&c.roughnessMap.texture&&this._uRoughnessMap&&(b.bindTexture(this._uRoughnessMap,c.roughnessMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uRoughnessMapMatrix&&this._uRoughnessMapMatrix.setValue(c.roughnessMap.matrix)),c.metallicRoughnessMap&&c.metallicRoughnessMap.texture&&this._uMetallicRoughnessMap&&(b.bindTexture(this._uMetallicRoughnessMap,c.metallicRoughnessMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uMetallicRoughnessMapMatrix&&this._uMetallicRoughnessMapMatrix.setValue(c.metallicRoughnessMap.matrix)),c.emissiveMap&&c.emissiveMap.texture&&this._uEmissiveMap&&(b.bindTexture(this._uEmissiveMap,c.emissiveMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uEmissiveMapMatrix&&this._uEmissiveMapMatrix.setValue(c.emissiveMap.matrix)),c.occlusionMap&&c.occlusionMap.texture&&this._uOcclusionMap&&(b.bindTexture(this._uOcclusionMap,c.occlusionMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uOcclusionMapMatrix&&this._uOcclusionMapMatrix.setValue(c.occlusionMap.matrix)),c.alphaMap&&c.alphaMap.texture&&this._uAlphaMap&&(b.bindTexture(this._uAlphaMap,c.alphaMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uAlphaMapMatrix&&this._uAlphaMapMatrix.setValue(c.alphaMap.matrix)),c.normalMap&&c.normalMap.texture&&this._uNormalMap&&(b.bindTexture(this._uNormalMap,c.normalMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uNormalMapMatrix&&this._uNormalMapMatrix.setValue(c.normalMap.matrix))},shadow:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)},pickObject:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)},pickPrimitive:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"SpecularMaterial",build:function(){var a=this.state,b=this.program.draw;this._uDiffuse=b.getUniform("materialDiffuse"),this._uSpecular=b.getUniform("materialSpecular"),this._uGlossiness=b.getUniform("materialGlossiness"),this._uReflectivity=b.getUniform("reflectivityFresnel"),this._uEmissive=b.getUniform("materialEmissive"),this._uAlphaModeCutoff=b.getUniform("materialAlphaModeCutoff"),a.diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=b.getUniform("diffuseMapMatrix")),a.specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=b.getUniform("specularMapMatrix")),a.glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=b.getUniform("glossinessMapMatrix")),a.specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=b.getUniform("materialSpecularGlossinessMapMatrix")),a.emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=b.getUniform("emissiveMapMatrix")),a.occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=b.getUniform("occlusionMapMatrix")),a.alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=b.getUniform("alphaMapMatrix")),a.normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=b.getUniform("normalMapMatrix"))},draw:function(a){var b=this.program.draw,c=this.state,d=this.program.gl,e=(xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,c.backfaces);a.backfaces!==e&&(e?d.disable(d.CULL_FACE):d.enable(d.CULL_FACE),a.backfaces=e);var f=c.frontface;a.frontface!==f&&(f?d.frontFace(d.CCW):d.frontFace(d.CW),a.frontface=f),this._uDiffuse&&this._uDiffuse.setValue(c.diffuse),this._uSpecular&&this._uSpecular.setValue(c.specular),this._uGlossiness&&this._uGlossiness.setValue(c.glossiness),this._uReflectivity&&this._uReflectivity.setValue(c.reflectivity),this._uEmissive&&this._uEmissive.setValue(c.emissive),this._uAlphaModeCutoff&&this._uAlphaModeCutoff.setValue([1*c.alpha,1===c.alphaMode?1:0,c.alphaCutoff,0]),c.diffuseMap&&c.diffuseMap.texture&&this._uDiffuseMap&&(b.bindTexture(this._uDiffuseMap,c.diffuseMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uDiffuseMapMatrix&&this._uDiffuseMapMatrix.setValue(c.diffuseMap.matrix)),c.specularMap&&c.specularMap.texture&&this._uSpecularMap&&(b.bindTexture(this._uSpecularMap,c.specularMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uSpecularMapMatrix&&this._uSpecularMapMatrix.setValue(c.specularMap.matrix)),c.glossinessMap&&c.glossinessMap.texture&&this._uGlossinessMap&&(b.bindTexture(this._uGlossinessMap,c.glossinessMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uGlossinessMapMatrix&&this._uGlossinessMapMatrix.setValue(c.glossinessMap.matrix)),c.specularGlossinessMap&&c.specularGlossinessMap.texture&&this._uSpecularGlossinessMap&&(b.bindTexture(this._uSpecularGlossinessMap,c.specularGlossinessMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uSpecularGlossinessMapMatrix&&this._uSpecularGlossinessMapMatrix.setValue(c.specularGlossinessMap.matrix)),c.emissiveMap&&c.emissiveMap.texture&&this._uEmissiveMap&&(b.bindTexture(this._uEmissiveMap,c.emissiveMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uEmissiveMapMatrix&&this._uEmissiveMapMatrix.setValue(c.emissiveMap.matrix)),c.occlusionMap&&c.occlusionMap.texture&&this._uOcclusionMap&&(b.bindTexture(this._uOcclusionMap,c.occlusionMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uOcclusionMapMatrix&&this._uOcclusionMapMatrix.setValue(c.occlusionMap.matrix)),c.alphaMap&&c.alphaMap.texture&&this._uAlphaMap&&(b.bindTexture(this._uAlphaMap,c.alphaMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uAlphaMapMatrix&&this._uAlphaMapMatrix.setValue(c.alphaMap.matrix)),c.normalMap&&c.normalMap.texture&&this._uNormalMap&&(b.bindTexture(this._uNormalMap,c.normalMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%xeogl.WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS,a.bindTexture++,this._uNormalMapMatrix&&this._uNormalMapMatrix.setValue(c.normalMap.matrix))},shadow:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)},pickObject:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)},pickPrimitive:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"program",build:function(){},shadow:function(a){this.program.shadow.bind(),a.useProgram++},draw:function(a){this.program.draw.bind(),a.useProgram++,a.textureUnit=0},pickObject:function(){this.program.pickObject.bind()},pickPrimitive:function(){this.program.pickPrimitive.bind()},outline:function(){this.program.outline.bind()}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"projTransform",build:function(){this._uProjMatrixDraw=this.program.draw.getUniform("projMatrix"),this._uProjMatrixShadow=this.program.shadow.getUniform("shadowProjMatrix"),this._uProjMatrixPickObject=this.program.pickObject.getUniform("projMatrix"),this._uProjMatrixPickPrimitive=this.program.pickPrimitive.getUniform("projMatrix"),this._uProjMatrixOutline=this.program.outline.getUniform("projMatrix")},draw:function(){this._uProjMatrixDraw&&this._uProjMatrixDraw.setValue(this.state.getMatrix())},shadow:function(a){this._uProjMatrixShadow&&this._uProjMatrixShadow.setValue(a.shadowProjMatrix)},pickObject:function(a){this._uProjMatrixPickObject&&this._uProjMatrixPickObject.setValue(a.pickProjMatrix||this.state.getMatrix())},pickPrimitive:function(a){this._uProjMatrixPickPrimitive&&this._uProjMatrixPickPrimitive.setValue(a.pickProjMatrix||this.state.getMatrix())},outline:function(a){this._uProjMatrixOutline&&this._uProjMatrixOutline.setValue(this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"viewTransform",build:function(){this._uViewMatrixDraw=this.program.draw.getUniform("viewMatrix"),this._uViewNormalMatrixDraw=this.program.draw.getUniform("viewNormalMatrix"),this._uViewMatrixShadow=this.program.pickObject.getUniform("shadowViewMatrix"),this._uViewMatrixPickObject=this.program.pickObject.getUniform("viewMatrix"),this._uViewMatrixPickPrimitive=this.program.pickPrimitive.getUniform("viewMatrix"),this._uViewMatrixOutline=this.program.outline.getUniform("viewMatrix")},draw:function(){this._uViewMatrixDraw&&this._uViewMatrixDraw.setValue(this.state.getMatrix()),this._uViewNormalMatrixDraw&&this._uViewNormalMatrixDraw.setValue(this.state.getNormalMatrix())},shadow:function(a){this._uViewMatrixShadow&&this._uViewMatrixShadow.setValue(a.shadowViewMatrix),this._uProjMatrixShadow&&this._uProjMatrixShadow.setValue(a.shadowProjMatrix)},pickObject:function(a){this._uViewMatrixPickObject&&this._uViewMatrixPickObject.setValue(a.pickViewMatrix||this.state.getMatrix())},pickPrimitive:function(a){this._uViewMatrixPickPrimitive&&this._uViewMatrixPickPrimitive.setValue(a.pickViewMatrix||this.state.getMatrix())},outline:function(){this._uViewMatrixOutline&&this._uViewMatrixOutline.setValue(this.state.getMatrix())}})}(),function(){"use strict";xeogl.renderer.ChunkFactory.createChunkType({type:"viewport",programGlobal:!0,draw:function(){var a=this.state.boundary;this.program.gl.viewport(a[0],a[1],a[2],a[3])},shadow:function(){this.draw()},pickObject:function(){this.draw()},pickPrimitive:function(){this.draw()},outline:function(){this.draw()}})}(),function(){"use strict";xeogl.Component=Class.extend({__init:function(){var a={},b=arguments[0],c=arguments[1];this.scene=null,"xeogl.Scene"===this.type?(this.scene=this,b&&(a=b)):(b?"xeogl.Scene"===b.type?(this.scene=b,this.owner=this.scene,c&&(a=c)):b.isType&&b.isType("xeogl.Component")?(this.scene=b.scene,this.owner=b,c&&(a=c)):(this.scene=xeogl.scene,this.owner=this.scene,a=b):(this.scene=xeogl.scene,this.owner=this.scene),this._renderer=this.scene._renderer),this.meta=a.meta||{},this.isDefault=a.isDefault,this.id=a.id,this.destroyed=!1,this._attached={},this._attachments=null,this._handleMap=null,this._handleEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._sharedComponents=null,this.scene&&"xeogl.Scene"!==this.type&&this.scene._addComponent(this),this._updateScheduled=!1,this._init&&this._init(a),this.owner&&this.owner._adopt(this)},type:"xeogl.Component",superTypes:[],isType:function(a){return!(!xeogl._isString(a)&&!(a=a.type))&&xeogl._isComponentType(this.type,a)},_init:function(a){},fire:function(a,b,c){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==c&&(this._events[a]=b);var d,e=this._eventSubs[a];if(e)for(var f in e)e.hasOwnProperty(f)&&(d=e[f],this._eventCallDepth++,this._eventCallDepth<300?d.callback.call(d.scope,b):this.error("fire: potential stack overflow from recursive event '"+a+"' - dropping this event"),this._eventCallDepth--)},on:function(a,b,c){this._events||(this._events={}),this._handleMap||(this._handleMap=new xeogl.utils.Map),this._handleEvents||(this._handleEvents={}),this._eventSubs||(this._eventSubs={});var d=this._eventSubs[a];d||(d={},this._eventSubs[a]=d);var e=this._handleMap.addItem();d[e]={callback:b,scope:c||this},this._handleEvents[e]=a;var f=this._events[a];return void 0!==f&&b.call(c||this,f),e},off:function(a){if(void 0!==a&&null!==a&&this._handleEvents){var b=this._handleEvents[a];if(b){delete this._handleEvents[a];var c=this._eventSubs[b];c&&delete c[a],this._handleMap.removeItem(a)}}},once:function(a,b,c){var d=this,e=this.on(a,function(a){d.off(e),b(a)},c)},hasSubs:function(a){return this._eventSubs&&!!this._eventSubs[a]},log:function(a){a="[LOG]"+this._message(a),window.console.log(a),this.scene.fire("log",a)},_message:function(a){return" ["+this.type+" "+xeogl._inQuotes(this.id)+"]: "+a},warn:function(a){a="[WARN]"+this._message(a),window.console.warn(a),this.scene.fire("warn",a)},error:function(a){a="[ERROR]"+this._message(a),window.console.error(a),this.scene.fire("error",a)},clone:function(a){if(this.destroyed)return void this.error("Clone failed - component has been destroyed");a=a||{};var b=this.json;return delete b.id,new this.constructor(this.scene,xeogl._apply(a,b))},_attach:function(a){var b=a.name;if(!b)return void this.error("Component 'name' expected");var c=a.component,d=a.sceneDefault,e=a.sceneSingleton,f=a.type,g=a.on,h=!1!==a.recompiles,i=!1;if(c)if(xeogl._isNumeric(c)||xeogl._isString(c)){var j=c;if(!(c=this.scene.components[j]))return void this.error("Component not found: "+xeogl._inQuotes(j))}else if(xeogl._isObject(c)){var k=c,l=k.type||f||"xeogl.Component",m=window[l];if(!m)return void this.error("Component type not found: "+l);if(f&&!xeogl._isComponentType(l,f))return void this.error("Expected a "+f+" type or subtype, not a "+l);c=new m(this.scene,k),i=!0}if(!c)if(!0===e){var n=this.scene.types[f];for(var o in n)if(n.hasOwnProperty){c=n[o];break}if(!c)return this.error("Scene has no default component for '"+b+"'"),null}else if(!0===d&&!(c=this.scene[b]))return this.error("Scene has no default component for '"+b+"'"),null;if(c){if(c.scene.id!==this.scene.id)return void this.error("Not in same scene: "+c.type+" "+xeogl._inQuotes(c.id));if(f&&!c.isType(f))return void this.error("Expected a "+f+" type or subtype: "+c.type+" "+xeogl._inQuotes(c.id))}this._attachments||(this._attachments={});var p,q,r,s=this._attached[b];if(s){if(c&&s.id===c.id)return;var t=this._attachments[s.id];for(p=t.subs,q=0,r=p.length;q<r;q++)s.off(p[q]);delete this._attached[b],delete this._attachments[s.id];var u=t.params.onDetached;u&&(xeogl._isFunction(u)?u(s):u.scope?u.callback.call(u.scope,s):u.callback(s)),t.managingLifecycle&&s.destroy()}if(c){var v={params:a,component:c,subs:[],managingLifecycle:i};v.subs.push(c.on("destroyed",function(){v.params.component=null,this._attach(v.params)},this)),h&&v.subs.push(c.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[b]=c,this._attachments[c.id]=v;var w=a.onAttached;if(w&&(xeogl._isFunction(w)?w(c):w.scope?w.callback.call(w.scope,c):w.callback(c)),g){var x,y,z,A;for(x in g)if(g.hasOwnProperty(x)){if(y=g[x],xeogl._isFunction(y)?(z=y,A=null):(z=y.callback,A=y.scope),!z)continue;v.subs.push(c.on(x,z,A))}}}return h&&this.fire("dirty",this),this.fire(b,c),c},create:function(a,b){var c=this.scene._getSharedComponent(a,b);return c&&this._adopt(c),c},_adopt:function(a){this._sharedComponents||(this._sharedComponents={}),this._sharedComponents[a.id]||(this._sharedComponents[a.id]=a),a.on("destroyed",function(){delete this._sharedComponents[a.id]},this)},_needUpdate:function(a){this._updateScheduled||(this._updateScheduled=!0,0===a?xeogl.deferTask(this._doUpdate,this):xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._update&&this._update(),this._updateScheduled=!1)},_update:null,_compile:function(){},_props:{json:{get:function(){var a={type:this.type,id:this.id};return xeogl._isEmptyObject(this.meta)||(a.meta=this.meta),this._getJSON?xeogl._apply(this._getJSON(),a):a}},string:{get:function(){function a(a,d){d=d||{};var e=JSON.stringify([1],null,c(d,"indent",2)).slice(2,-3),f=""===e?1/0:c(d,"maxLength",80);return function a(c,d,g){c&&"function"==typeof c.toJSON&&(c=c.toJSON());var h=JSON.stringify(c);if(void 0===h)return h;var i=f-d.length-g;if(h.length<=i){var j=b(h);if(j.length<=i)return j}if("object"==typeof c&&null!==c){var k,l=d+e,m=[],n=function(a,b){return b===a.length-1?0:1};if(Array.isArray(c)){for(var o=0;o<c.length;o++)m.push(a(c[o],l,n(c,o))||"null");k="[]"}else Object.keys(c).forEach(function(b,d,e){var f=JSON.stringify(b)+": ",g=a(c[b],l,f.length+n(e,d));void 0!==g&&m.push(f+g)}),k="{}";if(m.length>0)return[k[0],e+m.join(",\n"+l),k[1]].join("\n"+d)}return h}(a,"",0)}function b(a){return a.replace(d,function(a,b){return b?a:a+" "})}function c(a,b,c){return b in a?a[b]:c}var d=/("(?:[^"]|\\.)*")|[:,]/g;return function(){return a(this.json,null,"\t")}}()},js:{get:function(){return"new "+this.type+"("+this.string+");"}}},destroy:function(){if(!this.destroyed){var a,b,c,d,e,f;if(this._attachments)for(a in this._attachments)if(this._attachments.hasOwnProperty(a)){for(b=this._attachments[a],c=b.component,d=b.subs,e=0,f=d.length;e<f;e++)c.off(d[e]);b.managingLifecycle&&c.destroy()}if(this._sharedComponents)for(a in this._sharedComponents)this._sharedComponents.hasOwnProperty(a)&&(c=this._sharedComponents[a],delete this._sharedComponents[a],this.scene._putSharedComponent(c));this._destroy&&this._destroy(),this.fire("destroyed",this.destroyed=!0)}},_destroy:function(){}})}(),function(){"use strict";xeogl.Scene=xeogl.Component.extend({type:"xeogl.Scene",_init:function(a){var b=this,c=!!a.transparent;this.startTime=(new Date).getTime(),this.components={},this.types={},this.entities={},this.models={},this._sharedComponents={},this._sharedComponentIDs={},this._sharedCounts={},this._dirtyEntities={},this.configs=new xeogl.Configs(this,a.configs),this.canvas=new xeogl.Canvas(this,{canvas:a.canvas,transparent:c,backgroundColor:a.backgroundColor,backgroundImage:a.backgroundImage,webgl2:!1!==a.webgl2,contextAttr:a.contextAttr||{}}),this.canvas.on("boundary",function(){b._renderer.imageDirty=!0}),this.canvas.on("webglContextFailed",function(){alert("xeogl failed to find WebGL!")}),this._renderer=new xeogl.renderer.Renderer(xeogl.stats,this.canvas.canvas,this.canvas.gl,{transparent:c}),this.input=new xeogl.Input(this,{element:this.canvas.overlay}),xeogl._addScene(this);var d=a.components;if(d)for(var e,f,g,h=0,i=d.length;h<i;h++)e=d[h],(f=e.type)&&(g=window[f])&&new g(this,e);this._initDefaults(),this.ticksPerRender=a.ticksPerRender,this.passes=a.passes,this.clearEachPass=a.clearEachPass},_initDefaults:function(){this.view,this.project,this.camera,this.clips,this.geometry,this.lights,this.material,this.morphTargets,this.transform,this.viewport,this.outline,this.xray},_addComponent:function(a){if(a.id){if(this.components[a.id])return void this.error("Component "+xeogl._inQuotes(a.id)+" already exists in Scene - ignoring ID, will randomly-generate instead")}else for(a.id=xeogl.math.createUUID();this.components[a.id];)a.id=xeogl.math.createUUID();this.components[a.id]=a;var b=a.type,c=this.types[a.type];c||(c=this.types[b]={}),c[a.id]=a,a.on("destroyed",function(){this._componentDestroyed(a)},this),a.isType("xeogl.Entity")&&(a.on("dirty",this._entityDirty,this),this.entities[a.id]=a,this._worldBoundary&&a.worldBoundary.on("updated",this._setWorldBoundaryDirty,this),xeogl.stats.components.entities++),a.isType("xeogl.Model")&&(this.models[a.id]=a,xeogl.stats.components.models++),this.fire("componentCreated",a,!0)},_componentDestroyed:function(a){delete this.components[a.id];var b=this.types[a.type];b&&(delete b[a.id],xeogl._isEmptyObject(b)&&delete this.types[a.type]),a.isType("xeogl.Entity")&&(xeogl.stats.components.entities--,delete this.entities[a.id],delete this._dirtyEntities[a.id]),a.isType("xeogl.Model")&&(xeogl.stats.components.models--,delete this.models[a.id]),this.fire("componentDestroyed",a,!0)},_entityDirty:function(a){this._dirtyEntities[a.id]||(this._dirtyEntities[a.id]=a)},render:function(){var a={sceneId:null,pass:null};return function(b){a.sceneId=this.id;var c,d,e=this._passes,f=this._clearEachPass;for(c=0;c<e;c++)a.pass=c,this.fire("rendering",a,!0),d=f||0===c,this._compile(c,d,b),this.fire("rendered",a,!0)}}(),_props:{ticksPerRender:{set:function(a){void 0===a||null===a?a=1:(!xeogl._isNumeric(a)||a<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+a+"' - should be an integer greater than zero."),a=1),a!==this._ticksPerRender&&(this._ticksPerRender=a,this.fire("ticksPerRender",this._ticksPerRender))},get:function(){return this._ticksPerRender}},passes:{set:function(a){void 0===a||null===a?a=1:(!xeogl._isNumeric(a)||a<=0)&&(this.error("Unsupported value for 'passes': '"+a+"' - should be an integer greater than zero."),a=1),a!==this._passes&&(this._passes=a,this._renderer.imageDirty=!0,this.fire("passes",this._passes))},get:function(){return this._passes}},clearEachPass:{set:function(a){(a=!!a)!==this._clearEachPass&&(this._clearEachPass=a,this._renderer.imageDirty=!0,this.fire("clearEachPass",this._clearEachPass))},get:function(){return this._clearEachPass}},project:{get:function(){return this.components["default.project"]||new xeogl.Perspective(this,{id:"default.project",isDefault:!0})}},view:{get:function(){return this.components["default.view"]||new xeogl.Lookat(this,{id:"default.view",isDefault:!0})}},camera:{get:function(){return this.components["default.camera"]||new xeogl.Camera(this,{id:"default.camera",isDefault:!0,project:"default.project",view:"default.view"})}},transform:{get:function(){return this.components["default.transform"]||new xeogl.Transform(this,{id:"default.transform",isDefault:!0})}},clips:{get:function(){return this.components["default.clips"]||new xeogl.Clips(this,{id:"default.clips",isDefault:!0})}},geometry:{get:function(){return this.components["default.geometry"]||new xeogl.BoxGeometry(this,{id:"default.geometry",isDefault:!0})}},lights:{get:function(){return this.components["default.lights"]||new xeogl.Lights(this,{id:"default.lights",isDefault:!0,lights:[new xeogl.DirLight(this,{id:"default.light2",dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),new xeogl.DirLight(this,{id:"default.light3",dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new xeogl.DirLight(this,{id:"default.light4",dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"})]})}},material:{get:function(){return this.components["default.material"]||new xeogl.PhongMaterial(this,{id:"default.material",isDefault:!0,emissive:[.4,.4,.4]})}},morphTargets:{get:function(){return this.components["default.morphTargets"]||new xeogl.MorphTargets(this,{id:"default.morphTargets",isDefault:!0})}},viewport:{get:function(){return this.components["default.viewport"]||new xeogl.Viewport(this,{id:"default.viewport",autoBoundary:!0,isDefault:!0})}},outline:{get:function(){return this.components["default.outline"]||new xeogl.Outline(this,{id:"default.outline",thickness:15,color:[1,1,0]})}},xray:{get:function(){return this.components["default.xray"]||new xeogl.XRay(this,{id:"default.xray",foo:1,bar:2})}},worldBoundary:{get:function(){if(!this._worldBoundary){
var a=this,b=xeogl.math.AABB3();this._worldBoundary=new xeogl.Boundary3D(this.scene,{getDirty:function(){return a._worldBoundaryDirty},getAABB:function(){xeogl.math.collapseAABB3(b);var c,d=a.entities;for(var e in d)d.hasOwnProperty(e)&&(c=d[e],c.collidable&&xeogl.math.expandAABB3(b,c.worldBoundary.aabb));return b}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null}),this._setWorldBoundaryDirty()}return this._worldBoundary}}},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},pick:function(){var a=xeogl.math,b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3(),g=a.vec3(),h=a.vec4(),i=a.vec3(),j=a.vec3(),k=a.vec3(),l=a.vec3(),m=a.vec3(),n=a.vec3(),o=a.vec3(),p=a.vec3(),q=a.vec3(),r=a.vec4(),s=a.vec4(),t=a.vec4(),u=a.vec3(),v=a.vec3(),w=a.vec3(),x=a.vec3(),y=a.vec3(),z=a.vec3(),A=a.vec3(),B=a.vec3(),C=a.vec3(),D=a.vec3(),E=a.vec3();return function(F){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;F=F||{},F.pickSurface=F.pickSurface||F.rayPick,F.canvasPos||F.origin&&F.direction||this.warn("picking without canvasPos or ray origin and direction");var G=this._renderer.pick(F);if(G){var H=this.entities[G.entity];if(G.entity=H,F.pickSurface&&void 0!==G.primIndex&&G.primIndex>-1){var I=H.geometry;if("triangles"===I.primitive){G.primitive="triangle";var J,K,L,M=G.primIndex,N=I.indices,O=I.positions;if(N){var P=N[M],Q=N[M+1],R=N[M+2];g[0]=P,g[1]=Q,g[2]=R,G.indices=g,J=3*P,K=3*Q,L=3*R}else J=3*M,K=J+3,L=K+3;d[0]=O[J],d[1]=O[J+1],d[2]=O[J+2],e[0]=O[K],e[1]=O[K+1],e[2]=O[K+2],f[0]=O[L],f[1]=O[L+1],f[2]=O[L+2];var S;F.canvasPos?(S=F.canvasPos,G.canvasPos=F.canvasPos,a.canvasPosToLocalRay(H.camera,H,S,b,c)):F.origin&&F.direction&&a.worldRayToLocalRay(H,F.origin,F.direction,b,c),a.normalizeVec3(c),a.rayPlaneIntersect(b,c,d,e,f,h),G.localPos=h,G.position=h,r[0]=h[0],r[1]=h[1],r[2]=h[2],r[3]=1,a.transformVec4(H.transform.leafMatrix,r,s),i[0]=s[0],i[1]=s[1],i[2]=s[2],G.worldPos=i,a.transformVec4(H.camera.view.matrix,s,t),j[0]=t[0],j[1]=t[1],j[2]=t[2],G.viewPos=j,a.cartesianToBarycentric(h,d,e,f,k),G.bary=k;var T=I.normals;if(T){l[0]=T[J],l[1]=T[J+1],l[2]=T[J+2],m[0]=T[K],m[1]=T[K+1],m[2]=T[K+2],n[0]=T[L],n[1]=T[L+1],n[2]=T[L+2];var U=a.addVec3(a.addVec3(a.mulVec3Scalar(l,k[0],u),a.mulVec3Scalar(m,k[1],v),w),a.mulVec3Scalar(n,k[2],x),y);G.normal=a.transformVec3(H.transform.leafMatrix,U,z)}var V=I.uv;V&&(o[0]=V[2*P],o[1]=V[2*P+1],p[0]=V[2*Q],p[1]=V[2*Q+1],q[0]=V[2*R],q[1]=V[2*R+1],G.uv=a.addVec3(a.addVec3(a.mulVec2Scalar(o,k[0],A),a.mulVec2Scalar(p,k[1],B),C),a.mulVec2Scalar(q,k[2],D),E))}}return G}}}(),clear:function(){for(var a in this.components)this.components.hasOwnProperty(a)&&this.components[a].destroy();this._initDefaults(),this._dirtyEntities={}},_getSharedComponent:function(a,b){var c,d;if(xeogl._isObject(a)?(c=a.type||"xeogl.Component",d=xeogl[c.substring(6)]):xeogl._isString(a)?(c=a,d=xeogl[c.substring(6)]):(d=a,c=a.prototype.type),!d)return void this.error("Component type not found: "+c);if(!xeogl._isComponentType(c,"xeogl.Component"))return void this.error("Expected a xeogl.Component type or subtype");var e,f;return void 0!==b&&(f="__shared."+c+"."+b,e=this._sharedComponents[f])?(this._sharedCounts[f]++,e):a&&a.id&&this.components[a.id]?(this.error("Component "+xeogl._inQuotes(a.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),null):(e=new d(this,a),void 0!==b&&(this._sharedComponents[f]=e,this._sharedComponentIDs[e.id]=f,this._sharedCounts[f]=1,e.on("destroyed",function(){void 0!==this._sharedComponentIDs[e.id]&&this._putSharedComponent(e)},this)),e)},_putSharedComponent:function(a){var b=this._sharedComponentIDs[a.id];if(void 0!==b){if(--this._sharedCounts[b]>0)return;delete this._sharedComponents[b],delete this._sharedComponentIDs[a.id],delete this._sharedCounts[b]}a.destroy()},_compile:function(a,b,c){var d,e=0;for(var f in this._dirtyEntities)this._dirtyEntities.hasOwnProperty(f)&&(d=this._dirtyEntities[f],d._valid()&&(d._compileAsynch(),delete this._dirtyEntities[f],e++));this._renderer.render({pass:a,clear:b,force:c});var g=this.canvas;if(g.transparent||g.backgroundImage||g.backgroundColor)this._lastAmbientColor=null;else{var h=this._renderer.ambientColor;this._lastAmbientColor&&this._lastAmbientColor[0]===h[0]&&this._lastAmbientColor[1]===h[1]&&this._lastAmbientColor[2]===h[2]&&this._lastAmbientColor[3]===h[3]||(g.backgroundColor=h,this._lastAmbientColor||(this._lastAmbientColor=xeogl.math.vec4()),this._lastAmbientColor.set(h))}},_getJSON:function(){var a,b=[];for(var c in this.components)if(this.components.hasOwnProperty(c)){if(a=this.components[c],!a._getJSON)continue;b.push(a.json)}return{passes:this._passes,clearEachPass:this._clearEachPass,components:b}},_destroy:function(){this.clear()}})}(),function(){"use strict";xeogl.MorphTargets=xeogl.Component.extend({type:"xeogl.MorphTargets",_init:function(a){this.scene.on("webglContextRestored",function(){}),this.targets=a.targets,this.factor=a.factor},_props:{targets:{set:function(a){},get:function(){}},factor:{set:function(a){},get:function(){return 0}},_compile:function(){this._renderer.MorphTargets=this._state}},_getJSON:function(){return{targets:this.targets,factor:this.factor}}})}(),function(){"use strict";var a=xeogl.math;xeogl.CameraFlightAnimation=xeogl.Component.extend({type:"xeogl.CameraFlightAnimation",_init:function(b){this._aabbHelper=this.create({type:"xeogl.Entity",camera:b.camera,geometry:this.create({type:"xeogl.AABBGeometry"}),material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[.5,1,.5],lineWidth:2}),visible:!1,collidable:!1}),this._obbHelper=this.create({type:"xeogl.Entity",camera:b.camera,geometry:this.create({type:"xeogl.OBBGeometry",material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[.5,1,.5],lineWidth:2})}),visible:!1,collidable:!1}),this._look1=a.vec3(),this._eye1=a.vec3(),this._up1=a.vec3(),this._look2=a.vec3(),this._eye2=a.vec3(),this._up2=a.vec3(),this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingUp=!1,this._callback=null,this._callbackScope=null,this._onTick=null,this._time1=null,this._time2=null,this.easing=!1!==b.easing,this.duration=b.duration,this.fit=b.fit,this.fitFOV=b.fitFOV,this.trail=b.trail,this.camera=b.camera},flyTo:function(){var b=a.vec3();return function(c,d,e){c=c||this.scene,this._flying&&this.stop();var f=this._attached.camera;if(!f)return void(d&&(e?d.call(e):d()));this._flying=!1,this._callback=d,this._callbackScope=e;var g=f.view;this._eye1[0]=g.eye[0],this._eye1[1]=g.eye[1],this._eye1[2]=g.eye[2],this._look1[0]=g.look[0],this._look1[1]=g.look[1],this._look1[2]=g.look[2],this._up1[0]=g.up[0],this._up1[1]=g.up[1],this._up1[2]=g.up[2];var h,i,j,k,l;if(c.worldBoundary)h=c.worldBoundary.aabb;else if(c.aabb)h=c.aabb;else if(6===c.length)h=c;else if(c.eye&&c.look||c.up)i=c.eye,j=c.look,k=c.up;else if(c.eye)i=c.eye;else if(c.look)j=c.look;else{var m=c;if((xeogl._isNumeric(m)||xeogl._isString(m))&&(l=m,!(m=this.scene.components[l])))return this.error("Component not found: "+xeogl._inQuotes(l)),void(d&&(e?d.call(e):d()));var n=m.worldBoundary;if(!n)return this.error("Can't fly to component "+xeogl._inQuotes(l)+" - does not have a worldBoundary"),void(d&&(e?d.call(e):d()));h=n.aabb}var o=c.offset;if(h){if(h[3]<h[0]||h[4]<h[1]||h[5]<h[2])return;if(h[3]===h[0]&&h[4]===h[1]&&h[5]===h[2])return;!1!==c.showAABB&&(this._aabbHelper.geometry.aabb=h,this._aabbHelper.visible=!0);var p=a.getAABB3Center(h);this._look2=c.look||p,o&&(this._look2[0]+=o[0],this._look2[1]+=o[1],this._look2[2]+=o[2]);var q=a.normalizeVec3(a.subVec3(this._eye1,this._look1,b)),r=(c.look,a.getAABB3Diag(h)),s=Math.abs(r/Math.tan((c.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD));this._eye2[0]=this._look2[0]+q[0]*s,this._eye2[1]=this._look2[1]+q[1]*s,this._eye2[2]=this._look2[2]+q[2]*s,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyEyeLookUp=!1}else(i||j||k)&&(this._flyEyeLookUp=!0,this._flyingEye=!!i&&!j,this._flyingLook=!!j&&!i,j&&(this._look2[0]=j[0],this._look2[1]=j[1],this._look2[2]=j[2]),i&&(this._eye2[0]=i[0],this._eye2[1]=i[1],this._eye2[2]=i[2]),k&&(this._up2[0]=k[0],this._up2[1]=k[1],this._up2[2]=k[2]));this.fire("started",c,!0),this._time1=Date.now(),this._time2=this._time1+(c.duration?1e3*c.duration:this._duration),this._flying=!0,xeogl.scheduleTask(this._update,this)}}(),jumpTo:function(a){var b=this;xeogl.scheduleTask(function(){b._jumpTo(a)})},_jumpTo:function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3();return function(g){this._flying&&this.stop();var h=this._attached.camera;if(h){var i,j,k=h.view;if(g.worldBoundary)i=g.worldBoundary.aabb;else if(g.aabb)i=g.aabb;else if(6===g.length)i=g;else if(g.eye||g.look||g.up)b=g.eye,c=g.look,d=g.up;else{var l=g;if((xeogl._isNumeric(l)||xeogl._isString(l))&&(j=l,!(l=this.scene.components[j])))return void this.error("Component not found: "+xeogl._inQuotes(j));var m=l.worldBoundary;if(!m)return void this.error("Can't jump to component "+xeogl._inQuotes(j)+" - does not have a worldBoundary");i=m.aabb}g.offset;if(i){var n;if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;n=a.getAABB3Diag(i),a.getAABB3Center(i,c),this._trail?a.subVec3(k.look,c,e):a.subVec3(k.eye,k.look,e),a.normalizeVec3(e);var o;o=(void 0!==g.fit?g.fit:this._fit)?Math.abs(n/Math.tan((g.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD)):a.lenVec3(a.subVec3(k.eye,k.look,f)),a.mulVec3Scalar(e,o),k.eye=a.addVec3(c,e,b),k.look=c}else(b||c||d)&&(b&&(k.eye=b),c&&(k.look=c),d&&(k.up=d))}}}(),_update:function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3();return function(){if(this._flying){var g=Date.now(),h=(g-this._time1)/(this._time2-this._time1),i=h>=1;h>1&&(h=1),h=this.easing?this._ease(h,0,1,1):h;var j=this._attached.camera.view;if(this._flyEyeLookUp)this._flyingEye||this._flyingLook?(a.subVec3(j.eye,j.look,b),this._flyingEye?(j.eye=a.lerpVec3(h,0,1,this._eye1,this._eye2,c),j.look=a.subVec3(c,b,d)):this._flyingLook&&(j.look=a.lerpVec3(h,0,1,this._look1,this._look2,d),j.eye=a.addVec3(d,b,c))):(j.eye=a.lerpVec3(h,0,1,this._eye1,this._eye2,c),j.look=a.lerpVec3(h,0,1,this._look1,this._look2,d),j.up=a.lerpVec3(h,0,1,this._up1,this._up2,e));else{a.lerpVec3(h,0,1,this._look1,this._look2,d);var k;this._trail?a.subVec3(d,j.look,b):a.subVec3(j.eye,j.look,b),a.normalizeVec3(b),a.lerpVec3(h,0,1,this._eye1,this._eye2,c),a.subVec3(c,d,f),k=a.lenVec3(f),a.mulVec3Scalar(b,k),j.eye=a.addVec3(d,b,c),j.look=d}if(i)return void this.stop();xeogl.scheduleTask(this._update,this)}}}(),_ease:function(a,b,c,d){return a/=d,-c*a*(a-2)+b},stop:function(){if(this._flying){this._aabbHelper.visible=!1,this._flying=!1,this._time1=null,this._time2=null;var a=this._callback;a&&(this._callback=null,this._callbackScope?a.call(this._callbackScope):a()),this.fire("stopped",!0,!0)}},cancel:function(){this._flying&&(this._aabbHelper.visible=!1,this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0}),this._aabbHelper.camera=this._attached.camera,this.stop()},get:function(){return this._attached.camera}},duration:{set:function(a){a=a||.5,this._duration=1e3*a,this.stop()},get:function(){return this._duration/1e3}},fit:{set:function(a){this._fit=!1!==a,this.fire("fit",this._fit)},get:function(){return this._fit}},fitFOV:{set:function(a){a=a||45,this._fitFOV=a},get:function(){return this._fitFOV}},trail:{set:function(a){this._trail=!!a,this.fire("trail",this._trail)},get:function(){return this._trail}}},_getJSON:function(){var a={duration:this._duration,fitFOV:this._fitFOV,fit:this._fit,trail:this._trail};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.stop()}})}(),function(){"use strict";xeogl.Camera=xeogl.Component.extend({type:"xeogl.Camera",_init:function(a){this.project=a.project,this.view=a.view},_props:{project:{set:function(a){this._attach({name:"project",type:"xeogl.Transform",component:a,sceneDefault:!0,on:{matrix:{callback:function(){this.fire("projectMatrix")},scope:this}}})},get:function(){return this._attached.project}},view:{set:function(a){this._attach({name:"view",type:"xeogl.Transform",component:a,sceneDefault:!0,on:{matrix:{callback:function(){this.fire("viewMatrix")},scope:this}}})},get:function(){return this._attached.view}}},_compile:function(){this._renderer.projTransform=this._attached.project._state,this._renderer.viewTransform=this._attached.view._state},_getJSON:function(){return{project:this._attached.project.id,view:this._attached.view.id}}})}(),function(){"use strict";xeogl.Canvas=xeogl.Component.extend({type:"xeogl.Canvas",serializable:!1,_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(a){if(this.canvas=null,this.overlay=null,this.gl=null,this.webgl2=!1,this.transparent=!!a.transparent,this.contextAttr=a.contextAttr||{},this.contextAttr.alpha=this.transparent,void 0!==this.contextAttr.preserveDrawingBuffer&&null!==this.contextAttr.preserveDrawingBuffer||(this.contextAttr.preserveDrawingBuffer=!1),this.contextAttr.stencil=!0,a.canvas?xeogl._isString(a.canvas)?(this.canvas=document.getElementById(a.canvas),this.canvas||(this.error("Canvas element not found: "+xeogl._inQuotes(a.canvas)+" - creating default canvas instead."),this._createCanvas())):this.canvas=a.canvas:this._createCanvas(),!this.canvas)return void this.error("Faied to create canvas");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._createBackground(),this._createOverlay(),this._initWebGL(a);var b=this;this.canvas.addEventListener("webglcontextlost",function(){b.fire("webglContextLost")},!1),this.canvas.addEventListener("webglcontextrestored",function(){b._initWebGL(),b.gl&&b.fire("webglContextRestored",b.gl)},!1);var c=null,d=null,e=null,f=null,g=null,h=null;this._tick=this.scene.on("tick",function(){var a=b.canvas,i=window.innerWidth!==c||window.innerHeight!==d,j=a.clientWidth!==e||a.clientHeight!==f,k=a.offsetLeft!==g||a.offsetTop!==h;if(i||j||k){if(b._spinner._adjustPosition(),b._resizeOverlay(),j){var l,m=a.clientWidth,n=a.clientHeight,o=0;for(var p in xeogl.scenes)xeogl.scenes.hasOwnProperty(p)&&(l=xeogl.scenes[p],o+=l.canvas.canvas.clientWidth*l.canvas.canvas.clientHeight);xeogl.stats.memory.pixels=o,a.width=a.clientWidth,a.height=a.clientHeight;var q=b.boundary;q[0]=a.offsetLeft,q[1]=a.offsetTop,q[2]=m,q[3]=n,b.fire("boundary",q),e=m,f=n}i&&(c=window.innerWidth,d=window.innerHeight),k&&(g=a.offsetLeft,h=a.offsetTop)}}),this.canvas.oncontextmenu=function(a){a.preventDefault()},this._spinner=new xeogl.Spinner(this.scene,{canvas:this.canvas}),this.backgroundColor=a.backgroundColor,this.backgroundImage=a.backgroundImage},_createCanvas:function(){var a="xeogl-canvas-"+xeogl.math.createUUID(),b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.height="100%",d.width="100%",d.padding="0",d.margin="0",d.background="rgba(0,0,0,0);",d.float="left",d.left="0",d.top="0",d.position="absolute",d.opacity="1.0",d["z-index"]="-10000",c.innerHTML+='<canvas id="'+a+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',b.appendChild(c),this.canvas=document.getElementById(a)},_createBackground:function(){var a=document.createElement("div"),b=a.style;b.padding="0",b.margin="0",b.background=null,b.backgroundImage=null,b.float="left",b.left="0",b.top="0",b.width="100%",b.height="100%",b.position="absolute",b.opacity=1,b["z-index"]="-20000",this.canvas.parentElement.appendChild(a),this._backgroundElement=a},_createOverlay:function(){var a=document.createElement("div"),b=a.style;b.padding="0",b.margin="0",b.background="black",b.float="left",b.left="0",b.top="0",b.width="100%",b.height="100%",b.position="absolute",b.opacity=0,b["z-index"]="100000",this.canvas.parentElement.appendChild(a),this.overlay=a},_resizeOverlay:function(){if(this.canvas&&this.overlay){var a=this.canvas,b=this.overlay,c=b.style,d=this._getElementXY(a);c.left=d.x+"px",c.top=d.y+"px",c.width=a.clientWidth+"px",c.height=a.clientHeight+"px"}},_getElementXY:function(a){for(var b=0,c=0;a;)b+=a.offsetLeft-a.scrollLeft,c+=a.offsetTop-a.scrollTop,a=a.offsetParent;return{x:b,y:c}},_initWebGL:function(a){if(a.webgl2){try{this.gl=this.canvas.getContext("webgl2",this.contextAttr)}catch(c){}this.gl?this.webgl2=!0:this.warn("Failed to get a WebGL 2 context - defaulting to WebGL 1.")}if(!this.gl)for(var b=0;!this.gl&&b<this._WEBGL_CONTEXT_NAMES.length;b++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[b],this.contextAttr)}catch(c){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0))},getSnapshot:function(a,b){if(!this.canvas)return this.error("Can't get snapshot - no canvas."),void b(null);if(!b)return this._getSnapshot(a);var c=this;requestAnimationFrame(function(){c.scene.render(!0),b(c._getSnapshot(a))})},_getSnapshot:function(a){a=a||{};var b,c=a.width||this.canvas.width,d=a.height||this.canvas.height,e=a.format||"jpeg";switch(e){case"jpeg":b=Canvas2Image.saveAsJPEG(this.canvas,!0,c,d);break;case"png":b=Canvas2Image.saveAsPNG(this.canvas,!0,c,d);break;case"bmp":b=Canvas2Image.saveAsBMP(this.canvas,!0,c,d);break;default:this.error("Unsupported snapshot format: '"+e+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),b=Canvas2Image.saveAsJPEG(this.canvas,!0,c,d)}return b.src},readPixels:function(a,b,c,d){return this.scene._renderer.readPixels(a,b,c,d)},_props:{backgroundColor:{set:function(a){if(a){if((this._backgroundColor=this._backgroundColor||new xeogl.math.vec4).set(a||[0,0,0,1]),!this._backgroundImageSrc){var b="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=b}}else this._backgroundColor=null;this.fire("backgroundColor",this._backgroundColor)},get:function(){return this._backgroundColor}},backgroundImage:{set:function(a){if(a){if(!xeogl._isString(a))return void this.error("Value for 'backgroundImage' should be a string");if(a!==this._backgroundImageSrc){if(this._backgroundElement.style.backgroundImage="url('"+a+"')",this._backgroundImageSrc=a,!this._backgroundImageSrc){var b="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=b}this.fire("backgroundImage",this._backgroundImageSrc)}}},get:function(){return this._backgroundImageSrc}},spinner:{get:function(){return this._spinner}},fullscreen:{set:function(a){(a=!!a)!==Document.fullScreen&&(a?this.canvas.requestFullScreen?this.canvas.requestFullScreen():this.canvas.webkitRequestFullScreen?this.canvas.webkitRequestFullScreen():this.canvas.mozRequestFullScreen&&this.canvas.mozRequestFullScreen():document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),this.fire("fullscreen",Document.fullScreen))},get:function(){return Document.fullScreen}}},_destroy:function(){this.scene.off(this._tick)}})}(),function(){"use strict";var a=!1;xeogl.Spinner=xeogl.Component.extend({type:"xeogl.Spinner",serializable:!1,_init:function(a){this._canvas=a.canvas,this._injectSpinnerCSS();var b=document.createElement("div"),c=b.style;c["z-index"]="9000",c.position="absolute",b.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(b),this._element=b,this._adjustPosition(),this.processes=0,this.textures=a.textures},_props:{textures:{set:function(a){a=!1!==a,this._textures=a,this.fire("textures",this._textures)},get:function(){return this._textures}},processes:{set:function(a){a=a||0,this._processes!==a&&(a<0||(this._processes=a,this._element.style.visibility=this._processes>0?"visible":"hidden",this.fire("processes",this._processes)))},get:function(){return this._processes}}},_adjustPosition:function(){if(this._canvas&&this._element){var a=this._canvas,b=this._element,c=b.style;c.left=a.offsetLeft+.5*a.clientWidth-.5*b.clientWidth+"px",c.top=a.offsetTop+.5*a.clientHeight-.5*b.clientHeight+"px"}},_injectSpinnerCSS:function(){if(!a){var b=document.createElement("style");b.innerHTML=this._spinnerCSS,document.body.appendChild(b),a=!0}},_spinnerCSS:".sk-fading-circle {        margin: 100px auto;        width: 100px;        height:100px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }"})}(),function(){"use strict";xeogl.Clip=xeogl.Component.extend({type:"xeogl.Clip",_init:function(a){this._state={active:!0,pos:new Float32Array(3),dir:new Float32Array(3)},this.active=a.active,this.pos=a.pos,this.dir=a.dir},_props:{active:{set:function(a){this._state.active=!1!==a,this.fire("active",this._state.active)},get:function(){return this._state.active}},pos:{set:function(a){this._state.pos.set(a||[0,0,0]),this._renderer.imageDirty=!0,this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},dir:{set:function(a){this._state.dir.set(a||[0,0,-1]),this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}}},_getJSON:function(){return{active:this._state.active,dir:xeogl.math.vecToArray(this._state.dir),pos:xeogl.math.vecToArray(this._state.pos)}}})}(),function(){"use strict";xeogl.Clips=xeogl.Component.extend({type:"xeogl.Clips",_init:function(a){this._state=new xeogl.renderer.Clips({clips:[],hash:""}),this._dirty=!0,this._clips=[],this._dirtySubs=[],this._destroyedSubs=[],this.clips=a.clips},_props:{clips:{set:function(a){function b(){h.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=h._clips.length;b<c;b++)if(h._clips[b].id===a)return h._clips=h._clips.slice(b,b+1),h._dirtySubs=h._dirtySubs.slice(b,b+1),h._destroyedSubs=h._destroyedSubs.slice(b,b+1),h._dirty=!0,h.fire("dirty",!0),void h.fire("clips",h._clips)}a=a||[];var d,e,f,g;for(e=0,f=this._clips.length;e<f;e++)d=this._clips[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._clips=[],this._dirtySubs=[],this._destroyedSubs=[];var h=this;for(e=0,f=a.length;e<f;e++)d=a[e],!xeogl._isString(d)||(g=d,d=this.components[g])?"xeogl.Clip"===d.type?(this._clips.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+xeogl._inQuotes(g)+" is not a xeogl.Clip"):this.error("Component not found: "+xeogl._inQuotes(g));this._dirty=!0,this.fire("dirty",!0),this.fire("clips",this._clips)},get:function(){return this._clips.slice(0,this._clips.length)}}},_compile:function(){var a=this._state;if(this._dirty){a.clips=[];for(var b=0,c=this._clips.length;b<c;b++)a.clips.push(this._clips[b]._state);this._makeHash(),this._dirty=!1}this._renderer.clips=a},_makeHash:function(){var a=this._state.clips;if(0===a.length)return";";for(var b=[],c=0,d=a.length;c<d;c++)a[c],b.push("cp");b.push(";"),this._state.hash=b.join("")},_getJSON:function(){for(var a=[],b=0,c=this._clips.length;b<c;b++)a.push(this._clips[b].id);return{clips:a}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Configs=xeogl.Component.extend({type:"xeogl.Configs",_init:function(a){this.props={};for(var b in a)a.hasOwnProperty(b)&&this.set(b,a[b])},set:function(a,b){this.props[a]=b,this.fire(a,b)},_toJSON:function(){return xeogl._copy(this.props)}})}(),function(){"use strict";xeogl.InputControl=xeogl.Component.extend({type:"xeogl.InputControl",exclusive:!0,_init:function(a){this._boundaryHelper=new xeogl.Entity(this,{camera:a.camera,geometry:new xeogl.AABBGeometry(this),material:new xeogl.PhongMaterial({diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),visible:!1,collidable:!1}),this._cameraFlight=new xeogl.CameraFlightAnimation(this,{camera:a.camera,duration:.5}),this.firstPerson=a.firstPerson,this.walking=a.walking,this.doublePickFlyTo=a.doublePickFlyTo,this.camera=a.camera,this._initEvents()},_props:{firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},walking:{set:function(a){a=!!a,this._walking=a,this.fire("walking",this._walking)},get:function(){return this._walking}},doublePickFlyTo:{set:function(a){this._doublePickFlyTo=!1!==a,this.fire("doublePickFlyTo",this._doublePickFlyTo)},get:function(){return this._doublePickFlyTo}},camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0,onAdded:this._transformUpdated,onAddedScope:this});var b=this._attached.camera;this._boundaryHelper.camera=b},get:function(){return this._attached.camera}}},_getJSON:function(){var a={firstPerson:this._firstPerson,walking:this._walking,doublePickFlyTo:this._doublePickFlyTo};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1},_initEvents:function(){var b=this,c=this.scene,d=xeogl.math,e=this.scene.canvas.overlay;e.oncontextmenu=function(a){a.preventDefault()};var f=function(){var b=new Float32Array(2);return function(c){if(c){for(var d=c.target,e=0,f=0;d.offsetParent;)e+=d.offsetLeft,f+=d.offsetTop,d=d.offsetParent;b[0]=c.pageX-e,b[1]=c.pageY-f}else c=window.event,b[0]=c.x,b[a]=c.y;return b}}();!function(){function a(){var a=c.worldBoundary.aabb,b=a[3]-a[0],d=a[4]-a[1],e=a[5]-a[2],f=b>d?b:d;return(f=e>f?e:f)/30}var g=.4,h=.2,i=.3,j=.2,k=.85,l=0,m=0,n=0,o=0,p=0,q=!1,r=!1,s=!1,t={},u=.001,v=function(){var a=new Float32Array(3);return function(){var c=b.camera.view;return d.lenVec3(d.subVec3(c.look,c.eye,a))}}();c.on("tick",function(){var a=b.camera.view;if(l*=k,m*=k,Math.abs(l)<u&&(l=0),Math.abs(m)<u&&(m=0),0!==l&&(b._firstPerson?a.rotateLookX(-l):a.rotateEyeX(l)),0!==m&&(b._firstPerson?a.rotateLookY(m):a.rotateEyeY(m)),n*=k,o*=k,Math.abs(n)<u&&(n=0),Math.abs(o)<u&&(o=0),0!==n||0!==o){var c=v()/80;if(b._firstPerson&&b._walking){var d=a.eye[1];a.pan([n*c,o*c,0]);var e=a.eye;e[1]=d,a.eye=e}else a.pan([n*c,o*c,0])}if(p*=k,Math.abs(p)<u&&(p=0),0!==p)if(b._firstPerson){var d;if(b._walking&&(d=a.eye[1]),a.pan([0,0,p]),b._walking){var e=a.eye;e[1]=d,a.eye=e}}else a.zoom(p)}),document.addEventListener("keydown",function(a){"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(q=a.ctrlKey||17===a.keyCode||a.metaKey,r=a.altKey||18===a.keyCode,s=16===a.keyCode,t[a.keyCode]=!0)},!0),document.addEventListener("keyup",function(a){"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&((a.ctrlKey||17===a.keyCode)&&(q=!1),(a.altKey||18===a.keyCode)&&(r=!1),16===a.keyCode&&(s=!1),t[a.keyCode]=!1)}),function(){var b,d,i,j,k,q=0,r=0,t=!1,u=!1;e.addEventListener("mousedown",function(a){if(u)switch(a.which){case 1:i=!0,i=!0,t=!0,q=0,r=0;var c=f(a);b=c[0],d=c[1];break;case 2:j=!0;break;case 3:k=!0}}),e.addEventListener("mouseup",function(a){switch(a.which){case 1:i=!1;break;case 2:j=!1;break;case 3:k=!1}t=!1,q=0,r=0}),e.addEventListener("mouseenter",function(){u=!0,q=0,r=0}),e.addEventListener("mouseleave",function(){u=!1,q=0,r=0}),e.addEventListener("mousemove",function(a){if(u&&t){var c=f(a),e=c[0],h=c[1];q+=(e-b)*g,r+=(h-d)*g,b=e,d=h}}),c.on("tick",function(){
0===Math.abs(q)&&0===Math.abs(r)||(s||j||i&&k?(n=q*h,o=r*h):(m=-q*g,l=r*g),q=0,r=0)}),e.addEventListener("wheel",function(b){var c=Math.max(-1,Math.min(1,40*-b.deltaY));if(0!==c){var d=c/Math.abs(c);p=-d*a()*.8}})}(),function(){function b(a){var b=Date.now();return u===t?(u=a,!0):u===a?b-v>s:(u=a,v=b,!1)}var c,f=new Float32Array(2),g=-1,h=[],k=0,q=new Float32Array(2),r=new Float32Array(2),s=50,t=0,u=t,v=Date.now();e.addEventListener("touchstart",function(a){var b=a.touches,d=a.changedTouches;for(c=Date.now(),1===b.length&&1===d.length?(g=c,f[0]=b[0].pageX,f[1]=b[0].pageY):g=-1;h.length<b.length;)h.push(new Float32Array(2));for(var e=0,i=b.length;e<i;++e)h[e][0]=b[e].pageX,h[e][1]=b[e].pageY;u=t,k=b.length,a.preventDefault(),a.stopPropagation()}),e.addEventListener("touchmove",function(c){var e=c.touches;if(1===k){var f=e[0];if(b(1)){var g=f.pageX-h[0][0],s=f.pageY-h[0][1],t=g*i;l=s*i,m=-t}}else if(2===k){var f=e[0],u=e[1];d.subVec2([f.pageX,f.pageY],h[0],q),d.subVec2([u.pageX,u.pageY],h[1],r);var v=d.dotVec2(q,r)>0;if(v&&b(2)&&(d.subVec2([f.pageX,f.pageY],h[0],q),n=q[0]*j,o=q[1]*j),!v&&b(4)){var w=d.distVec2([f.pageX,f.pageY],[u.pageX,u.pageY]),x=d.distVec2(h[0],h[1]);p=(x-w)*a()*.05}}for(var y=0;y<k;++y)h[y][0]=e[y].pageX,h[y][1]=e[y].pageY;c.preventDefault(),c.stopPropagation()})}()}(),function(){function a(){if(i||j){if(k=!1,l=!1,g=j||b.hasSubs("hoverSurface")?c.pick({pickSurface:!0,canvasPos:h}):c.pick({canvasPos:h})){k=!0;var a=g.entity.id;f!==a&&(void 0!==f&&b.fire("hoverOut",g),b.fire("hover",g),f=a),g.worldPos&&(l=!0,b.fire("hoverSurface",g))}else void 0!==f&&(b.fire("hoverOut",g),f=void 0),b.fire("hoverOff",{canvasPos:h});i=!1,j=!1}}function d(a,b){if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b[0]=a.pageX-d,b[1]=a.pageY-e}else a=window.event,b[0]=a.x,b[1]=a.y}var f,g,h=[0,0],i=!1,j=!1,k=!1,l=!1;c.on("tick",a),function(){e.addEventListener("mousemove",function(a){d(a,h),(b.hasSubs("hover")||b.hasSubs("hoverOut")||b.hasSubs("hoverOff")||b.hasSubs("hoverSurface"))&&(i=!0)});var c,f;e.addEventListener("mousedown",function(a){c=a.clientX,f=a.clientY}),e.addEventListener("mouseup",function(d){var e,h=0;return function(d){if(!(Math.abs(d.clientX-c)>3||Math.abs(d.clientY-f)>3)){if(!(b._doublePickFlyTo||b.hasSubs("doublePickedObject")||b.hasSubs("doublePickedSurface")||b.hasSubs("doublePickedNothing")))return j=!!b.hasSubs("pickedSurface"),a(),void(g?(b.fire("pickedObject",g),l&&b.fire("pickedSurface",g)):b.fire("pickedNothing"));h++,1==h?e=setTimeout(function(){j=!!b.hasSubs("pickedSurface"),a(),g?(b.fire("pickedObject",g),l&&b.fire("pickedSurface",g)):b.fire("pickedNothing"),h=0},250):(clearTimeout(e),j=!!b.hasSubs("doublePickedSurface"),a(),g?(b.fire("doublePickedObject",g),l&&b.fire("doublePickedSurface",g),b._doublePickFlyTo&&b._flyTo(g)):(b.fire("doublePickedNothing"),b._doublePickFlyTo&&b._flyTo()),h=0)}}}(),!1)}(),function(){var c,d=150,f=325,k=4,m=[],n=new Float32Array(2),o=-1,p=-1;e.addEventListener("touchstart",function(a){var b=a.touches,d=a.changedTouches;for(c=Date.now(),1===b.length&&1===d.length?(o=c,n[0]=b[0].pageX,n[1]=b[0].pageY):o=-1;m.length<b.length;)m.push(new Float32Array(2));for(var e=0,f=b.length;e<f;++e)m[e][0]=b[e].pageX,m[e][1]=b[e].pageY;m.length=b.length,a.preventDefault(),a.stopPropagation()}),e.addEventListener("touchend",function(c){var e=Date.now(),q=c.touches,r=c.changedTouches;0===q.length&&1===r.length&&o>-1&&e-o<d&&(p>-1&&o-p<f?(h[0]=Math.round(r[0].clientX),h[1]=Math.round(r[0].clientY),i=!0,j=!!b.hasSubs("pickedSurface"),a(),g?(b.fire("doublePickedObject",g),l&&b.fire("doublePickedSurface",g),b._doublePickFlyTo&&b._flyTo(g)):(b.fire("doublePickedNothing"),b._doublePickFlyTo&&b._flyTo()),p=-1):xeogl.math.distVec2(m[0],n)<k&&(h[0]=Math.round(r[0].clientX),h[1]=Math.round(r[0].clientY),i=!0,j=!!b.hasSubs("pickedSurface"),a(),g?(b.fire("pickedObject",g),l&&b.fire("pickedSurface",g)):b.fire("pickedNothing"),p=e),o=-1),m.length=q.length;for(var s=0,t=q.length;s<t;++s)m[s][0]=q[s].pageX,m[s][1]=q[s].pageY;c.preventDefault(),c.stopPropagation()})}()}(),function(){document.addEventListener("keydown",function(a){switch(a.keyCode){case 49:viewer.viewFitRight();break;case 50:viewer.viewFitBack();break;case 51:viewer.viewFitLeft();break;case 52:viewer.viewFitFront();break;case 53:viewer.viewFitTop();break;case 54:viewer.viewFitBottom();break;default:return}})}()},_flyTo:function(a){var b;a&&a.worldPos&&(b=a.worldPos);var c=a?a.entity.worldBoundary:this.scene.worldBoundary,d=c.aabb;if(this._boundaryHelper.geometry.aabb=d,b){var e=this.camera.view;xeogl.math.subVec3(e.eye,e.look,[]);this._cameraFlight.flyTo({look:b,aabb:d},this._hideBoundary,this)}else this._cameraFlight.flyTo({aabb:d},this._hideBoundary,this)},_hideBoundary:function(){}})}(),function(){"use strict";xeogl.CameraControl=xeogl.Component.extend({type:"xeogl.CameraControl",exclusive:!0,_init:function(a){this._boundaryHelper=this.create({type:"xeogl.Entity",camera:a.camera,geometry:this.create({type:"xeogl.AABBGeometry"}),material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),visible:!1,collidable:!1}),this.keyboardAxis=this.create({type:"xeogl.KeyboardAxisCamera",camera:a.camera}),this.keyboardRotate=this.create({type:"xeogl.KeyboardRotateCamera",camera:a.camera}),this.mouseRotate=this.create({type:"xeogl.MouseRotateCamera",camera:a.camera}),this.keyboardPan=this.create({type:"xeogl.KeyboardPanCamera",camera:a.camera}),this.mousePan=this.create({type:"xeogl.MousePanCamera",camera:a.camera}),this.keyboardZoom=this.create({type:"xeogl.KeyboardZoomCamera",camera:a.camera}),this.mouseZoom=this.create({type:"xeogl.MouseZoomCamera",camera:a.camera}),this.mousePickEntity=this.create({type:"xeogl.MousePickEntity",pickSurface:!0}),this.mousePickEntity.on("pick",this._entityPicked,this),this.mousePickEntity.on("nopick",function(){var a=this.scene.worldBoundary.aabb;this._boundaryHelper.geometry.aabb=a,this.cameraFlight.flyTo({aabb:a,fitFOV:45},this._hideEntityBoundary,this)},this),this.cameraFlight=this.create({type:"xeogl.CameraFlightAnimation",camera:a.camera,duration:.5}),this.firstPerson=a.firstPerson,this.camera=a.camera,this.active=!1!==a.active},_entityPicked:function(a){var b;a.worldPos&&(b=a.worldPos);var c=a.entity.worldBoundary,d=c.aabb;if(this._boundaryHelper.geometry.aabb=d,b){var e=this.camera.view;xeogl.math.subVec3(e.eye,e.look,[]);this.cameraFlight.flyTo({look:b,aabb:d},this._hideEntityBoundary,this)}else this.cameraFlight.flyTo({aabb:d},this._hideEntityBoundary,this)},_hideEntityBoundary:function(){this._boundaryHelper.visible=!1},_props:{firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.keyboardRotate.firstPerson=a,this.mouseRotate.firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0,onAdded:this._transformUpdated,onAddedScope:this});var b=this._attached.camera;this._boundaryHelper.camera=b,this.keyboardAxis.camera=b,this.keyboardRotate.camera=b,this.mouseRotate.camera=b,this.keyboardPan.camera=b,this.mousePan.camera=b,this.keyboardZoom.camera=b,this.mouseZoom.camera=b,this.cameraFlight.camera=b},get:function(){return this._attached.camera}},active:{set:function(a){a=!!a,this._active!==a&&(this.keyboardAxis.active=a,this.keyboardRotate.active=a,this.mouseRotate.active=a,this.keyboardPan.active=a,this.mousePan.active=a,this.keyboardZoom.active=a,this.mouseZoom.active=a,this.mousePickEntity.active=a,this.cameraFlight.active=a,this.fire("active",this._active=a))},get:function(){return this._active}}},_getJSON:function(){var a={firstPerson:this._firstPerson,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.CameraController=xeogl.Component.extend({type:"xeogl.CameraController",_init:function(a){this.camera=a.camera,this.active=!1!==a.active},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0,onAddedScope:this})},get:function(){return this._attached.camera}},active:{set:function(a){a=!!a,this._active!==a&&(this._active=a,this.fire("active",this._active))},get:function(){return this._active}}},_getJSON:function(){var a={active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardAxisCamera=xeogl.Component.extend({type:"xeogl.KeyboardAxisCamera",_init:function(a){this._onKeyDown=null,this._cameraFly=new xeogl.CameraFlightAnimation(this.scene,{camera:a.camera,duration:1}),this.camera=a.camera,this.active=!1!==a.active},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0}),this._cameraFly.camera=this._attached.camera},get:function(){return this._attached.camera}},active:{set:function(a){if(a=!!a,this._active!==a){this._cameraFly.active=a;var b=this,c=this.scene.input;a?this._onKeyDown=c.on("keydown",function(a){b._attached.camera&&c.mouseover&&(a!==c.KEY_NUM_1&&a!==c.KEY_NUM_2&&a!==c.KEY_NUM_3&&a!==c.KEY_NUM_4&&a!==c.KEY_NUM_5&&a!==c.KEY_NUM_6||xeogl.scheduleTask(function(){b._fly(a)}))}):this.scene.off(this._onKeyDown),this.fire("active",this._active=a)}},get:function(){return this._active}}},_fly:function(a){var b=this.scene.input,c=this.scene.worldBoundary,d=c.aabb,e=c.center,f=xeogl.math.getAABB3Diag(d);this._fitFOV=55;var g=Math.abs(f/Math.tan(this._fitFOV/2));switch(a){case b.KEY_NUM_1:this._cameraFly.flyTo({look:e,eye:[e[0]-g,e[1],e[2]],up:[0,1,0]});break;case b.KEY_NUM_2:this._cameraFly.flyTo({look:e,eye:[e[0],e[1],e[2]+g],up:[0,1,0]});break;case b.KEY_NUM_3:this._cameraFly.flyTo({look:e,eye:[e[0]+g,e[1],e[2]],up:[0,1,0]});break;case b.KEY_NUM_4:this._cameraFly.flyTo({look:e,eye:[e[0],e[1],e[2]-g],up:[0,1,0]});break;case b.KEY_NUM_5:this._cameraFly.flyTo({look:e,eye:[e[0],e[1]-g,e[2]],up:[0,0,-1]});break;case b.KEY_NUM_6:this._cameraFly.flyTo({look:e,eye:[e[0],e[1]+g,e[2]],up:[0,0,1]})}},_getJSON:function(){var a={active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1,this._cameraFly.destroy()}})}(),function(){"use strict";xeogl.KeyboardRotateCamera=xeogl.Component.extend({type:"xeogl.KeyboardRotateCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.active=!1!==a.active,this.sensitivity=a.sensitivity},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||1,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._attached.camera;if(d&&b.mouseover){var e=a.deltaTime,f=.3*c._sensitivity,g=.3*c._sensitivity;if(!b.ctrlDown&&!b.altDown){var h=b.keyDown[b.KEY_LEFT_ARROW],i=b.keyDown[b.KEY_RIGHT_ARROW],j=b.keyDown[b.KEY_UP_ARROW],k=b.keyDown[b.KEY_DOWN_ARROW];if(h||i||j||k){var l=0,m=0;i?l=-e*f:h&&(l=e*f),k?m=e*g:j&&(m=-e*g),Math.abs(l)>Math.abs(m)?m=0:l=0,0!==l&&d.view.rotateEyeY(l),0!==m&&d.view.rotateEyeX(m)}}}})}else this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardPanCamera=xeogl.Component.extend({type:"xeogl.KeyboardPanCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=!1!==a.active},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._attached.camera;if(d&&b.mouseover){var e=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=b.keyDown[b.KEY_W],g=b.keyDown[b.KEY_S],h=b.keyDown[b.KEY_A],i=b.keyDown[b.KEY_D],j=b.keyDown[b.KEY_Z],k=b.keyDown[b.KEY_X];if(f||g||h||i||k||j){var l=0,m=0,n=0,o=.01*c._sensitivity;g?m=e*o:f&&(m=-e*o),i?l=e*o:h&&(l=-e*o),k?n=e*o:j&&(n=-e*o),d.view.pan([l,m,n])}}}})}else this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.KeyboardZoomCamera=xeogl.Component.extend({type:"xeogl.KeyboardZoomCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=!1!==a.active},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._attached.camera;if(d&&b.mouseover){var e=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=b.keyDown[b.KEY_ADD],g=b.keyDown[b.KEY_SUBTRACT];if(f||g){var h=0,i=.01*c.sensitivity;g?h=e*i:f&&(h=-e*i),d.view.zoom(h)}}}})}else null!==this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MouseRotateCamera=xeogl.Component.extend({type:"xeogl.MouseRotateCamera",_init:function(a){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=!1!==a.active},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e,f=0,g=0,h=!1,i=!1;this._onMouseDown=b.on("mousedown",function(a){b.mouseover&&(f=0,g=0,i&&(!b.mouseDownLeft||b.mouseDownRight||b.keyDown[b.KEY_SHIFT]||b.mouseDownMiddle?h=!1:(h=!0,c=a[0],d=a[1])))},this),this._onMouseUp=b.on("mouseup",function(){h=!1,f=0,g=0}),this._onMouseEnter=b.on("mouseenter",function(){i=!0,f=0,g=0}),this._onMouseLeave=b.on("mouseleave",function(){i=!1,f=0,g=0}),this._onMouseMove=b.on("mousemove",function(a){if(i&&h){var b=(a[0]-c)*this._sensitivity,f=(a[1]-d)*this._sensitivity;c=a[0],d=a[1];var g=this._attached.camera;g&&i&&h&&(0!==b&&(e=-b*this._sensitivity,this._firstPerson?g.view.rotateLookY(e):g.view.rotateEyeY(e)),0!==f&&(e=f*this._sensitivity,this._firstPerson?g.view.rotateLookX(-e):g.view.rotateEyeX(e)))}},this)}else b.off(this._onTick),b.off(this._onMouseDown),b.off(this._onMouseUp),b.off(this._onMouseMove),b.off(this._onMouseEnter),b.off(this._onMouseLeave);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MousePanCamera=xeogl.Component.extend({type:"xeogl.MousePanCamera",_init:function(a){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=!1!==a.active},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a?.03*a:.03,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=0,f=0,g=!1,h=this;this._onTick=this.scene.on("tick",function(){var a=h._attached.camera;a&&(0===e&&0===f||(a.view.pan([e,f,0]),e=0,f=0))}),this._onMouseDown=b.on("mousedown",function(a){b.mouseDownLeft&&b.mouseDownRight||b.mouseDownLeft&&b.keyDown[b.KEY_SHIFT]||b.mouseDownMiddle?(c=a[0],d=a[1],g=!0):g=!1}),this._onMouseUp=b.on("mouseup",function(){g=!1}),this._onMouseUp=b.on("mouseout",function(){g=!1}),this._onMouseMove=b.on("mousemove",function(a){g&&(e+=(a[0]-c)*h._sensitivity,f+=(a[1]-d)*h._sensitivity,c=a[0],d=a[1])})}else b.off(this._onTick),b.off(this._onMouseDown),b.off(this._onMouseUp),b.off(this._onMouseMove);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MousePickEntity=xeogl.Component.extend({type:"xeogl.MousePickEntity",_init:function(a){this.pickSurface=a.pickSurface,this.active=!1!==a.active},_props:{active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=this,f=2,g=!1,h=!1;this._onMouseEnter=b.on("mouseenter",function(){g=!0}),this._onMouseLeave=b.on("mouseleave",function(){g=!1}),this._onMouseDown=b.on("mousedown",function(a){g&&(h=!0,c=a[0],d=a[1])}),this._onMouseUp=b.on("mouseup",function(a){if(h&&g){if(c>=a[0]-f&&c<=a[0]+f&&d>=a[1]-f&&d<=a[1]+f){var b=e.scene.pick({canvasPos:a,pickSurface:e._pickSurface});b?e.fire("pick",b):e.fire("nopick",{canvasPos:a})}h=!1}})}else b.off(this._onMouseDown),b.off(this._onMouseUp);this.fire("active",this._active=a)}},get:function(){return this._active}},pickSurface:{set:function(a){a=!!a,this._pickSurface!==a&&(this._dirty=!1,this.fire("pickSurface",this._pickSurface=a))},get:function(){return this._pickSurface}}},_getJSON:function(){return{pickSurface:this._pickSurface,active:this._active}},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.MouseZoomCamera=xeogl.Component.extend({type:"xeogl.MouseZoomCamera",_init:function(a){this._onTick=null,this._onMouseWheel=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=!1!==a.active},_props:{camera:{set:function(a){this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0})},get:function(){return this._attached.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){if(a){var b=0,c=0,d=!1,e=!1,f=0,g=xeogl.math.vec3(),h=xeogl.math.vec3(),i=xeogl.math.vec3(),j=this;this._onMouseWheel=this.scene.input.on("mousewheel",function(a){b=a,0===b?(e=!1,d=!1):d=!0}),this._onTick=this.scene.on("tick",function(){var a=j._attached.camera;if(a){var k=a.view.eye,l=a.view.look;g[0]=k[0],g[1]=k[1],g[2]=k[2],h[0]=l[0],h[1]=l[1],h[2]=l[2],xeogl.math.subVec3(g,h,i);var m=Math.abs(xeogl.math.lenVec3(i)),n=1e3,o=j._sensitivity*(2+m/n);d&&(c=b*o,f=0,d=!1,e=!0),e&&(b>0?(f+=.2*o)>c&&(e=!1):b<0&&(f-=.2*o)<c&&(e=!1),e&&(a.view.zoom(f),a.project.isType("xeogl.Ortho")))}})}else null!==this._onTick&&(this.scene.off(this._onTick),this.scene.input.off(this._onMouseWheel));this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._attached.camera&&(a.camera=this._attached.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";xeogl.Geometry=xeogl.Component.extend({type:"xeogl.Geometry",_init:function(a){var b=this;this._state=new xeogl.renderer.Geometry({usage:null,primitive:null,primitiveName:null,positions:null,colors:null,normals:null,uv:null,tangents:null,indices:null,autoNormals:!1,hash:"",getTangents:function(){return b._tangentsDirty&&b._buildTangents(),b._tangents},getPickPositions:function(){return b._pickVBOsDirty&&b._buildPickVBOs(),b._pickPositions},getPickColors:function(){return b._pickVBOsDirty&&b._buildPickVBOs(),b._pickColors}}),this._positions=null,this._positionsUpdate=null,this._positionsUpdateOffset=0,this._normals=null,this._normalsUpdate=null,this._normalsUpdateOffset=0,this._colors=null,this._colorsUpdate=null,this._colorsUpdateOffset=0,this._uvs=null,this._uvsUpdate=null,this._uvsUpdateOffset=0,this._tangentsData=null,this._tangentsUpdate=null,this._tangentsUpdateOffset=0,this._indices=null,this._tangents=null,this._pickPositions=null,this._pickColors=null,this._updateScheduled=!1,this._geometryUpdateScheduled=!1,this._hashDirty=!0,this._positionsDirty=!0,this._colorsDirty=!0,this._normalsDirty=!0,this._uvDirty=!0,this._tangentsDirty=!0,this._indicesDirty=!0,this._pickVBOsDirty=!0,this._localBoundary=null,this._boundaryDirty=!0,a.positions||a.normals||a.uv||a.indices?(this.primitive=a.primitive,this.positions=a.positions,this.colors=a.colors,this.normals=a.normals,this.uv=a.uv,this.tangents=a.tangents,this.indices=a.indices):this.primitive=a.primitive,this.autoNormals=a.autoNormals,this.usage=a.usage,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._scheduleGeometryUpdate,this),xeogl.stats.memory.meshes++},_needUpdate:function(){this._updateScheduled||(this._updateScheduled=!0,xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._geometryUpdateScheduled=!0,this._update&&this._update(),this._updateScheduled=!1),this._geometryUpdateScheduled&&this._updateGeometry()},_scheduleGeometryUpdate:function(){this._geometryUpdateScheduled||(this._geometryUpdateScheduled=!0,xeogl.scheduleTask(this._updateGeometry,this))},_updateGeometry:function(){var a=this._state;if(this._updateScheduled)this._update&&(this._geometryUpdateScheduled=!0,this._update()),this._updateScheduled=!1,this._geometryUpdateScheduled=!0;else if(!this._geometryUpdateScheduled)return;var b=this.scene.canvas.gl,c=xeogl.stats.memory,d=!1;this._positionsDirty&&(this._positionsUpdate?a.positions?null===this._positionsUpdateOffset&&this._positionsUpdate.length===a.positions.length?a.positions.setData(this._positionsUpdate):null===this._positionsUpdateOffset?(a.positions&&(c.positions-=a.positions.numItems,a.positions.destroy()),a.positions=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._positions,this._positions.length,3,a.usage),c.positions+=a.positions.numItems):this._positionsUpdateOffset+this._positionsUpdate.length<=a.positions.length?a.positions.setData(this._positionsUpdate,this._positionsUpdateOffset):(c.positions-=a.positions.numItems,a.positions.destroy(),a.positions=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._positions,this._positions.length,3,a.usage),c.positions+=a.positions.numItems):(a.positions=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._positions,this._positions.length,3,a.usage),c.positions+=a.positions.numItems):a.positions&&(c.positions-=a.positions.numItems,a.positions.destroy()),this._positionsDirty=!1,this._tangentsDirty=!0,this._pickVBOsDirty=!0,a.autoNormals&&(this._normalsDirty=!0),d=!0),this._colorsDirty&&(this._colorsUpdate?a.colors?null===this._colorsUpdateOffset&&this._colorsUpdate.length===a.colors.length?a.colors.setData(this._colorsUpdate):null===this._colorsUpdateOffset?(a.colors&&(c.colors-=a.colors.numItems,a.colors.destroy()),a.colors=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._colors,this._colors.length,4,a.usage),c.colors+=a.colors.numItems):this._colorsUpdateOffset+this._colorsUpdate.length<=a.colors.length?a.colors.setData(this._colorsUpdate,this._colorsUpdateOffset):(c.colors-=a.colors.numItems,a.colors.destroy(),a.colors=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._colors,this._colors.length,4,a.usage),c.colors+=a.colors.numItems):(a.colors=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._colors,this._colors.length,4,a.usage),c.colors+=a.colors.numItems):a.colors&&(c.colors-=a.colors.numItems,a.colors.destroy()),this._colorsDirty=!1),this._uvsDirty&&(this._uvsUpdate?a.uv?null===this._uvsUpdateOffset&&this._uvsUpdate.length===a.uv.length?a.uv.setData(this._uvsUpdate):null===this._uvsUpdateOffset?(a.uv&&(c.uvs-=a.uv.numItems,a.uv.destroy()),a.uv=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._uvs,this._uvs.length,2,a.usage),c.uvs+=a.uv.numItems):this._uvsUpdateOffset+this._uvsUpdate.length<=a.uv.length?a.uv.setData(this._uvsUpdate,this._uvsUpdateOffset):(c.uvs-=a.uv.numItems,a.uv.destroy(),a.uv=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._uvs,this._uvs.length,2,a.usage),c.uvs+=a.uv.numItems):(a.uv=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._uvs,this._uvs.length,2,a.usage),c.uvs+=a.uv.numItems):a.uv&&(c.uvs-=a.uv.numItems,a.uv.destroy()),this._uvsDirty=!1,this._tangentsDirty=!0),this._indicesDirty&&(this._indicesUpdate?a.indices?null===this._indicesUpdateOffset&&this._indicesUpdate.length===a.indices.length?a.indices.setData(this._indicesUpdate):null===this._indicesUpdateOffset?(a.indices&&(c.indices-=a.indices.numItems,a.indices.destroy()),a.indices=new xeogl.renderer.webgl.ArrayBuffer(b,b.ELEMENT_ARRAY_BUFFER,this._indices,this._indices.length,1,a.usage),c.indices+=a.indices.numItems):this._indicesUpdateOffset+this._indicesUpdate.length<=a.indices.length?a.indices.setData(this._indicesUpdate,this._indicesUpdateOffset):(c.indices-=a.indices.numItems,a.indices.destroy(),a.indices=new xeogl.renderer.webgl.ArrayBuffer(b,b.ELEMENT_ARRAY_BUFFER,this._indices,this._indices.length,1,a.usage),c.indices+=a.indices.numItems):(a.indices=new xeogl.renderer.webgl.ArrayBuffer(b,b.ELEMENT_ARRAY_BUFFER,this._indices,this._indices.length,1,a.usage),c.indices+=a.indices.numItems):a.indices&&(c.indices-=a.indices.numItems,a.indices.destroy()),this._indicesDirty=!1,this._tangentsDirty=!0,this._pickVBOsDirty=!0,a.autoNormals&&(this._normalsDirty=!0),d=!0),this._normalsDirty&&(a.autoNormals&&this._positions&&this._indices&&(this._normals=xeogl.math.buildNormals(this._positions,this._indices,this._normals),this._normalsDirty=!1,this._tangentsDirty=!0,this._normalsUpdate=this._normals,this._normalsUpdateOffset=null),this._normalsUpdate?a.normals?null===this._normalsUpdateOffset&&this._normalsUpdate.length===a.normals.length?a.normals.setData(this._normalsUpdate):null===this._normalsUpdateOffset?(a.normals&&(c.normals-=a.normals.numItems,a.normals.destroy()),a.normals=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._normals,this._normals.length,3,a.usage),c.normals+=a.normals.numItems):this._normalsUpdateOffset+this._normalsUpdate.length<=a.normals.length?a.normals.setData(this._normalsUpdate,this._normalsUpdateOffset):(c.normals-=a.normals.numItems,a.normals.destroy(),a.normals=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._normals,this._normals.length,3,a.usage),c.normals+=a.normals.numItems):(a.normals=new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._normals,this._normals.length,3,a.usage),c.normals+=a.normals.numItems):a.normals&&(c.normals-=a.normals.numItems,a.normals.destroy()),this._normalsDirty=!1,this._tangentsDirty=!0,d=!0),this._geometryUpdateScheduled=!1,d&&this._setBoundaryDirty()},_buildTangents:function(){if(this._tangentsDirty){(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate();var a=xeogl.stats.memory;if(this._tangents&&(a.tangents-=this._tangents.numItems,this._tangents.destroy()),!this._positions||!this._indices||!this._uvs)return null;this._tangentsData=xeogl.math.buildTangents(this._positions,this._indices,this._uvs);var b=this.scene.canvas.gl;this._tangents=this._tangentsData?new xeogl.renderer.webgl.ArrayBuffer(b,b.ARRAY_BUFFER,this._tangentsData,this._tangentsData.length,3,this._state.usage):null,this._tangents&&(a.tangents+=this._tangents.numItems),this._tangentsDirty=!1}},_buildPickVBOs:function(){if(this._pickVBOsDirty){if((this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),this._destroyPickVBOs(),this._positions&&this._indices){var a=this.scene.canvas.gl,b=xeogl.math.buildPickTriangles(this._positions,this._indices),c=b.positions,d=b.colors;this._pickPositions=new xeogl.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,c,c.length,3,this._state.usage),this._pickColors=new xeogl.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,d,d.length,4,this._state.usage);var e=xeogl.stats.memory;e.positions+=this._pickPositions.numItems,e.colors+=this._pickColors.numItems}this._pickVBOsDirty=!1}},_destroyPickVBOs:function(){var a=xeogl.stats.memory;this._pickPositions&&(this._pickPositions.destroy(),a.positions-=this._pickPositions.numItems,this._pickPositions=null),this._pickColors&&(this._pickColors.destroy(),a.colors-=this._pickColors.numItems,this._pickColors=null),this._pickVBOsDirty=!0},_props:{usage:{set:function(a){if((a=a||"static")!==this._state.usageName){var b=this.scene.canvas.gl;switch(a){case"static":this._state.usage=b.STATIC_DRAW;break;case"dynamic":this._state.usage=b.DYNAMIC_DRAW;break;case"stream":this._state.usage=b.STREAM_DRAW;break;default:this.error("Unsupported value for 'usage': '"+a+"' - supported values are 'static', 'dynamic' and 'stream'."),this._state.usage=b.STREAM_DRAW,a="static"}this._state.usageName=a,this._positionsDirty=!0,this._colorsDirty=!0,this._normalsDirty=!0,this._uvDirty=!0,this._tangentsDirty=!0,this._indicesDirty=!0,this._scheduleGeometryUpdate(),this.fire("dirty",!0),this.fire("usage",this._state.usageName)}},get:function(){return this._state.usageName}},primitive:{set:function(a){a=a||"triangles";var b=this._state,c=this.scene.canvas.gl;if(a!==b.primitiveName){switch(a){case"points":b.primitive=c.POINTS;break;case"lines":b.primitive=c.LINES;break;case"line-loop":b.primitive=c.LINE_LOOP;break;case"line-strip":b.primitive=c.LINE_STRIP;break;case"triangles":b.primitive=c.TRIANGLES;break;case"triangle-strip":b.primitive=c.TRIANGLE_STRIP;break;case"triangle-fan":b.primitive=c.TRIANGLE_FAN;break;default:this.error("Unsupported value for 'primitive': '"+a+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),b.primitive=c.TRIANGLES,a="triangles"}this._state.primitiveName=a,this._hashDirty=!0,this._renderer.imageDirty=!0,this.fire("dirty",!0),this.fire("primitive",this._state.primitiveName)}},get:function(){return this._state.primitiveName}},positions:{set:function(a){this.setPositions(a,0)},get:function(){return this._updateScheduled&&this._doUpdate(),this._positions}},normals:{set:function(a){this.setNormals(a,0)},get:function(){return this._updateScheduled&&this._doUpdate(),this._normals}},uv:{set:function(a){this.setUVs(a,0)},get:function(){return this._updateScheduled&&this._doUpdate(),this._uvs}},colors:{set:function(a){this.setColors(a,0)},get:function(){return this._updateScheduled&&this._doUpdate(),this._colors}},indices:{set:function(a){this.setIndices(a,0)},get:function(){return this._updateScheduled&&this._doUpdate(),this._indices}},
localBoundary:{get:function(){if(!this._localBoundary){var a=this;this._localBoundary=new xeogl.Boundary3D(this.scene,{getDirty:function(){return!!a._boundaryDirty&&(a._boundaryDirty=!1,!0)},getPositions:function(){return(a._updateScheduled||a._geometryUpdateScheduled)&&a._doUpdate(),a._positions}}),this._localBoundary.on("destroyed",function(){a._localBoundary=null})}return this._localBoundary}},kdtree:{get:function(){return this._indices&&this._positions?(this._kdtree||(this._kdtree=xeogl.math.buildKDTree(this._indices,this._positions)),this._kdtree):void this.error("Can't provide a KD-tree: no indices/positions")}},autoNormals:{set:function(a){a=!!a,this._state.autoNormals!==a&&(this._state.autoNormals=a,this._normalsDirty=!0,this._scheduleGeometryUpdate(),this._hashDirty=!0,this.fire("dirty",!0),this.fire("autoNormals",this._state.autoNormals))},get:function(){return this._state.autoNormals}}},setPositions:function(a,b){var c=!this._positions!=!a;if(a&&0===a.length&&(a=null),a)if(a=a.constructor===Float32Array?a:new Float32Array(a),null!==b&&void 0!==b){if(b<0)return void this.error("setPositions - negative offset not allowed");this._positions&&b+a.length<=this._positions.length?this._positions.set(a,b):this._positions?this._positions=0===b?a:xeogl._concat(this._positions.slice(0,b),a):this._positions=a}else this._positions=a;else this._positions=null;this._positionsUpdate=a,this._positionsUpdateOffset=b,this._positionsDirty=!0,this._scheduleGeometryUpdate(),c&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("positions",this._positions),this.fire("localBoundary",!0),this._renderer.imageDirty=!0},setNormals:function(a,b){var c=!this._normals!=!a;if(a&&0===a.length&&(a=null),a)if(a=a.constructor===Float32Array?a:new Float32Array(a),null!==b&&void 0!==b){if(b<0)return void this.error("setNormals - negative offset not allowed");this._normals&&b+a.length<=this._normals.length?this._normals.set(a,b):this._normals?this._normals=0===b?a:xeogl._concat(this._normals.slice(0,b),a):this._normals=a}else this._normals=a;else this._normals=null;this._normalsUpdate=a,this._normalsUpdateOffset=b,this._normalsDirty=!0,this._scheduleGeometryUpdate(),c&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("normals",this._normals),this._renderer.imageDirty=!0},setUVs:function(a,b){var c=!this._uvs!=!a;if(a&&0===a.length&&(a=null),a)if(a=a.constructor===Float32Array?a:new Float32Array(a),null!==b&&void 0!==b){if(b<0)return void this.error("setUvs - negative offset not allowed");this._uvs&&b+a.length<=this._uvs.length?this._uvs.set(a,b):this._uvs?this._uvs=0===b?a:xeogl._concat(this._uvs.slice(0,b),a):this._uvs=a}else this._uvs=a;else this._uvs=null;this._uvsUpdate=a,this._uvsUpdateOffset=b,this._uvsDirty=!0,this._scheduleGeometryUpdate(),c&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("uvs",this._uvs),this._renderer.imageDirty=!0},setColors:function(a,b){var c=!this._colors!=!a;if(a&&0===a.length&&(a=null),a)if(a=a.constructor===Float32Array?a:new Float32Array(a),null!==b&&void 0!==b){if(b<0)return void this.error("setColors - negative offset not allowed");this._colors&&b+a.length<=this._colors.length?this._colors.set(a,b):this._colors?this._colors=0===b?a:xeogl._concat(this._colors.slice(0,b),a):this._colors=a}else this._colors=a;else this._colors=null;this._colorsUpdate=a,this._colorsUpdateOffset=b,this._colorsDirty=!0,this._scheduleGeometryUpdate(),c&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("colors",this._colors),this._renderer.imageDirty=!0},setIndices:function(a,b){a&&0===a.length&&(a=void 0);var c=xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(a&&!c&&a.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");var d=c?Uint32Array:Uint16Array,e=!this._indices!=!a;if(a)if(a=a.constructor===Uint32Array||a.constructor===Uint16Array?a:new d(a),null!==b&&void 0!==b){if(b<0)return void this.error("setIndices - negative offset not allowed");this._indices&&b+a.length<=this._indices.length?this._indices.set(a,b):this._indices?this._indices=0===b?a:xeogl._concat(this._indices.slice(0,b),a):this._indices=a}else this._indices=a;else this._indices=null;this._indicesUpdate=a,this._indicesUpdateOffset=b,this._indicesDirty=!0,this._scheduleGeometryUpdate(),e&&(this._hashDirty=!0,this.fire("dirty",!0)),this.fire("indices",this._indices),this.fire("localBoundary",!0),this._renderer.imageDirty=!0},_setBoundaryDirty:function(){this._boundaryDirty||(this._boundaryDirty=!0,this._localBoundary&&this._localBoundary.fire("updated",!0))},_compile:function(){(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate(),this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.geometry=this._state},_makeHash:function(){var a=this._state,b=["/g"];b.push("/"+a.primitive+";"),a.positions&&b.push("p"),a.colors&&b.push("c"),(a.normals||a.autoNormals)&&b.push("n"),a.uv&&b.push("u"),b.push(";"),a.hash=b.join("")},_getJSON:function(){(this._updateScheduled||this._geometryUpdateScheduled)&&this._doUpdate();var a={primitive:this._state.primitiveName},b=xeogl.math.vecToArray;return this._positions&&(a.positions=b(this._positions)),this._uvs&&(a.uv=b(this._uvs)),this._colors&&(a.colors=b(this._colors)),this._indices&&(a.indices=b(this._indices)),this._state.autoNormals?a.autoNormals=!0:a.normals=b(this._normals),a},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.positions&&this._state.positions.destroy(),this._state.colors&&this._state.colors.destroy(),this._state.normals&&this._state.normals.destroy(),this._state.uv&&this._state.uv.destroy(),this._state.indices&&this._state.indices.destroy(),this._tangents&&this._tangents.destroy(),this._pickPositions&&this._pickPositions.destroy(),this._pickColors&&this._pickColors.destroy(),this._localBoundary&&this._localBoundary.destroy(),this._state.destroy(),xeogl.stats.memory.meshes--}})}(),function(){"use strict";xeogl.BoxGeometry=xeogl.Geometry.extend({type:"xeogl.BoxGeometry",_init:function(a){this._super(a),this.center=a.center,this.xSize=a.xSize,this.ySize=a.ySize,this.zSize=a.zSize},_update:function(){var a=-this._xSize+this._center[0],b=-this._ySize+this._center[1],c=-this._zSize+this._center[2],d=this._xSize+this._center[0],e=this._ySize+this._center[1],f=this._zSize+this._center[2];this.positions=[d,e,f,a,e,f,a,b,f,d,b,f,d,e,f,d,b,f,d,b,c,d,e,c,d,e,f,d,e,c,a,e,c,a,e,f,a,e,f,a,e,c,a,b,c,a,b,f,a,b,c,d,b,c,d,b,f,a,b,f,d,b,c,a,b,c,a,e,c,d,e,c],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],this.uv=[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],this.tangents=null},_props:{center:{set:function(a){(this._center=this._center||new xeogl.math.vec3).set(a||[0,0,0]),this._needUpdate(),this.fire("center",this._center)},get:function(){return this._center}},xSize:{set:function(a){a=a||1,this._xSize!==a&&(a<0&&(this.warn("negative xSize not allowed - will invert"),a*=-1),this._xSize=a,this._needUpdate(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},ySize:{set:function(a){a=a||1,this._ySize!==a&&(a<0&&(this.warn("negative ySize not allowed - will invert"),a*=-1),this._ySize=a,this._needUpdate(),this.fire("ySize",this._ySize))},get:function(){return this._ySize}},zSize:{set:function(a){a=a||1,this._zSize!==a&&(a<0&&(this.warn("negative zSize not allowed - will invert"),a*=-1),this._zSize=a,this._needUpdate(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}}},_getJSON:function(){return{center:xeogl.math.vecToArray(this._center),xSize:this._xSize,ySize:this._ySize,zSize:this._zSize}}})}(),function(){"use strict";xeogl.TorusGeometry=xeogl.Geometry.extend({type:"xeogl.TorusGeometry",_init:function(a){this._super(a),this.lod=a.lod,this.center=a.center,this.radius=a.radius,this.tube=a.tube,this.radialSegments=a.radialSegments,this.tubeSegments=a.tubeSegments,this.arc=a.arc},_update:function(){var a=this._center[0],b=this._center[1],c=this._center[2],d=this._radius,e=this._tube,f=Math.floor(this._radialSegments*this._lod),g=Math.floor(this._tubeSegments*this._lod),h=this._arc;f<4&&(f=4),g<4&&(g=4);var i,j,k,l,m,n,o,p,q,r,s=[],t=[],u=[],v=[],w=0;for(r=0;r<=f;r++)for(q=0;q<=g;q++)i=q/g*h,j=r/f*Math.PI*2,k=d*Math.cos(i),l=d*Math.sin(i),m=(d+e*Math.cos(j))*Math.cos(i),n=(d+e*Math.cos(j))*Math.sin(i),o=e*Math.sin(j),s.push(m+a),s.push(n+b),s.push(o+c),u.push(1-q/g),u.push(r/f),p=xeogl.math.normalizeVec3(xeogl.math.subVec3([m,n,o],[k,l,w],[]),[]),t.push(p[0]),t.push(p[1]),t.push(p[2]);var x,y,z,A;for(r=1;r<=f;r++)for(q=1;q<=g;q++)x=(g+1)*r+q-1,y=(g+1)*(r-1)+q-1,z=(g+1)*(r-1)+q,A=(g+1)*r+q,v.push(x),v.push(y),v.push(z),v.push(z),v.push(A),v.push(x);this.positions=s,this.normals=t,this.uv=u,this.indices=v},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((a<0||a>1)&&(this.warn("clamping lod to [0..1]"),a=a<0?0:1),this._lod=a,this._needUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(a){(this._center=this._center||new xeogl.math.vec3).set(a||[0,0,0]),this._needUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radius:{set:function(a){a=a||1,this._radius!==a&&(a<0&&(this.warn("negative radius not allowed - will invert"),a*=-1),this._radius=a,this._needUpdate(),this.fire("radius",this._radius))},get:function(){return this._radius}},tube:{set:function(a){a=a||.3,this._tube!==a&&(a<0&&(this.warn("negative tube not allowed - will invert"),a*=-1),this._tube=a,this._needUpdate(),this.fire("tube",this._tube))},get:function(){return this._tube}},radialSegments:{set:function(a){a=a||32,this._radialSegments!==a&&(a<0&&(this.warn("negative radialSegments not allowed - will invert"),a*=-1),this._radialSegments=a,this._needUpdate(),this.fire("radialSegments",this._radialSegments))},get:function(){return this._radialSegments}},tubeSegments:{set:function(a){a=a||24,this._tubeSegments!==a&&(a<0&&(this.warn("negative tubeSegments not allowed - will invert"),a*=-1),this._tubeSegments=a,this._needUpdate(),this.fire("tubeSegments",this._tubeSegments))},get:function(){return this._tubeSegments}},arc:{set:function(a){a=a||2*Math.PI,this._arc!==a&&(a<0&&(this.warn("negative arc not allowed - will invert"),a*=-1),this._arc=a,this._needUpdate(),this.fire("arc",this._arc))},get:function(){return this._arc}}},_getJSON:function(){return{center:xeogl.math.vecToArray(this._center),radius:this._radius,tube:this._tube,radialSegments:this._radialSegments,tubeSegments:this._tubeSegments,arc:this._arc}}})}(),function(){"use strict";xeogl.SphereGeometry=xeogl.Geometry.extend({type:"xeogl.SphereGeometry",_init:function(a){this._super(a),this.lod=a.lod,this.center=a.center,this.radius=a.radius,this.heightSegments=a.heightSegments,this.widthSegments=a.widthSegments},_update:function(){var a=this._radius,b=Math.floor(this._lod*this._heightSegments),c=Math.floor(this._lod*this._widthSegments);b<18&&(b=18),c<18&&(c=18);var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=[],t=[],u=[],v=[],w=this._center[0],x=this._center[1],y=this._center[2];for(d=0;d<=b;d++)for(f=d*Math.PI/b,g=Math.sin(f),h=Math.cos(f),e=0;e<=c;e++)i=2*e*Math.PI/c,j=Math.sin(i),k=Math.cos(i),l=k*g,m=h,n=j*g,o=1-e/c,p=d/b,t.push(l),t.push(m),t.push(n),u.push(o),u.push(p),s.push(w+a*l),s.push(x+a*m),s.push(y+a*n);for(d=0;d<b;d++)for(e=0;e<c;e++)q=d*(c+1)+e,r=q+c+1,v.push(q+1),v.push(r+1),v.push(r),v.push(q+1),v.push(r),v.push(q);this.positions=s,this.normals=t,this.uv=u,this.indices=v},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((a<0||a>1)&&(this.warn("clamping lod to [0..1]"),a=a<0?0:1),this._lod=a,this._needUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(a){(this._center=this._center||new xeogl.math.vec3).set(a||[0,0,0]),this._needUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radius:{set:function(a){a=a||1,this._radius!==a&&(a<0&&(this.warn("negative radius not allowed - will invert"),a*=-1),this._radius=a,this._needUpdate(),this.fire("radius",this._radius))},get:function(){return this._radius}},heightSegments:{set:function(a){a=a||18,this._heightSegments!==a&&(a<0&&(this.warn("negative heightSegments not allowed - will invert"),a*=-1),this._heightSegments=a,this._needUpdate(),this.fire("heightSegments",this._heightSegments))},get:function(){return this._heightSegments}},widthSegments:{set:function(a){a=a||24,this._widthSegments!==a&&(a<0&&(this.warn("negative widthSegments not allowed - will invert"),a*=-1),this._widthSegments=a,this._needUpdate(),this.fire("widthSegments",this._widthSegments))},get:function(){return this._widthSegments}}},_getJSON:function(){return{center:xeogl.math.vecToArray(this._center),radius:this._radius,heightSegments:this._heightSegments,widthSegments:this._widthSegments}}})}(),function(){"use strict";xeogl.OBBGeometry=xeogl.Geometry.extend({type:"xeogl.OBBGeometry",_init:function(a){this._super(a),this.primitive=a.primitive||"lines",this.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],a.boundary?this.boundary=a.boundary:a.obb?this.obb=a.obb:a.positions?this.positions=a.positions:this.positions=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]},_props:{boundary:{set:function(a){var b=!1,c=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:a,sceneDefault:!1,on:{updated:function(){b||(b=!0,xeogl.scheduleTask(function(){c._setPositionsFromOBB(c._attached.boundary.obb),b=!1}))}},onAttached:function(){c._setPositionsFromOBB(c._attached.boundary.obb)}})},get:function(){return this._attached.boundary}},obb:{set:function(a){a&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromOBB(a))}}},_setPositionsFromOBB:function(a){this.positions=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10],a[12],a[13],a[14],a[16],a[17],a[18],a[20],a[21],a[22],a[24],a[25],a[26],a[28],a[29],a[30]]},_getJSON:function(){var a={};return this._attached.boundary?a.boundary=this._attached.boundary.id:this.positions&&(a.positions=xeogl.math.vecToArray(this.positions)),a}})}(),function(){"use strict";xeogl.AABBGeometry=xeogl.Geometry.extend({type:"xeogl.AABBGeometry",_init:function(a){this._super(a),this.primitive=a.primitive||"lines",this.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],a.boundary?this.boundary=a.boundary:a.aabb?this.aabb=a.aabb:a.positions?this.positions=a.positions:this.positions=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]},_props:{boundary:{set:function(a){var b=!1,c=this;this._attach({name:"boundary",type:"xeogl.Boundary3D",component:a,sceneDefault:!1,on:{updated:function(){b||(b=!0,xeogl.scheduleTask(function(){c._setPositionsFromAABB(c._attached.boundary.aabb),b=!1}))}},onAttached:function(){c._setPositionsFromAABB(c._attached.boundary.aabb)}})},get:function(){return this._attached.boundary}},aabb:{set:function(a){a&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromAABB(a))}}},_setPositionsFromAABB:function(a){this.positions=[a[3],a[4],a[5],a[3],a[1],a[5],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[2],a[0],a[4],a[2]]},_getJSON:function(){var a={};return this._attached.boundary?a.boundary=this._attached.boundary.id:this.positions&&(a.positions=xeogl.math.vecToArray(this.positions)),a}})}(),xeogl.PathGeometry=xeogl.Geometry.extend({type:"xeogl.PathGeometry",_init:function(a){this._super(a),this.path=a.path,this.divisions=a.divisions},_update:function(){var a=this._attached.path;if(a){var b,c,d,e=a.getPoints(this._divisions),f=[];for(b=0,c=e.length;b<c;b++)d=e[b],f.push(d[0]),f.push(d[1]),f.push(d[2]);var g=[];for(b=0,c=e.length-1;b<c;b++)g.push(b),g.push(b+1);this.primitive="lines",this.positions=f,this.indices=g,this.normals=null,this.uv=null}},_props:{path:{set:function(a){this._attach({name:"path",type:"xeogl.Curve",component:a,sceneDefault:!1,on:{curves:{callback:this._needUpdate,scope:this}}})},get:function(){return this._attached.path}},divisions:{set:function(a){a=a||6,this._divisions=a,this._needUpdate(),this.fire("divisions",this._divisions)},get:function(){return this._divisions}}},_getJSON:function(){var a={divisions:this._divisions};return this._attached.path&&(a.path=this._attached.path.id),a}}),function(){"use strict";xeogl.CylinderGeometry=xeogl.Geometry.extend({type:"xeogl.CylinderGeometry",_init:function(a){this._super(a),this.center=a.center,this.lod=a.lod,this.center=a.center,this.radiusTop=a.radiusTop,this.radiusBottom=a.radiusBottom,this.height=a.height,this.radialSegments=a.radialSegments,this.heightSegments=a.heightSegments,this.openEnded=a.openEnded},_update:function(){var a=this._center[0],b=this._center[1],c=this._center[2],d=this._radiusTop,e=this._radiusBottom,f=this._height,g=Math.floor(this._radialSegments*this._lod),h=Math.floor(this._heightSegments*this._lod);g<3&&(g=3),h<1&&(h=1);var i,j,k,l,m,n,o,p,q,r,s,t,u=this._openEnded,v=f/2,w=f/h,x=2*Math.PI/g,y=1/g,z=(d-e)/h,A=[],B=[],C=[],D=[],E=(90-180*Math.atan(f/(e-d))/Math.PI)/90;for(i=0;i<=h;i++)for(m=d-i*z,n=v-i*w,j=0;j<=g;j++)k=Math.sin(j*x),l=Math.cos(j*x),B.push(m*k),B.push(E),B.push(m*l),C.push(j*y),C.push(1*i/h),A.push(m*k+a),A.push(n+b),A.push(m*l+c);for(i=0;i<h;i++)for(j=0;j<=g;j++)p=i*(g+1)+j,q=p+g,D.push(p),D.push(q),D.push(q+1),D.push(p),D.push(q+1),D.push(p+1);if(!u&&d>0){for(r=A.length/3,B.push(0),B.push(1),B.push(0),C.push(.5),C.push(.5),A.push(0+a),A.push(v+b),A.push(0+c),j=0;j<=g;j++)k=Math.sin(j*x),l=Math.cos(j*x),s=.5*Math.sin(j*x)+.5,t=.5*Math.cos(j*x)+.5,B.push(d*k),B.push(1),B.push(d*l),C.push(s),C.push(t),A.push(d*k+a),A.push(v+b),A.push(d*l+c);for(j=0;j<g;j++)o=r,p=r+1+j,D.push(p),D.push(p+1),D.push(o)}if(!u&&e>0){for(r=A.length/3,B.push(0),B.push(-1),B.push(0),C.push(.5),C.push(.5),A.push(0+a),A.push(0-v+b),A.push(0+c),j=0;j<=g;j++)k=Math.sin(j*x),l=Math.cos(j*x),s=.5*Math.sin(j*x)+.5,t=.5*Math.cos(j*x)+.5,B.push(e*k),B.push(-1),B.push(e*l),C.push(s),C.push(t),A.push(e*k+a),A.push(0-v+b),A.push(e*l+c);for(j=0;j<g;j++)o=r,p=r+1+j,D.push(o),D.push(p+1),D.push(p)}this.positions=A,this.normals=B,this.uv=C,this.indices=D},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((a<0||a>1)&&(this.warn("clamping lod to [0..1]"),a=a<0?0:1),this._lod=a,this._needUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(a){(this._center=this._center||new xeogl.math.vec3).set(a||[0,0,0]),this._needUpdate(),this.fire("center",this._center)},get:function(){return this._center}},radiusTop:{set:function(a){a=void 0!==a?a:1,this._radiusTop!==a&&(a<0&&(this.warn("negative radiusTop not allowed - will invert"),a*=-1),this._radiusTop=a,this._needUpdate(),this.fire("radiusTop",this._radiusTop))},get:function(){return this._radiusTop}},radiusBottom:{set:function(a){a=void 0!==a?a:1,this._radiusBottom!==a&&(a<0&&(this.warn("negative radiusBottom not allowed - will invert"),a*=-1),this._radiusBottom=a,this._needUpdate(),this.fire("radiusBottom",this._radiusBottom))},get:function(){return this._radiusBottom}},height:{set:function(a){a=a||1,this._height!==a&&(a<0&&(this.warn("negative height not allowed - will invert"),a*=-1),this._height=a,this._needUpdate(),this.fire("height",this._height))},get:function(){return this._height}},radialSegments:{set:function(a){a=a||60,this._radialSegments!==a&&(a<0&&(this.warn("negative radialSegments not allowed - will invert"),a*=-1),this._radialSegments=a,this._needUpdate(),this.fire("radialSegments",this._radialSegments))},get:function(){return this._radialSegments}},heightSegments:{set:function(a){a=a||1,this._heightSegments!==a&&(a<0&&(this.warn("negative heightSegments not allowed - will invert"),a*=-1),this._heightSegments=a,this._needUpdate(),this.fire("heightSegments",this._heightSegments))},get:function(){return this._heightSegments}},openEnded:{set:function(a){a=void 0!==a&&a,this._openEnded!==a&&(this._openEnded=a,this._needUpdate(),this.fire("openEnded",this._openEnded))},get:function(){return this._openEnded}}},_getJSON:function(){return{center:xeogl.math.vecToArray(this._center),radiusTop:this._radiusTop,radiusBottom:this._radiusBottom,height:this._height,radialSegments:this._radialSegments,heightSegments:this._heightSegments,openEnded:this._openEnded}}})}(),function(){"use strict";xeogl.PlaneGeometry=xeogl.Geometry.extend({type:"xeogl.PlaneGeometry",_init:function(a){this._super(a),this.center=a.center,this.xSize=a.xSize,this.zSize=a.zSize,this.xSegments=a.xSegments,this.zSegments=a.zSegments,this.lod=a.lod,this.autoNormals=!1!==a.autoNormals},_update:function(){var a=this._center[0],b=this._center[1],c=this._center[2],d=this._xSize,e=this._zSize,f=Math.floor(this._lod*this._xSegments),g=Math.floor(this._lod*this._zSegments);g<1&&(g=1),g<1&&(g=1);var h,i,j,k,l,m,n,o=d/2,p=e/2,q=Math.floor(f)||1,r=Math.floor(g)||1,s=q+1,t=r+1,u=d/q,v=e/r,w=new Float32Array(s*t*3),x=new Float32Array(s*t*3),y=new Float32Array(s*t*2),z=0,A=0;for(h=0;h<t;h++){var B=h*v-p;for(i=0;i<s;i++)j=i*u-o,w[z]=j+a,w[z+1]=b,w[z+2]=-B+c,x[z+2]=-1,y[A]=(q-i)/q,y[A+1]=(r-h)/r,z+=3,A+=2}z=0;var C=new(w.length/3>65535?Uint32Array:Uint16Array)(q*r*6);for(h=0;h<r;h++)for(i=0;i<q;i++)k=i+s*h,l=i+s*(h+1),m=i+1+s*(h+1),n=i+1+s*h,C[z]=n,C[z+1]=l,C[z+2]=k,C[z+3]=n,C[z+4]=m,C[z+5]=l,z+=6;this.positions=w,this.normals=x,this.uv=y,this.indices=C},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((a<0||a>1)&&(this.warn("clamping lod to [0..1]"),a=a<0?0:1),this._lod=a,this._needUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},center:{set:function(a){(this._center=this._center||new xeogl.math.vec3).set(a||[0,0,0]),this._needUpdate(),this.fire("center",this._center)},get:function(){return this._center}},xSize:{set:function(a){a=a||1,this._xSize!==a&&(a<0&&(this.warn("negative xSize not allowed - will invert"),a*=-1),this._xSize=a,this._needUpdate(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},zSize:{set:function(a){a=a||1,this._zSize!==a&&(a<0&&(this.warn("negative zSize not allowed - will invert"),a*=-1),this._zSize=a,this._needUpdate(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}},xSegments:{set:function(a){a=a||1,this._xSegments!==a&&(a<0&&(this.warn("negative xSegments not allowed - will invert"),a*=-1),this._xSegments=a,this._needUpdate(),this.fire("xSegments",this._xSegments))},get:function(){return this._xSegments}},zSegments:{set:function(a){a=a||1,this._zSegments!==a&&(a<0&&(this.warn("negative zSegments not allowed - will invert"),a*=-1),this._zSegments=a,this._needUpdate(),this.fire("zSegments",this._zSegments))},get:function(){return this._zSegments}}},_getJSON:function(){return{center:xeogl.math.vecToArray(this._center),xSize:this._xSize,zSize:this._zSize,xSegments:this._xSegments,zSegments:this._zSegments}}})}(),function(){"use strict";xeogl.LatheGeometry=xeogl.Geometry.extend({type:"xeogl.LatheGeometry",_init:function(a){this._super(a),this.points=a.points,this.segments=a.segments,this.phiStart=a.phiStart,this.phiLength=a.phiLength,this.lod=a.lod,this.autoNormals=!1!==a.autoNormals},_update:function(){var a=[],b=[],c=Math.floor(this._lod*this._segments);c<4&&(c=4);for(var d=this._phiStart*xeogl.math.DEGTORAD,e=this._phiLength*xeogl.math.DEGTORAD,f=this._points,g=(f.length,1/c),h=0,i=c;h<=i;h++)for(var j=d+h*g*e,k=Math.cos(j),l=Math.sin(j),m=0,n=f.length;m<n;m++){var o=f[m];a.push(k*o[0]-l*o[1]),a.push(l*o[0]+k*o[1]),a.push(o[2])}for(var p=f.length,h=0,i=c;h<i;h++)for(var m=0,n=f.length-1;m<n;m++){var q=m+p*h,r=q,s=q+p,k=q+1+p,t=q+1;b.push(t),b.push(s),b.push(r),b.push(t),b.push(k),b.push(s)}this.positions=a,this.indices=b},_props:{points:{set:function(a){this._points=a||[],this._needUpdate(),this.fire("points",this._points)},get:function(){return this._points}},lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((a<0||a>1)&&(this.warn("clamping lod to [0..1]"),a=a<0?0:1),this._lod=a,this._needUpdate(),this.fire("lod",this._lod))},get:function(){return this._lod}},phiStart:{set:function(a){a=a||0,this._phiStart!==a&&(a<0&&(this.warn("negative phiStart not allowed - will invert"),a*=-1),this._phiStart=a,this._needUpdate(),this.fire("phiStart",this._phiStart))},get:function(){return this._phiStart}},phiLength:{set:function(a){a=a||1,this._phiLength!==a&&(a<0&&(this.warn("negative phiLength not allowed - will invert"),a*=-1),this._phiLength=a,this._needUpdate(),this.fire("phiLength",this._phiLength))},get:function(){return this._phiLength}},segments:{set:function(a){a=Math.floor(a||4),this._segments!==a&&(a<0&&(this.warn("negative segments not allowed - will invert"),a*=-1),this._segments=a,this._needUpdate(),this.fire("segments",this._segments))},get:function(){return this._segments}}},_getJSON:function(){return{points:this._points,phiStart:this._phiStart,phiLength:this._phiLength,segments:this._segments}}})}(),function(){"use strict";xeogl.Input=xeogl.Component.extend({type:"xeogl.Input",serializable:!1,_init:function(a){var b=this;this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(a){b.enabled&&("INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!0:a.altKey?b.altDown=!0:(b.keyDown[a.keyCode]=!0,b.fire("keydown",a.keyCode,!0))),b.mouseover&&a.preventDefault())},!0),document.addEventListener("keyup",this._keyUpListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!1:a.altKey?b.altDown=!1:(b.keyDown[a.keyCode]=!1,b.fire("keyup",a.keyCode,!0)))}),a.element.addEventListener("mouseenter",this._mouseEnterListener=function(a){if(b.enabled){b.mouseover=!0;var c=b._getClickCoordsWithinElement(a);b.fire("mouseenter",c,!0)}}),a.element.addEventListener("mouseleave",this._mouseLeaveListener=function(a){if(b.enabled){b.mouseover=!1;var c=b._getClickCoordsWithinElement(a);b.fire("mouseleave",c,!0)}}),a.element.addEventListener("mousedown",this._mouseDownListener=function(c){if(b.enabled){switch(c.which){case 1:b.mouseDownLeft=!0;break;case 2:b.mouseDownMiddle=!0;break;case 3:b.mouseDownRight=!0}var d=b._getClickCoordsWithinElement(c);a.element.focus(),b.fire("mousedown",d,!0),b.mouseover&&c.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("mouseup",c,!0),b.mouseover&&a.preventDefault()}},!0),document.addEventListener("dblclick",this._dblClickListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1,b.mouseDownRight=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownLeft=!1,b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("dblclick",c,!0),b.mouseover&&a.preventDefault()}}),a.element.addEventListener("mousemove",this._mouseMoveListener=function(a){if(b.enabled){var c=b._getClickCoordsWithinElement(a);b.fire("mousemove",c,!0),b.mouseover&&a.preventDefault()}}),a.element.addEventListener("wheel",this._mouseWheelListener=function(a,c){if(b.enabled){var d=Math.max(-1,Math.min(1,40*-a.deltaY));b.fire("mousewheel",d,!0),b.mouseover&&a.preventDefault()}}),function(){var a,c,d=2;b.on("mousedown",function(b){a=b[0],c=b[1]}),b.on("mouseup",function(e){a>=e[0]-d&&a<=e[0]+d&&c>=e[1]-d&&c<=e[1]+d&&b.fire("mouseclicked",e,!0)})}(),function(){var a,c,d={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0},e=xeogl.math.vec3(),f=xeogl.math.vec3(),g={orientation:null,orientationAngle:0},h={orientationAngle:0,acceleration:null,accelerationIncludingGravity:f,rotationRate:xeogl.math.vec3(),interval:0},i={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent&&window.addEventListener("orientationchange",b._orientationchangedListener=function(){a=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,c=a?d[a]||0:0,g.orientation=a,g.orientationAngle=c,b.fire("orientationchange",g)},!1),window.DeviceMotionEvent&&window.addEventListener("devicemotion",b._deviceMotionListener=function(a){h.interval=a.interval,h.orientationAngle=c;var d=a.acceleration;d?(e[0]=d.x,e[1]=d.y,e[2]=d.z,h.acceleration=e):h.acceleration=null;var g=a.accelerationIncludingGravity;g?(f[0]=g.x,f[1]=g.y,f[2]=g.z,h.accelerationIncludingGravity=f):h.accelerationIncludingGravity=null,h.rotationRate=a.rotationRate,b.fire("devicemotion",h)},!1),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",b._deviceOrientListener=function(a){i.gamma=a.gamma,i.beta=a.beta,i.alpha=a.alpha,i.absolute=a.absolute,b.fire("deviceorientation",i)},!1)}()},_getClickCoordsWithinElement:function(a){var b=[0,0];if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b[0]=a.pageX-d,b[1]=a.pageY-e}else a=window.event,b.x=a.x,b.y=a.y;return b},setEnabled:function(a){this.enabled!==a&&this.fire("enabled",this.enabled=a)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener)}})}(),function(){"use strict";xeogl.Lights=xeogl.Component.extend({type:"xeogl.Lights",_init:function(a){this._state=new xeogl.renderer.Lights({lights:[],hash:""}),this._lights=[],this._dirtySubs=[],this._destroyedSubs=[],a.lights&&(this.lights=a.lights),a.lightMap&&(this.lightMap=a.lightMap),a.reflectionMap&&(this.reflectionMap=a.reflectionMap)},_props:{lights:{set:function(a){function b(){g.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=g._lights.length;b<c;b++)if(g._lights[b].id===a)return g._lights=g._lights.slice(b,b+1),g._dirtySubs=g._dirtySubs.slice(b,b+1),g._destroyedSubs=g._destroyedSubs.slice(b,b+1),g.fire("dirty",!0),void g.fire("lights",g._lights)}a=a||[];var d,e,f;for(e=0,f=this._lights.length;e<f;e++)d=this._lights[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._lights=[],this._dirtySubs=[],this._destroyedSubs=[];var g=this;for(e=0,f=a.length;e<f;e++){if(d=a[e],xeogl._isNumeric(d)||xeogl._isString(d)){var h=d;if(!(d=this.scene.components[h])){this.error("Component not found: "+xeogl._inQuotes(h));continue}}var i=d.type;"xeogl.AmbientLight"===i||"xeogl.DirLight"===i||"xeogl.PointLight"===i||"xeogl.SpotLight"===i?(this._lights.push(d),
this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+xeogl._inQuotes(d.id)+" is not an xeogl.AmbientLight, xeogl.DirLight, xeogl.PointLight or xeogl.SpotLight")}this.fire("dirty",!0),this.fire("lights",this._lights)},get:function(){return this._lights}},lightMap:{set:function(a){this._attachComponent("xeogl.CubeTexture","lightMap",a)},get:function(){return this._attached.lightMap}},reflectionMap:{set:function(a){this._attachComponent("xeogl.CubeTexture","reflectionMap",a)},get:function(){return this._attached.reflectionMap}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:void 0,this._hashDirty=!0},_shadowsDirty:function(){for(var a,b=0,c=this._lights.length;b<c;b++)a=this._lights[b]._state,a.shadow&&(a.shadowDirty=!0)},_compile:function(){var a=this._state;a.lights=[];for(var b=0,c=this._lights.length;b<c;b++)a.lights.push(this._lights[b]._state);this._makeHash(),this._renderer.lights=a},_makeHash:function(){for(var a,b=[],c=this._state,d=c.lights,e=0,f=d.length;e<f;e++)a=d[e],b.push("/"),b.push(a.type),b.push("world"===a.space?"w":"v"),a.shadow&&b.push("sh");c.lightMap&&b.push("/lm"),c.reflectionMap&&b.push("/rm"),b.push(";"),this._state.hash=b.join("")},_getJSON:function(){for(var a={lights:[]},b=this._attached,c=0,d=this._lights.length;c<d;c++)a.lights.push(this._lights[c].id);return b.lightMap&&(a.lightMap=b.lightMap.id),b.reflectionMap&&(a.reflectionMap=b.reflectionMap.id),a.lights},_destroy:function(){var a,b,c;for(a=0,b=this._lights.length;a<b;a++)c=this._lights[a],c.off(this._dirtySubs[a]),c.off(this._destroyedSubs[a]);this._state.destroy()}})}(),function(){"use strict";xeogl.AmbientLight=xeogl.Component.extend({type:"xeogl.AmbientLight",_init:function(a){this._state={type:"ambient",color:xeogl.math.vec3([.7,.7,.7]),intensity:1},this.color=a.color,this.intensity=a.intensity},_props:{color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){this._state.intensity=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}},_getJSON:function(){return{color:xeogl.math.vecToArray(this._state.color),intensity:this._state.intensity}}})}(),function(){"use strict";var a=xeogl.math;xeogl.DirLight=xeogl.Component.extend({type:"xeogl.DirLight",_init:function(a){var b=this;this._state={type:"dir",dir:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,space:"view",shadow:null,shadowDirty:!0,getShadowViewMatrix:function(){return b._getShadowViewMatrix()},getShadowProjMatrix:function(){return b._getShadowProjMatrix()},getShadowRenderBuf:function(){return b._getShadowRenderBuf()}},this.dir=a.dir,this.color=a.color,this.intensity=a.intensity,this.space=a.space,this.shadow=a.shadow},_getShadowViewMatrix:function(){var b=(a.vec3(),a.vec3([0,1,0]));return function(){return this._shadowViewMatrix||(this._shadowViewMatrix=a.identityMat4()),a.lookAtMat4v([0,-100,0],[0,0,0],b,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1,this._shadowViewMatrix}}(),_getShadowProjMatrix:function(){this._shadowProjMatrix||(this._shadowProjMatrix=a.identityMat4());var b=this.scene.canvas.canvas;return a.perspectiveMat4(45,b.clientWidth/b.clientHeight,.1,1e3,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1,this._shadowProjMatrix},_getShadowRenderBuf:function(){return this._shadowRenderBuf||(this._shadowRenderBuf=new xeogl.renderer.webgl.RenderBuffer(this.scene.canvas.canvas,this.scene.canvas.gl)),this._shadowRenderBuf},_props:{dir:{set:function(a){this._state.dir.set(a||[1,1,1]),this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}},shadow:{set:function(a){this._attachComponent("xeogl.Shadow","shadow",a)},get:function(){return this._attached.shadow}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:null,this._hashDirty=!0},_getJSON:function(){var a=xeogl.math.vecToArray,b={type:this._state.type,dir:a(this._state.dir),color:a(this._state.color),intensity:this._state.intensity,space:this._state.space};return this._attached.shadow&&(b.shadow=this._attached.shadow.id),b}})}(),function(){"use strict";xeogl.PointLight=xeogl.Component.extend({type:"xeogl.PointLight",_init:function(a){this._state={type:"point",pos:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:"view"},this.pos=a.pos,this.color=a.color,this.intensity=a.intensity,this.constantAttenuation=a.constantAttenuation,this.linearAttenuation=a.linearAttenuation,this.quadraticAttenuation=a.quadraticAttenuation,this.space=a.space},_props:{pos:{set:function(a){this._state.pos.set(a||[1,1,1]),this._renderer.imageDirty=!0,this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},constantAttenuation:{set:function(a){this._state.attenuation[0]=a||0,this._renderer.imageDirty=!0,this.fire("constantAttenuation",this._state.attenuation[0])},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(a){this._state.attenuation[1]=a||0,this._renderer.imageDirty=!0,this.fire("linearAttenuation",this._state.attenuation[1])},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(a){this._state.attenuation[2]=a||0,this._renderer.imageDirty=!0,this.fire("quadraticAttenuation",this._state.attenuation[2])},get:function(){return this._state.attenuation[2]}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){var a=xeogl.math.vecToArray;return{type:this._state.type,pos:a(this._state.pos),color:a(this._state.color),intensity:this._state.intensity,constantAttenuation:this._state.attenuation[0],linearAttenuation:this._state.attenuation[1],quadraticAttenuation:this._state.attenuation[2],space:this._state.space}}})}(),function(){"use strict";var a=xeogl.math;xeogl.SpotLight=xeogl.Component.extend({type:"xeogl.SpotLight",_init:function(b){var c=this;this._state={type:"spot",pos:a.vec3([1,1,1]),dir:a.vec3([0,-1,0]),color:a.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:"view",shadow:null,shadowDirty:!0,getShadowViewMatrix:function(){return c._getShadowViewMatrix()},getShadowProjMatrix:function(){return c._getShadowProjMatrix()},getShadowRenderBuf:function(){return c._getShadowRenderBuf()}},this.pos=b.pos,this.color=b.color,this.intensity=b.intensity,this.constantAttenuation=b.constantAttenuation,this.linearAttenuation=b.linearAttenuation,this.quadraticAttenuation=b.quadraticAttenuation,this.space=b.space,this.shadow=b.shadow},_getShadowViewMatrix:function(){var b=a.vec3(),c=a.vec3([0,1,0]);return function(){return this._shadowViewMatrix||(this._shadowViewMatrix=a.identityMat4()),a.addVec3(this._state.pos,this._state.dir,b),a.lookAtMat4v(this._state.pos,b,c,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1,this._shadowViewMatrix}}(),_getShadowProjMatrix:function(){this._shadowProjMatrix||(this._shadowProjMatrix=a.identityMat4());var b=this.scene.canvas.canvas;return a.perspectiveMat4(45,b.clientWidth/b.clientHeight,.1,1e3,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1,this._shadowProjMatrix},_getShadowRenderBuf:function(){return this._shadowRenderBuf||(this._shadowRenderBuf=new xeogl.renderer.webgl.RenderBuffer(this.scene.canvas.canvas,this.scene.canvas.gl)),this._shadowRenderBuf},_props:{pos:{set:function(a){this._state.pos.set(a||[1,1,1]),this._shadowViewMatrixDirty=!1,this._renderer.imageDirty=!0,this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},dir:{set:function(a){this._state.dir.set(a||[1,1,1]),this._shadowViewMatrixDirty=!1,this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},constantAttenuation:{set:function(a){this._state.attenuation[0]=a||0,this._renderer.imageDirty=!0,this.fire("constantAttenuation",this._state.attenuation[0])},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(a){this._state.attenuation[1]=a||0,this._renderer.imageDirty=!0,this.fire("linearAttenuation",this._state.attenuation[1])},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(a){this._state.attenuation[2]=a||0,this._renderer.imageDirty=!0,this.fire("quadraticAttenuation",this._state.attenuation[2])},get:function(){return this._state.attenuation[2]}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}},shadow:{set:function(a){this._attachComponent("xeogl.Shadow","shadow",a)},get:function(){return this._attached.shadow}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:null,this._hashDirty=!0},_getJSON:function(){var a=xeogl.math.vecToArray,b={type:this._state.type,pos:a(this._state.pos),dir:a(this._state.dir),color:a(this._state.color),intensity:this._state.intensity,constantAttenuation:this._state.attenuation[0],linearAttenuation:this._state.attenuation[1],quadraticAttenuation:this._state.attenuation[2],space:this._state.space};return this._attached.shadow&&(b.shadow=this._attached.shadow.id),b},_destroy:function(){this._shadowRenderBuf&&this._shadowRenderBuf.destroy()}})}(),function(){"use strict";xeogl.CubeTexture=xeogl.Component.extend({type:"xeogl.CubeTexture",_init:function(a){this._state=new xeogl.renderer.CubeTexture({texture:null}),this._src=[],this._images=[],this._srcDirty=!1,this._imageDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.flipY=a.flipY,this.src=a.src,xeogl.stats.memory.textures++},_webglContextRestored:function(){this._state.texture=null,this._src&&(this._srcDirty=!0),this._needUpdate()},_update:function(){if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);this._imageDirty&&(this._createTexture(),this._renderer.imageDirty=!0)},_loadSrc:function(a){var b=this,c=this.scene.canvas.spinner,d=c.textures;this._images=[];for(var e=!1,f=0,g=0;g<a.length;g++){var h=new Image;h.onload=function(){var a=h,i=g;return function(){e||(a=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(a),b._images[i]=a,6===++f&&(b._imageDirty=!0,d&&c.processes--,b._needUpdate(),b.fire("loaded",b._src)))}}(),h.onerror=function(){e=!0,d&&c.processes--},h.src=a[g]}},_createTexture:function(){var a=this.scene.canvas.gl,b=this._state.texture;b||(b=new xeogl.renderer.webgl.Texture2D(a,a.TEXTURE_CUBE_MAP),this._state.texture=b),b.setImage(this._images,this._state),b.setProps({minFilter:"linearMipmapLinear",magFilter:"linear",wrapS:"clampToEdge",wrapT:"clampToEdge",mipmaps:!0}),this._imageDirty=!1},_props:{src:{set:function(a){this._src=a,this._srcDirty=!0,this._needUpdate(),this.fire("src",this._src)},get:function(){return this._src}},flipY:{set:function(a){a=!!a,this._state.flipY!==a&&(this._state.flipY=a,this._imageDirty=!0,this._needUpdate(),this.fire("flipY",this._state.flipY))},get:function(){return this._state.flipY}}},_getJSON:function(){var a={src:this._src.slice()};return!1!==this._state.flipY&&(a.flipY=this._state.flipY),a},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Shadow=xeogl.Component.extend({type:"xeogl.Shadow",_init:function(a){this._state={resolution:xeogl.math.vec3([1e3,1e3]),intensity:1},this.resolution=a.resolution,this.intensity=a.intensity},_props:{resolution:{set:function(a){this._state.resolution.set(a||[1e3,1e3]),this._renderer.imageDirty=!0,this.fire("resolution",this._state.resolution)},get:function(){return this._state.resolution}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}},_getJSON:function(){return{resolution:this._state.resolution,intensity:this._state.intensity}}})}(),function(){"use strict";xeogl.Model=xeogl.Component.extend({type:"xeogl.Model",_init:function(a){if(this.components={},this.numComponents=0,this.types={},this.entities={},this._onDestroyed={},this._onWorldBoundaryUpdated={},this._aabbDirty=!1,this._dummyRootTransform=this.create({type:"xeogl.Transform",meta:"dummy"}),this.transform=a.transform,a.components)for(var b=a.components,c=0,d=b.length;c<d;c++)this.add(b[c])},add:function(a){var b,c;if(xeogl._isNumeric(a)||xeogl._isString(a)){if(this.scene.types[a]){var d=a;if(!(c=this.scene.types[d]))return void this.warn("Component type not found: '"+d+"'");for(b in c)c.hasOwnProperty(b)&&this.add(c[b]);return}if(!(a=this.scene.components[a]))return void this.warn("Component not found: "+xeogl._inQuotes(a))}else if(xeogl._isObject(a)){var d=a.type||"xeogl.Component";if(!xeogl._isComponentType(d))return void this.error("Not a xeogl component type: "+d);a=new window[d](this.scene,a)}if(a.scene!==this.scene)return void this.warn("Attempted to add component from different xeogl.Scene: "+xeogl._inQuotes(a.id));if(!this.components[a.id]){this.components[a.id]=a,c=this.types[a.type],c||(c=this.types[a.type]={}),c[a.id]=a,this.numComponents++;var e=this;if(this._onDestroyed[a.id]=a.on("destroyed",function(){e._remove(a)}),a.isType("xeogl.Entity")){var f=a.transform;if(f&&"default.transform"!==f.id){for(;f.parent&&f.id!==e._dummyRootTransform.id;)f=f.parent;f.id!==e._dummyRootTransform.id&&(f.parent=e._dummyRootTransform)}else a.transform=e._dummyRootTransform;this.entities[a.id]=a}return a.worldBoundary&&(this._onWorldBoundaryUpdated[a.id]=a.worldBoundary.on("updated",this._updated,this)),this.fire("added",a),this._dirty||this._needUpdate(),a}},_needUpdate:function(){this._dirty||(this._dirty=!0,xeogl.scheduleTask(this._notifyUpdated,this))},_notifyUpdated:function(){this.fire("updated"),this._aabbDirty||this._setAABBDirty(),this._dirty=!1},destroyAll:function(){var a,b,c,d,e=[];for(a in this.types)if(this.types.hasOwnProperty(a)){b=this.types[a];for(d in b)b.hasOwnProperty(d)&&(c=b[d],c.isType("xeogl.Entity")?e.push(c):e.unshift(c))}for(;e.length>0;)e.pop().destroy()},removeAll:function(){this.iterate(function(a){a.destroy()})},_remove:function(a){var b=a.id;if(a.scene!==this.scene)return void this.warn("Attempted to remove component that's not in same xeogl.Scene: '"+b+"'");delete this.components[b],delete this.entities[b],a.off(this._onDestroyed[b]),delete this._onDestroyed[b];var c=this.types[a.type];c&&delete c[a.id],this.numComponents--,a.worldBoundary&&(a.worldBoundary.off(this._onWorldBoundaryUpdated[a.id]),delete this._onWorldBoundaryUpdated[a.id]),this.fire("removed",a),this._dirty||this._needUpdate()},iterate:function(a,b){b=b||this;var c=this.components;for(var d in c)c.hasOwnProperty(d)&&a.call(b,c[d])},_props:{transform:{set:function(a){this._attach({name:"transform",type:"xeogl.Transform",component:a,sceneDefault:!1,onAttached:{callback:this._transformUpdated,scope:this}})},get:function(){return this._attached.transform}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this;this._worldBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!(!a._aabbDirty&&a._aabb)&&(a._buildAABB(),a._aabbDirty=!1,!0)},getAABB:function(){return a._aabb}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null})}return this._worldBoundary}}},_transformUpdated:function(a){this._dummyRootTransform.parent=a},_updated:function(){this._aabbDirty||this._setAABBDirty()},_setAABBDirty:function(){this._aabbDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},_buildAABB:function(){this._aabb||(this._aabb=xeogl.math.AABB3());var a,b,c,d=xeogl.math.MAX_DOUBLE,e=xeogl.math.MAX_DOUBLE,f=xeogl.math.MAX_DOUBLE,g=-xeogl.math.MAX_DOUBLE,h=-xeogl.math.MAX_DOUBLE,i=-xeogl.math.MAX_DOUBLE,j=this.components;for(var k in j)j.hasOwnProperty(k)&&(a=j[k],(b=a.worldBoundary)&&(c=b.aabb,c[0]<d&&(d=c[0]),c[1]<e&&(e=c[1]),c[2]<f&&(f=c[2]),c[3]>g&&(g=c[3]),c[4]>h&&(h=c[4]),c[5]>i&&(i=c[5])));this._aabb[0]=d,this._aabb[1]=e,this._aabb[2]=f,this._aabb[3]=g,this._aabb[4]=h,this._aabb[5]=i},_destroy:function(){this.removeAll()}})}(),function(){"use strict";xeogl.Outline=xeogl.Component.extend({type:"xeogl.Outline",_init:function(a){this._state=new xeogl.renderer.Outline({thickness:15,color:xeogl.math.vec3([1,1,0])}),this.thickness=a.thickness,this.color=a.color},_props:{thickness:{set:function(a){a=a||15,(a=Math.round(a))!==this._state.thickness&&(this._state.thickness=a,this._renderer.imageDirty=!0,this.fire("thickness",this._state.thickness))},get:function(){return this._state.thickness}},color:{set:function(a){var b=this._state.color;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.color=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=0),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}}},_compile:function(){this._renderer.outline=this._state},_getJSON:function(){return{thickness:this._state.thickness,color:xeogl.math.vecToArray(this._state.color)}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.XRay=xeogl.Component.extend({type:"xeogl.XRay",_init:function(a){this._state=new xeogl.renderer.XRay({thickness:15,color:xeogl.math.vec3([1,1,0])}),this.thickness=a.thickness,this.color=a.color},_props:{thickness:{set:function(a){a=a||15,(a=Math.round(a))!==this._state.thickness&&(this._state.thickness=a,this._renderer.imageDirty=!0,this.fire("thickness",this._state.thickness))},get:function(){return this._state.thickness}},color:{set:function(a){var b=this._state.color;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.color=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=0),this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}}},_compile:function(){this._renderer.xray=this._state},_getJSON:function(){return{thickness:this._state.thickness,color:xeogl.math.vecToArray(this._state.color)}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Material=xeogl.Component.extend({type:"xeogl.Material",_init:function(){}})}(),function(){"use strict";xeogl.PhongMaterial=xeogl.Material.extend({type:"xeogl.PhongMaterial",_init:function(a){this._state=new xeogl.renderer.PhongMaterial({type:"phongMaterial",ambient:xeogl.math.vec3([1,1,1]),diffuse:xeogl.math.vec3([1,1,1]),specular:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this._hashDirty=!0,this.on("dirty",function(){this._hashDirty=!0},this),this.ambient=a.ambient,this.diffuse=a.diffuse,this.specular=a.specular,this.emissive=a.emissive,this.alpha=a.alpha,this.shininess=a.shininess,this.reflectivity=a.reflectivity,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize,a.ambientMap&&(this.ambientMap=a.ambientMap),a.diffuseMap&&(this.diffuseMap=a.diffuseMap),a.specularMap&&(this.specularMap=a.specularMap),a.emissiveMap&&(this.emissiveMap=a.emissiveMap),a.alphaMap&&(this.alphaMap=a.alphaMap),a.reflectivityMap&&(this.reflectivityMap=a.reflectivityMap),a.normalMap&&(this.normalMap=a.normalMap),a.occlusionMap&&(this.occlusionMap=a.occlusionMap),a.diffuseFresnel&&(this.diffuseFresnel=a.diffuseFresnel),a.specularFresnel&&(this.specularFresnel=a.specularFresnel),a.emissiveFresnel&&(this.emissiveFresnel=a.emissiveFresnel),a.alphaFresnel&&(this.alphaFresnel=a.alphaFresnel),a.reflectivityFresnel&&(this.reflectivityFresnel=a.reflectivityFresnel),this.alphaMode=a.alphaMode,this.alphaCutoff=a.alphaCutoff,this.backfaces=a.backfaces,this.frontface=a.frontface},_props:{ambient:{set:function(a){var b=this._state.ambient;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.ambient=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.2,b[1]=.2,b[2]=.2),this._renderer.imageDirty=!0,this.fire("ambient",this._state.ambient)},get:function(){return this._state.ambient}},diffuse:{set:function(a){var b=this._state.diffuse;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.diffuse=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty=!0,this.fire("diffuse",this._state.diffuse)},get:function(){return this._state.diffuse}},specular:{set:function(a){var b=this._state.specular;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.specular=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty=!0,this.fire("specular",this._state.specular)},get:function(){return this._state.specular}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty=!0,this.fire("emissive",this._state.emissive)},get:function(){return this._state.emissive}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty=!0,this.fire("alpha",this._state.alpha))},get:function(){return this._state.alpha}},shininess:{set:function(a){this._state.shininess=void 0!==a?a:80,this._renderer.imageDirty=!0,this.fire("shininess",this._state.shininess)},get:function(){return this._state.shininess}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty=!0,this.fire("lineWidth",this._state.lineWidth)},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty=!0,this.fire("pointSize",this._state.pointSize)},get:function(){return this._state.pointSize}},reflectivity:{set:function(a){this._state.reflectivity=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("reflectivity",this._state.reflectivity)},get:function(){return this._state.reflectivity}},normalMap:{set:function(a){this._attachComponent("xeogl.Texture","normalMap",a)},get:function(){return this._attached.normalMap}},ambientMap:{set:function(a){this._attachComponent("xeogl.Texture","ambientMap",a)},get:function(){return this._attached.ambientMap}},diffuseMap:{set:function(a){this._attachComponent("xeogl.Texture","diffuseMap",a)},get:function(){return this._attached.diffuseMap}},specularMap:{set:function(a){this._attachComponent("xeogl.Texture","specularMap",a)},get:function(){return this._attached.specularMap}},emissiveMap:{set:function(a){this._attachComponent("xeogl.Texture","emissiveMap",a)},get:function(){return this._attached.emissiveMap}},alphaMap:{set:function(a){this._attachComponent("xeogl.Texture","alphaMap",a)},get:function(){return this._attached.alphaMap}},reflectivityMap:{set:function(a){this._attachComponent("xeogl.Texture","reflectivityMap",a)},get:function(){return this._attached.reflectivityMap}},reflection:{set:function(a){this._attachComponent("xeogl.Reflect","reflection",a)},get:function(){return this._attached.reflection}},occlusionMap:{set:function(a){this._attachComponent("xeogl.Texture","occlusionMap",a)},get:function(){return this._attached.occlusionMap}},diffuseFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","diffuseFresnel",a)},get:function(){return this._attached.diffuseFresnel}},specularFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","specularFresnel",a)},get:function(){return this._attached.specularFresnel}},emissiveFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","emissiveFresnel",a)},get:function(){return this._attached.emissiveFresnel}},alphaFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","alphaFresnel",a)},get:function(){return this._attached.alphaFresnel}},reflectivityFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","reflectivityFresnel",a)},get:function(){return this._attached.reflectivityFresnel}},alphaMode:function(){var a={opaque:0,mask:1,blend:2},b=["opaque","mask","blend"];return{set:function(b){b=b||"opaque";var c=a[b];void 0===c&&(this.error("Unsupported value for 'alphaMode': "+b+" - defaulting to 'opaque'"),c="opaque"),this._state.alphaMode!==c&&(this._state.alphaMode=c,this._renderer.imageDirty=!0,this.fire("alphaMode",this._state.alphaMode))},get:function(){return b[this._state.alphaMode]}}}(),alphaCutoff:{set:function(a){null!==a&&void 0!==a||(a=.5),this._state.alphaCutoff!==a&&(this._state.alphaCutoff=a,this.fire("alphaCutoff",this._state.alphaCutoff))},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty=!0,this.fire("backfaces",this._state.backfaces))},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty=!0,this.fire("frontface",this._state.frontface?"ccw":"cw"))},get:function(){return this._state.frontface?"ccw":"cw"}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:null,this._hashDirty=!0},_compile:function(){this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.material=this._state},_makeHash:function(){var a=this._state,b=["/p"];a.normalMap&&(b.push("/nm"),a.normalMap.matrix&&b.push("/mat")),a.ambientMap&&(b.push("/am"),a.ambientMap.matrix&&b.push("/mat")),a.diffuseMap&&(b.push("/dm"),a.diffuseMap.matrix&&b.push("/mat")),a.specularMap&&(b.push("/sm"),a.specularMap.matrix&&b.push("/mat")),a.emissiveMap&&(b.push("/em"),a.emissiveMap.matrix&&b.push("/mat")),a.alphaMap&&(b.push("/opm"),a.alphaMap.matrix&&b.push("/mat")),a.reflectivityMap&&(b.push("/rm"),a.reflectivityMap.matrix&&b.push("/mat")),a.occlusionMap&&(b.push("/ocm"),a.occlusionMap.matrix&&b.push("/mat")),a.diffuseFresnel&&b.push("/df"),a.specularFresnel&&b.push("/sf"),a.emissiveFresnel&&b.push("/ef"),a.alphaFresnel&&b.push("/of"),a.reflectivityFresnel&&b.push("/rf"),b.push(";"),a.hash=b.join("")},_getJSON:function(){var a=xeogl.math.vecToArray,b={ambient:a(this._state.ambient),diffuse:a(this._state.diffuse),specular:a(this._state.specular),emissive:a(this._state.emissive),alphaMode:this.alphaMode,alphaCutoff:this._state.alphaCutoff,backfaces:this._state.backfaces,frontface:this.frontface};1!==this._state.alpha&&(b.alpha=this._state.alpha),80!==this._state.shininess&&(b.shininess=this._state.shininess),1!==this._state.reflectivity&&(b.reflectivity=this._state.reflectivity),1!==this._state.lineWidth&&(b.lineWidth=this._state.lineWidth),1!==this._state.pointSize&&(b.pointSize=this._state.pointSize);var c=this._attached;return c.normalMap&&(b.normalMap=c.normalMap.id),c.ambientMap&&(b.ambientMap=c.ambientMap.id),c.diffuseMap&&(b.diffuseMap=c.diffuseMap.id),c.specularMap&&(b.specularMap=c.specularMap.id),c.emissiveMap&&(b.emissiveMap=c.emissiveMap.id),c.alphaMap&&(b.alphaMap=c.alphaMap.id),c.reflectivityMap&&(b.reflectivityMap=c.reflectivityMap.id),c.occlusionMap&&(b.occlusionMap=c.occlusionMap.id),c.diffuseFresnel&&(b.diffuseFresnel=c.diffuseFresnel.id),c.specularFresnel&&(b.specularFresnel=c.specularFresnel.id),c.emissiveFresnel&&(b.emissiveFresnel=c.emissiveFresnel.id),c.alphaFresnel&&(b.alphaFresnel=c.alphaFresnel.id),c.reflectivityFresnel&&(b.reflectivityFresnel=c.reflectivityFresnel.id),b},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.SpecularMaterial=xeogl.Material.extend({type:"xeogl.SpecularMaterial",_init:function(a){this._state=new xeogl.renderer.SpecularMaterial({type:"SpecularMaterial",diffuse:xeogl.math.vec4([1,1,1]),emissive:xeogl.math.vec4([0,0,0]),specular:xeogl.math.vec4([1,1,1]),glossiness:null,specularF0:null,alpha:null,diffuseMap:null,emissiveMap:null,specularMap:null,glossinessMap:null,specularGlossinessMap:null,occlusionMap:null,alphaMap:null,normalMap:null,alphaMode:null,alphaCutoff:null,hash:null}),this._hashDirty=!0,this.on("dirty",function(){this._hashDirty=!0},this),this.diffuse=a.diffuse,this.specular=a.specular,this.glossiness=a.glossiness,this.specularF0=a.specularF0,this.emissive=a.emissive,this.alpha=a.alpha,a.diffuseMap&&(this.diffuseMap=a.diffuseMap),a.emissiveMap&&(this.emissiveMap=a.emissiveMap),a.specularMap&&(this.specularMap=a.specularMap),a.glossinessMap&&(this.glossinessMap=a.glossinessMap),a.specularGlossinessMap&&(this.specularGlossinessMap=a.specularGlossinessMap),a.occlusionMap&&(this.occlusionMap=a.occlusionMap),a.alphaMap&&(this.alphaMap=a.alphaMap),a.normalMap&&(this.normalMap=a.normalMap),this.alphaMode=a.alphaMode,this.alphaCutoff=a.alphaCutoff,this.backfaces=a.backfaces,this.frontface=a.frontface},_props:{diffuse:{set:function(a){var b=this._state.diffuse;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.diffuse=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty=!0,this.fire("diffuse",this._state.diffuse)},get:function(){return this._state.diffuse}},diffuseMap:{set:function(a){this._attachComponent("xeogl.Texture","diffuseMap",a)},get:function(){return this._attached.diffuseMap}},specular:{set:function(a){var b=this._state.specular;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.specular=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty=!0,this.fire("specular",this._state.specular)},get:function(){return this._state.specular}},specularMap:{set:function(a){this._attachComponent("xeogl.Texture","specularMap",a)},get:function(){return this._attached.specularMap}},specularGlossinessMap:{set:function(a){this._attachComponent("xeogl.Texture","specularGlossinessMap",a)},get:function(){return this._attached.specularGlossinessMap}},glossiness:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.glossiness!==a&&(this._state.glossiness=a,this._renderer.imageDirty=!0,this.fire("glossiness",this._state.glossiness))},get:function(){
return this._state.glossiness}},glossinessMap:{set:function(a){this._attachComponent("xeogl.Texture","glossinessMap",a)},get:function(){return this._attached.glossinessMap}},specularF0:{set:function(a){a=void 0!==a&&null!==a?a:0,this._state.specularF0!==a&&(this._state.specularF0=a,this._renderer.imageDirty=!0,this.fire("specularF0",this._state.specularF0))},get:function(){return this._state.specularF0}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty=!0,this.fire("emissive",this._state.emissive)},get:function(){return this._state.emissive}},emissiveMap:{set:function(a){this._attachComponent("xeogl.Texture","emissiveMap",a)},get:function(){return this._attached.emissiveMap}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty=!0,this.fire("alpha",this._state.alpha))},get:function(){return this._state.alpha}},alphaMap:{set:function(a){this._attachComponent("xeogl.Texture","alphaMap",a)},get:function(){return this._attached.alphaMap}},normalMap:{set:function(a){this._attachComponent("xeogl.Texture","normalMap",a)},get:function(){return this._attached.normalMap}},occlusionMap:{set:function(a){this._attachComponent("xeogl.Texture","occlusionMap",a)},get:function(){return this._attached.occlusionMap}},alphaMode:function(){var a={opaque:0,mask:1,blend:2},b=["opaque","mask","blend"];return{set:function(b){b=b||"opaque";var c=a[b];void 0===c&&(this.error("Unsupported value for 'alphaMode': "+b+" defaulting to 'opaque'"),c="opaque"),this._state.alphaMode!==c&&(this._state.alphaMode=c,this._renderer.imageDirty=!0,this.fire("alphaMode",this._state.alphaMode))},get:function(){return b[this._state.alphaMode]}}}(),alphaCutoff:{set:function(a){null!==a&&void 0!==a||(a=.5),this._state.alphaCutoff!==a&&(this._state.alphaCutoff=a,this.fire("alphaCutoff",this._state.alphaCutoff))},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty=!0,this.fire("backfaces",this._state.backfaces))},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty=!0,this.fire("frontface",this._state.frontface?"ccw":"cw"))},get:function(){return this._state.frontface?"ccw":"cw"}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:null,this._hashDirty=!0},_compile:function(){this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.material=this._state},_makeHash:function(){var a=this._state,b=["/spe"];a.diffuseMap&&(b.push("/dm"),a.diffuseMap.matrix&&b.push("/mat")),a.emissiveMap&&(b.push("/em"),a.emissiveMap.matrix&&b.push("/mat")),a.glossinessMap&&(b.push("/gm"),a.glossinessMap.matrix&&b.push("/mat")),a.specularMap&&(b.push("/sm"),a.specularMap.matrix&&b.push("/mat")),a.specularGlossinessMap&&(b.push("/sgm"),a.specularGlossinessMap.matrix&&b.push("/mat")),a.occlusionMap&&(b.push("/ocm"),a.occlusionMap.matrix&&b.push("/mat")),a.normalMap&&(b.push("/nm"),a.normalMap.matrix&&b.push("/mat")),a.alphaMap&&(b.push("/opm"),a.alphaMap.matrix&&b.push("/mat")),b.push(";"),a.hash=b.join("")},_getJSON:function(){var a=xeogl.math.vecToArray,b={diffuse:a(this._state.diffuse),specular:a(this._state.specular),glossiness:this._state.glossiness,specularF0:this._state.specularF0,emissive:a(this._state.emissive),alpha:this._state.alpha,alphaMode:this.alphaMode,alphaCutoff:this._state.alphaCutoff,backfaces:this._state.backfaces,frontface:this.frontface},c=this._attached;return c.diffuseMap&&(b.diffuseMap=c.diffuseMap.id),c.emissiveMap&&(b.emissiveMap=c.emissiveMap.id),c.specularMap&&(b.specularMap=c.specularMap.id),c.glossinessMap&&(b.glossinessMap=c.glossinessMap.id),c.specularGlossinessMap&&(b.specularGlossinessMap=c.specularGlossinessMap.id),c.occlusionMap&&(b.occlusionMap=c.occlusionMap.id),c.alphaMap&&(b.alphaMap=c.alphaMap.id),c.normalMap&&(b.normalMap=c.normalMap.id),b},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.MetallicMaterial=xeogl.Material.extend({type:"xeogl.MetallicMaterial",_init:function(a){this._state=new xeogl.renderer.MetallicMaterial({type:"MetallicMaterial",baseColor:xeogl.math.vec4([1,1,1]),emissive:xeogl.math.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,baseColorMap:null,alphaMap:null,metallicMap:null,roughnessMap:null,metallicRoughnessMap:null,emissiveMap:null,occlusionMap:null,normalMap:null,alphaMode:null,alphaCutoff:null,backfaces:null,frontface:null,hash:null}),this._hashDirty=!0,this.on("dirty",function(){this._hashDirty=!0},this),this.baseColor=a.baseColor,this.metallic=a.metallic,this.roughness=a.roughness,this.specularF0=a.specularF0,this.emissive=a.emissive,this.alpha=a.alpha,a.baseColorMap&&(this.baseColorMap=a.baseColorMap),a.metallicMap&&(this.metallicMap=a.metallicMap),a.roughnessMap&&(this.roughnessMap=a.roughnessMap),a.metallicRoughnessMap&&(this.metallicRoughnessMap=a.metallicRoughnessMap),a.emissiveMap&&(this.emissiveMap=a.emissiveMap),a.occlusionMap&&(this.occlusionMap=a.occlusionMap),a.alphaMap&&(this.alphaMap=a.alphaMap),a.normalMap&&(this.normalMap=a.normalMap),this.alphaMode=a.alphaMode,this.alphaCutoff=a.alphaCutoff,this.backfaces=a.backfaces,this.frontface=a.frontface},_props:{baseColor:{set:function(a){var b=this._state.baseColor;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.baseColor=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty=!0,this.fire("baseColor",this._state.baseColor)},get:function(){return this._state.baseColor}},baseColorMap:{set:function(a){this._attachComponent("xeogl.Texture","baseColorMap",a)},get:function(){return this._attached.baseColorMap}},metallic:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.metallic!==a&&(this._state.metallic=a,this._renderer.imageDirty=!0,this.fire("metallic",this._state.metallic))},get:function(){return this._state.metallic}},metallicMap:{set:function(a){this._attachComponent("xeogl.Texture","metallicMap",a)},get:function(){return this._attached.metallicMap}},roughness:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.roughness!==a&&(this._state.roughness=a,this._renderer.imageDirty=!0,this.fire("roughness",this._state.roughness))},get:function(){return this._state.roughness}},roughnessMap:{set:function(a){this._attachComponent("xeogl.Texture","roughnessMap",a)},get:function(){return this._attached.roughnessMap}},metallicRoughnessMap:{set:function(a){this._attachComponent("xeogl.Texture","metallicRoughnessMap",a)},get:function(){return this._attached.metallicRoughnessMap}},specularF0:{set:function(a){a=void 0!==a&&null!==a?a:0,this._state.specularF0!==a&&(this._state.specularF0=a,this._renderer.imageDirty=!0,this.fire("specularF0",this._state.specularF0))},get:function(){return this._state.specularF0}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty=!0,this.fire("emissive",this._state.emissive)},get:function(){return this._state.emissive}},emissiveMap:{set:function(a){this._attachComponent("xeogl.Texture","emissiveMap",a)},get:function(){return this._attached.emissiveMap}},occlusionMap:{set:function(a){this._attachComponent("xeogl.Texture","occlusionMap",a)},get:function(){return this._attached.occlusionMap}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty=!0,this.fire("alpha",this._state.alpha))},get:function(){return this._state.alpha}},alphaMap:{set:function(a){this._attachComponent("xeogl.Texture","alphaMap",a)},get:function(){return this._attached.alphaMap}},normalMap:{set:function(a){this._attachComponent("xeogl.Texture","normalMap",a)},get:function(){return this._attached.normalMap}},alphaMode:function(){var a={opaque:0,mask:1,blend:2},b=["opaque","mask","blend"];return{set:function(b){b=b||"opaque";var c=a[b];void 0===c&&(this.error("Unsupported value for 'alphaMode': "+b+" defaulting to 'opaque'"),c="opaque"),this._state.alphaMode!==c&&(this._state.alphaMode=c,this._renderer.imageDirty=!0,this.fire("alphaMode",this._state.alphaMode))},get:function(){return b[this._state.alphaMode]}}}(),alphaCutoff:{set:function(a){null!==a&&void 0!==a||(a=.5),this._state.alphaCutoff!==a&&(this._state.alphaCutoff=a,this.fire("alphaCutoff",this._state.alphaCutoff))},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty=!0,this.fire("backfaces",this._state.backfaces))},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty=!0,this.fire("frontface",this._state.frontface?"ccw":"cw"))},get:function(){return this._state.frontface?"ccw":"cw"}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:null,this._hashDirty=!0},_compile:function(){this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.material=this._state},_makeHash:function(){var a=this._state,b=["/met"];a.baseColorMap&&(b.push("/bm"),a.baseColorMap.matrix&&b.push("/mat")),a.metallicMap&&(b.push("/mm"),a.metallicMap.matrix&&b.push("/mat")),a.roughnessMap&&(b.push("/rm"),a.roughnessMap.matrix&&b.push("/mat")),a.metallicRoughnessMap&&(b.push("/mrm"),a.metallicRoughnessMap.matrix&&b.push("/mat")),a.emissiveMap&&(b.push("/em"),a.emissiveMap.matrix&&b.push("/mat")),a.occlusionMap&&(b.push("/ocm"),a.occlusionMap.matrix&&b.push("/mat")),a.alphaMap&&(b.push("/opm"),a.alphaMap.matrix&&b.push("/mat")),a.normalMap&&(b.push("/nm"),a.normalMap.matrix&&b.push("/mat")),b.push(";"),a.hash=b.join("")},_getJSON:function(){var a=xeogl.math.vecToArray,b={baseColor:a(this._state.baseColor),metallic:this._state.metallic,roughness:this._state.roughness,specularF0:this._state.specularF0,emissive:a(this._state.emissive),alpha:this._state.alpha,alphaMode:this.alphaMode,alphaCutoff:this._state.alphaCutoff,backfaces:this._state.backfaces,frontface:this.frontface},c=this._attached;return c.baseColorMap&&(b.baseColorMap=c.baseColorMap.id),c.metallicMap&&(b.metallicMap=c.metallicMap.id),c.roughnessMap&&(b.roughnessMap=c.roughnessMap.id),c.metallicRoughnessMap&&(b.metallicRoughnessMap=c.metallicRoughnessMap.id),c.emissiveMap&&(b.emissiveMap=c.emissiveMap.id),c.occlusionMap&&(b.occlusionMap=c.occlusionMap.id),c.normalMap&&(b.normalMap=c.normalMap.id),b},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Texture=xeogl.Component.extend({type:"xeogl.Texture",_init:function(a){this._state=new xeogl.renderer.Texture({texture:new xeogl.renderer.webgl.Texture2D(this.scene.canvas.gl),matrix:null,minFilter:null,magFilter:null,wrapS:null,wrapT:null,flipY:!1}),this._src=null,this._image=null,this._translate=xeogl.math.vec2([0,0]),this._scale=xeogl.math.vec2([1,1]),this._rotate=xeogl.math.vec2([0,0]),this._matrixDirty=!1,this._srcDirty=!1,this._imageDirty=!1,this._propsDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.translate=a.translate,this.scale=a.scale,this.rotate=a.rotate,this.minFilter=a.minFilter,this.magFilter=a.magFilter,this.wrapS=a.wrapS,this.wrapT=a.wrapT,this.flipY=a.flipY,a.src?this.src=a.src:a.image&&(this.image=a.image),xeogl.stats.memory.textures++},_webglContextRestored:function(){this._state.texture=null,this._matrixDirty=!0,this._propsDirty=!0,this._image?this._imageDirty=!0:this._src&&(this._srcDirty=!0),this._needUpdate()},_update:function(){var a=this.scene.canvas.gl,b=this._state;if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);if(this._imageDirty&&this._image&&(b.texture||(b.texture=new xeogl.renderer.webgl.Texture2D(a)),b.texture.setImage(this._image,b),b.renderable=!0,this._imageDirty=!1,this._propsDirty=!0),this._matrixDirty){var c,d;0===this._translate[0]&&0===this._translate[1]||(c=xeogl.math.translationMat4v([this._translate[0],this._translate[1],0])),1===this._scale[0]&&1===this._scale[1]||(d=xeogl.math.scalingMat4v([this._scale[0],this._scale[1],1]),c=c?xeogl.math.mulMat4(c,d):d),0!==this._rotate&&(d=xeogl.math.rotationMat4v(.0174532925*this._rotate,[0,0,1]),c=c?xeogl.math.mulMat4(c,d):d);var e=b.matrix;b.matrix=c,this._matrixDirty=!1,!!c!=!!e&&this.fire("dirty")}this._propsDirty&&(b.texture&&b.texture.setProps&&b.texture.setProps(b),this._propsDirty=!1),this._renderer.imageDirty=!0},_loadSrc:function(a){var b=this,c=new Image,d=this.scene.canvas.spinner,e=d.textures;c.onload=function(){b._src===a&&(b._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(c),b._imageDirty=!0,b._srcDirty=!1,e&&d.processes--,b._needUpdate(),b.fire("image",b._image),b.fire("loaded",b._src))},c.onerror=function(){e&&d.processes--},0===a.indexOf("data")?c.src=a:(c.crossOrigin="Anonymous",c.src=a,e&&d.processes++)},_props:{image:{set:function(a){this._image=xeogl.renderer.webgl.ensureImageSizePowerOfTwo(a),this._src=null,this._imageDirty=!0,this._srcDirty=!1,this._needUpdate(),this.fire("image",this._image)},get:function(){return this._image}},src:{set:function(a){this._image=null,this._src=a,this._imageDirty=!1,this._srcDirty=!0,this._needUpdate(),this.fire("src",this._src)},get:function(){return this._src}},translate:{set:function(a){this._translate.set(a||[0,0]),this._matrixDirty=!0,this._needUpdate(),this.fire("translate",this._translate)},get:function(){return this._translate}},scale:{set:function(a){this._scale.set(a||[1,1]),this._matrixDirty=!0,this._needUpdate(),this.fire("scale",this._scale)},get:function(){return this._scale}},rotate:{set:function(a){a=a||0,this._rotate!==a&&(this._rotate=a,this._matrixDirty=!0,this._needUpdate(),this.fire("rotate",this._rotate))},get:function(){return this._rotate}},minFilter:{set:function(a){a=a||"linearMipmapLinear","linear"!==a&&"linearMipmapNearest"!==a&&"linearMipmapLinear"!==a&&"nearestMipmapLinear"!==a&&"linearMipmapLinear"!==a&&(this.error("Unsupported value for 'minFilter': '"+a+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),a="linearMipmapLinear"),this._state.minFilter=a,this._propsDirty=!0,this._needUpdate(),this.fire("minFilter",this._state.minFilter)},get:function(){return this._state.minFilter}},magFilter:{set:function(a){a=a||"linear","linear"!==a&&"nearest"!==a&&(this.error("Unsupported value for 'magFilter': '"+a+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),a="linear"),this._state.magFilter=a,this._propsDirty=!0,this._needUpdate(),this.fire("magFilter",this._state.magFilter)},get:function(){return this._state.magFilter}},wrapS:{set:function(a){a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapS': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),this._state.wrapS=a,this._propsDirty=!0,this._needUpdate(),this.fire("wrapS",this._state.wrapS)},get:function(){return this._state.wrapS}},wrapT:{set:function(a){a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapT': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),this._state.wrapT=a,this._propsDirty=!0,this._needUpdate(),this.fire("wrapT",this._state.wrapT)},get:function(){return this._state.wrapT}},flipY:{set:function(a){a=!!a,this._state.flipY!==a&&(this._state.flipY=a,this._imageDirty=!0,this._needUpdate(),this.fire("flipY",this._state.flipY))},get:function(){return this._state.flipY}}},_getJSON:function(){var a={};return!this._translate||0===this._translate[0]&&0===this._translate[1]||(a.translate=xeogl.math.vecToArray(this._translate)),!this._scale||1===this._scale[0]&&1===this._scale[1]||(a.scale=xeogl.math.vecToArray(this._scale)),0!==this._rotate&&(a.rotate=this._rotate),"linearMipmapLinear"!==this._state.minFilter&&(a.minFilter=this._state.minFilter),"linear"!==this._state.magFilter&&(a.magFilter=this._state.magFilter),"repeat"!==this._state.wrapS&&(a.wrapS=this._state.wrapS),"repeat"!==this._state.wrapT&&(a.wrapT=this._state.wrapT),!1!==this._state.flipY&&(a.flipY=this._state.flipY),this._src?a.src=this._src:this._image,a},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Fresnel=xeogl.Component.extend({type:"xeogl.Fresnel",_init:function(a){this._state=new xeogl.renderer.Fresnel({edgeColor:xeogl.math.vec3([0,0,0]),centerColor:xeogl.math.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=a.edgeColor,this.centerColor=a.centerColor,this.edgeBias=a.edgeBias,this.centerBias=a.centerBias,this.power=a.power},_props:{edgeColor:{set:function(a){this._state.edgeColor.set(a||[0,0,0]),this._renderer.imageDirty=!0,this.fire("edgeColor",this._state.edgeColor)},get:function(){return this._state.edgeColor}},centerColor:{set:function(a){this._state.centerColor.set(a||[1,1,1]),this._renderer.imageDirty=!0,this.fire("centerColor",this._state.centerColor)},get:function(){return this._state.centerColor}},edgeBias:{set:function(a){this._state.edgeBias=a||0,this._renderer.imageDirty=!0,this.fire("edgeBias",this._state.edgeBias)},get:function(){return this._state.edgeBias}},centerBias:{set:function(a){this._state.centerBias=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this.fire("centerBias",this._state.centerBias)},get:function(){return this._state.centerBias}},power:{set:function(a){this._state.power=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this.fire("power",this._state.power)},get:function(){return this._state.power}}},_getJSON:function(){xeogl.math.vecToColor;return{edgeColor:xeogl.math.vecToArray(this._state.edgeColor),centerColor:xeogl.math.vecToArray(this._state.centerColor),edgeBias:this._state.edgeBias,centerBias:this._state.centerBias,power:this._state.power}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Entity=xeogl.Component.extend({type:"xeogl.Entity",_init:function(a){this._state=new xeogl.renderer.Modes({visible:!0,culled:!1,pickable:null,clippable:null,xrayed:null,collidable:null,castShadow:null,receiveShadow:null,outlined:null,layer:null,billboard:null,hash:""}),this._loading=a.loading,!0===this._loading&&this.scene.canvas.spinner.processes++,this.camera=a.camera,this.clips=a.clips,this.geometry=a.geometry,this.lights=a.lights,this.material=a.material,this.morphTargets=a.morphTargets,this.transform=a.transform,this.stationary=a.stationary,this.viewport=a.viewport,this.outline=a.outline,this.xray=a.xray,this.visible=a.visible,this.culled=a.culled,this.pickable=a.pickable,this.clippable=a.clippable,this.xrayed=a.xrayed,this.collidable=a.collidable,this.castShadow=a.castShadow,this.receiveShadow=a.receiveShadow,this.outlined=a.outlined,this.layer=a.layer,this.stationary=a.stationary,this.billboard=a.billboard,this._worldBoundary=null,this._viewBoundary=null,this._canvasBoundary=null,this._worldPositions=null,this._worldBoundaryDirty=!0,this._worldPositionsDirty=!0,this._viewBoundaryDirty=!0,this._canvasBoundaryDirty=!0},_props:{camera:{set:function(a){this._setViewBoundaryDirty(),this._attach({name:"camera",type:"xeogl.Camera",component:a,sceneDefault:!0,on:{viewMatrix:{callback:this._setViewBoundaryDirty,scope:this},projMatrix:{callback:this._setCanvasBoundaryDirty,scope:this}}})},get:function(){return this._attached.camera}},clips:{set:function(a){this._attach({name:"clips",type:"xeogl.Clips",component:a,sceneDefault:!0})},get:function(){return this._attached.clips}},geometry:{set:function(a){this._setWorldBoundaryDirty(),this._attach({name:"geometry",type:"xeogl.Geometry",component:a,sceneDefault:!0,on:{positions:{callback:this._setWorldBoundaryDirty,scope:this},destroyed:{callback:this._setWorldBoundaryDirty,scope:this}}})},get:function(){return this._attached.geometry}},lights:{set:function(a){this._attach({name:"lights",type:"xeogl.Lights",component:a,sceneDefault:!0})},get:function(){return this._attached.lights}},material:{set:function(a){this._attach({name:"material",type:"xeogl.Material",component:a,sceneDefault:!0})},get:function(){return this._attached.material}},morphTargets:{set:function(a){this._attach({name:"morphTargets",type:"xeogl.MorphTargets",component:a,sceneDefault:!0})},get:function(){return this._attached.morphTargets}},transform:{set:function(a){this._setWorldBoundaryDirty(),this._attach({name:"transform",type:"xeogl.Transform",component:a,sceneDefault:!0,on:{updated:{callback:function(){this._transformDirty||(this._transformDirty=!0,xeogl.scheduleTask(this._transformUpdated,this))},scope:this},destroyed:{callback:this._setWorldBoundaryDirty,scope:this}}})},get:function(){return this._attached.transform}},viewport:{set:function(a){this._attach({name:"viewport",type:"xeogl.Viewport",component:a,sceneDefault:!0})},get:function(){return this._attached.viewport}},outline:{set:function(a){this._attach({name:"outline",type:"xeogl.Outline",component:a,sceneDefault:!0})},get:function(){return this._attached.outline}},xray:{set:function(a){this._attach({name:"xray",type:"xeogl.XRay",component:a,sceneDefault:!0})},get:function(){return this._attached.xray}},visible:{set:function(a){this._state.visible=!1!==a,this._renderer.imageDirty=!0,this.fire("visible",this._state.visible)},get:function(){return this._state.visible}},culled:{set:function(a){this._state.culled=!!a,this._renderer.imageDirty=!0,this.fire("culled",this._state.culled)},get:function(){return this._state.culled}},pickable:{set:function(a){a=!1!==a,this._state.pickable!==a&&(this._state.pickable=a,this.fire("pickable",this._state.pickable))},get:function(){return this._state.pickable}},clippable:{set:function(a){a=!1!==a,this._state.clippable!==a&&(this._state.clippable=a,this._renderer.imageDirty=!0,this.fire("clippable",this._state.clippable))},get:function(){return this._state.clippable}},collidable:{set:function(a){(a=!1!==a)!==this._state.collidable&&(this._state.collidable=a,this.fire("collidable",this._state.collidable))},get:function(){return this._state.collidable}},castShadow:{set:function(a){(a=!1!==a)!==this._state.castShadow&&(this._state.castShadow=a,this._renderer.imageDirty=!0,this.fire("castShadow",this._state.castShadow))},get:function(){return this._state.castShadow}},receiveShadow:{set:function(a){(a=!1!==a)!==this._state.receiveShadow&&(this._state.receiveShadow=a,this._state.hash=a?"/mod/rs;":"/mod;",this.fire("dirty",this),this.fire("receiveShadow",this._state.receiveShadow))},get:function(){return this._state.receiveShadow}},outlined:{set:function(a){(a=!!a)!==this._state.outlined&&(this._state.outlined=a,this._renderer.imageDirty=!0,this.fire("outlined",this._state.outlined))},get:function(){return this._state.outlined}},xrayed:{set:function(a){a=!!a,this._state.xrayed!==a&&(this._state.xrayed=a,this._renderer.imageDirty=!0,this.fire("xrayed",this._state.xrayed))},get:function(){return this._state.xrayed}},layer:{set:function(a){a=a||0,(a=Math.round(a))!==this._state.layer&&(this._state.layer=a,this._renderer.stateOrderDirty=!0,this.fire("layer",this._state.layer))},get:function(){return this._state.layer}},stationary:{set:function(a){a=!!a,this._state.stationary!==a&&(this._state.stationary=a,this.fire("dirty",this),this.fire("stationary",this._state.stationary))},get:function(){return this._state.stationary}},billboard:{set:function(a){a=a||"none","spherical"!==a&&"cylindrical"!==a&&"none"!==a&&(this.error("Unsupported value for 'billboard': "+a+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),a="none"),this._state.billboard!==a&&(this._state.billboard=a,this._state.hash=(this._state.active?"a;":";")+(this._state.billboard?"s;":";"),this.fire("dirty",this),this.fire("billboard",this._state.billboard))},get:function(){return this._state.billboard}},localBoundary:{get:function(){return this._attached.geometry.localBoundary}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this;this._worldBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!a._worldBoundaryDirty&&(a._worldBoundaryDirty=!1,!0)},getOBB:function(){var b=a._attached.geometry;if(b){return b.localBoundary.obb}},getMatrix:function(){var b=a._attached.transform;return a._transformDirty&&(b._buildLeafMatrix(),a._setWorldBoundaryDirty(),a._transformDirty=!1),b.leafMatrix}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null})}return this._worldBoundary}},viewBoundary:{get:function(){if(!this._viewBoundary){var a=this;this._viewBoundary=this.create({type:"xeogl.Boundary3D",getDirty:function(){return!!a._viewBoundaryDirty&&(a._viewBoundaryDirty=!1,!0)},getOBB:function(){return a.worldBoundary.obb},getMatrix:function(){return a._attached.camera.view.matrix}}),this._viewBoundary.on("destroyed",function(){a._viewBoundary=null})}return this._viewBoundary}},canvasBoundary:{get:function(){if(!this._canvasBoundary){var a=this;this._canvasBoundary=this.create({type:"xeogl.Boundary2D",getDirty:function(){return!!a._canvasBoundaryDirty&&(a._canvasBoundaryDirty=!1,!0)},getOBB:function(){return a.viewBoundary.obb},getMatrix:function(){return a._attached.camera.project.matrix}}),this._canvasBoundary.on("destroyed",function(){a._canvasBoundary=null})}return this._canvasBoundary}},worldPositions:{get:function(){if(this._worldPositionsDirty){var a=this.geometry.positions;this._worldPositions||(this._worldPositions=new Float32Array(a.length)),this._attached.transform?xeogl.math.transformPositions3(this._attached.transform.leafMatrix,a,this._worldPositions):this._worldPositions.set(a),this._worldPositionsDirty=!1}return this._worldPositions},set:function(a){(a=null===a)&&(this._worldPositions=null,this._worldPositionsDirty=!0)}},glsl:{get:function(){var a=this._renderer.objects[this.id];if(!a)return null;var b=a.program.program.source;return{draw:{vertex:b.vertexDraw,fragment:b.fragmentDraw},pickObject:{vertex:b.vertexPickObject,fragment:b.fragmentPickObject},pickPrimitive:{vertex:b.vertexPickPrimitive,fragment:b.fragmentPickPrimitive}}}},glslString:{get:function(){var a=this.glsl;if(a)return JSON.stringify(a,"\n",4)}}},_transformUpdated:function(){this._transformDirty&&(this._attached.transform._buildLeafMatrix(),this._setWorldBoundaryDirty(),this._transformDirty=!1)},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldPositionsDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0),this._setViewBoundaryDirty();var a=this._attached.lights;a&&a._shadowsDirty()},_setViewBoundaryDirty:function(){this._viewBoundaryDirty=!0,this._viewBoundary&&this._viewBoundary.fire("updated",!0),this._setCanvasBoundaryDirty()},_setCanvasBoundaryDirty:function(){this._canvasBoundaryDirty=!0,this._canvasBoundary&&this._canvasBoundary.fire("updated",!0)},_valid:function(){var a=this._attached.geometry;return!this.destroyed&&a&&a.positions},_compileAsynch:function(){var a=this;if(!this._compiling){a._compiling=!0;var b=this._renderer.objects[this.id];b&&(b.compiled=!1);var c=function(){if(!a._valid())return void xeogl.scheduleTask(c);a._compile(),a._compiling=!1};xeogl.scheduleTask(c)}},_compile:function(){var a=this._attached;a.camera._compile(),a.clips._compile(),a.geometry._compile(),a.lights._compile(),a.material._compile(),this._renderer.modelTransform=a.transform._state,a.viewport._compile(),a.outline._compile(),a.xray._compile(),this._makeHash(),this._renderer.modes=this._state;var b=this.id,c=this._renderer.buildObject(b);this._loading&&(this.scene.canvas.spinner.processes--,this._loading=!1,this.fire("loaded",!0)),c&&c.error&&this.error(c.errorLog.join("\n"))},_makeHash:function(){var a=[],b=this._state;b.stationary&&a.push("/s"),"none"===b.billboard?a.push("/n"):"spherical"===b.billboard?a.push("/s"):"cylindrical"===b.billboard&&a.push("/c"),a.push(";"),this._state.hash=a.join("")},_getJSON:function(){var a=this._attached;return{camera:a.camera.id,clips:a.clips.id,geometry:a.geometry.id,lights:a.lights.id,material:a.material.id,transform:a.transform.id,viewport:a.viewport.id,outline:a.outline.id,xray:a.xray.id,visible:this._state.visible,culled:this._state.culled,pickable:this._state.pickable,clippable:this._state.clippable,collidable:this._state.collidable,castShadow:this._state.castShadow,receiveShadow:this._state.receiveShadow,outlined:this._state.outlined,xrayed:this._state.xrayed,layer:this._state.layer,stationary:this._state.stationary,billboard:this._state.billboard}},_destroy:function(){this._renderer.removeObject(this.id)}})}(),function(){"use strict";xeogl.Viewport=xeogl.Component.extend({type:"xeogl.Viewport",_init:function(a){this._state=new xeogl.renderer.Viewport({boundary:[0,0,100,100]}),this.boundary=a.boundary,this.autoBoundary=a.autoBoundary},_props:{boundary:{set:function(a){if(!this._autoBoundary){if(!a){var b=this.scene.canvas.boundary;a=[0,0,b[2],b[3]]}this._state.boundary=a,this._renderer.imageDirty=!0,this.fire("boundary",this._state.boundary)}},get:function(){return this._state.boundary}},autoBoundary:{set:function(a){(a=!!a)!==this._autoBoundary&&(this._autoBoundary=a,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(a){var b=a[2],c=a[3];this._state.boundary=[0,0,b,c],this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))},get:function(){return this._autoBoundary}}},_compile:function(){this._renderer.viewport=this._state},_getJSON:function(){var a={};return this._autoBoundary?a.autoBoundary=!0:a.boundary=xeogl.math.vecToArray(this._state.boundary),a}})}(),function(){"use strict";xeogl.Boundary2D=xeogl.Component.extend({type:"xeogl.Boundary2D",_init:function(a){this._obb=null,this._aabb=a.aabb||null,this._center=a.center||null,this._getDirty=a.getDirty,this._getOBB=a.getOBB,this._getMatrix=a.getMatrix},_props:{aabb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._aabb}},center:{get:function(){return this._getDirty()&&this._buildBoundary(),this._center}}},_buildBoundary:function(){var a=xeogl.math,b=this.scene.canvas.canvas,c=b.width,d=b.height;this._obb||(this._obb=a.OBB3(),this._aabb=a.AABB2(),this._center=a.vec2());var e=this._getOBB(),f=this._getMatrix();e&&f&&(a.transformOBB3(f,e,this._obb),a.OBB3ToAABB2(this._obb,this._aabb),a.AABB2ToCanvas(this._aabb,c,d),a.getAABB2Center(this._aabb,this._center))},_getJSON:function(){var a=xeogl.math.vecToArray;return{aabb:a(this.aabb),center:a(this.center)}}})}(),function(){"use strict";xeogl.Boundary3D=xeogl.Component.extend({type:"xeogl.Boundary3D",_init:function(a){this._obb=a.obb||null,this._aabb=a.aabb||null,this._center=a.center||null,this._getDirty=a.getDirty,this._getOBB=a.getOBB,this._getAABB=a.getAABB,this._getMatrix=a.getMatrix,this._getPositions=a.getPositions},_props:{obb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._obb}},aabb:{get:function(){return this._getDirty()&&this._buildBoundary(),this._aabb}},center:{get:function(){return this._getDirty()&&this._buildBoundary(),this._center}}},
_buildBoundary:function(){var a=xeogl.math;this._obb||(this._obb=xeogl.math.OBB3()),this._aabb||(this._aabb=xeogl.math.AABB3()),this._center||(this._center=xeogl.math.vec3());var b=this._getAABB?this._getAABB():null;if(b)return this._aabb[0]=b[0],this._aabb[1]=b[1],this._aabb[2]=b[2],this._aabb[3]=b[3],this._aabb[4]=b[4],this._aabb[5]=b[5],a.AABB3ToOBB3(this._aabb,this._obb),void a.getAABB3Center(this._aabb,this._center);var c,d=this._getPositions?this._getPositions():null;if(d)return(c=this._getMatrix?this._getMatrix():null)?(a.positions3ToAABB3(d,this._aabb),a.AABB3ToOBB3(this._aabb,this._obb),a.transformOBB3(c,this._obb),void a.getAABB3Center(this._aabb,this._center)):(a.positions3ToAABB3(d,this._aabb),a.AABB3ToOBB3(this._aabb,this._obb),void a.getAABB3Center(this._aabb,this._center));var e=this._getOBB?this._getOBB():null;if(e){if(c=this._getMatrix?this._getMatrix():null)return a.transformOBB3(c,e,this._obb),a.OBB3ToAABB3(this._obb,this._aabb),void a.getAABB3Center(this._aabb,this._center);for(var f=0,g=e.length;f<g;f++)this._obb[f]=e[f];a.OBB3ToAABB3(this._obb,this._aabb),a.getAABB3Center(this._aabb,this._center)}},_getJSON:function(){var a=xeogl.math.vecToArray;return{obb:a(this.obb),aabb:a(this.aabb),center:a(this.center)}}})}(),function(){"use strict";xeogl.Transform=xeogl.Component.extend({type:"xeogl.Transform",_init:function(a){this._onParentUpdated=null,this._onParentDestroyed=null,this._matrix=xeogl.math.identityMat4(xeogl.math.mat4()),this._leafMatrix=xeogl.math.mat4(),this._leafNormalMatrix=xeogl.math.mat4(),this._leafMatrixDirty=!0,this._leafNormalMatrixDirty=!0;var b=this;this._state=new xeogl.renderer.Transform({getMatrix:function(){return b._leafMatrixDirty&&b._buildLeafMatrix(),b._leafMatrix},getNormalMatrix:function(){return b._leafNormalMatrixDirty&&b._buildLeafNormalMatrix(),b._leafNormalMatrix}}),this.parent=a.parent,this.matrix=a.matrix,this.postMultiply=a.postMultiply},_parentUpdated:function(){this._leafMatrixDirty=!0,this.fire("updated",!0)},_buildLeafMatrix:function(){if(this._leafMatrixDirty){if(this._build&&this._buildScheduled&&(this._build(),this._buildScheduled=!1),this._parent)this._postMultiply?xeogl.math.mulMat4(this._parent.leafMatrix,this._matrix,this._leafMatrix):xeogl.math.mulMat4(this._matrix,this._parent.leafMatrix,this._leafMatrix);else for(var a=0,b=this._matrix.length;a<b;a++)this._leafMatrix[a]=this._matrix[a];this._renderer.imageDirty=!0,this._leafMatrixDirty=!1,this._leafNormalMatrixDirty=!0}},_buildLeafNormalMatrix:function(){this._leafMatrixDirty&&this._buildLeafMatrix(),xeogl.math.inverseMat4(this._leafMatrix,this._leafNormalMatrix),xeogl.math.transposeMat4(this._leafNormalMatrix),this._renderer.imageDirty=!0,this._leafNormalMatrixDirty=!1},_props:{parent:{set:function(a){if(a)for(var b=this.id,c=a;c;c=c._parent)if(b===c.id)return void this.error("Not allowed to attach Transform as parent of itself - ignoring");!this._parent||a&&a.id===this._parent.id||(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed)),this._parent=a,this.fire("parent",this._parent),this._parent&&(this._onParentUpdated=this._parent.on("updated",this._parentUpdated,this),this._onParentDestroyed=this._parent.on("destroyed",this._parentUpdated,this)),this._parentUpdated()},get:function(){return this._parent}},postMultiply:{set:function(a){a=!1!==a,this._postMultiply!==a&&(this._postMultiply=a,this._leafMatrixDirty=!0,this._renderer.imageDirty=!0,this.fire("updated",!0),this.fire("postMultiply",this._postMultiply))},get:function(){return this._postMultiply}},matrix:{set:function(a){this._matrix.set(a||xeogl.math.identityMat4()),this._leafMatrixDirty=!0,this._renderer.imageDirty=!0,this.fire("matrix",this._matrix),this.fire("updated",!0)},get:function(){return this._updateScheduled&&this._doUpdate(),this._matrix}},leafMatrix:{get:function(){return this._leafMatrixDirty&&this._buildLeafMatrix(),this._leafMatrix}}},_getJSON:function(){var a={matrix:xeogl.math.vecToArray(this._matrix),postMultiply:this._postMultiply};return this._parent&&(a.parent=this._parent.id),a},_destroy:function(){this._parent&&(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed))}})}(),function(){"use strict";xeogl.Rotate=xeogl.Transform.extend({type:"xeogl.Rotate",_init:function(a){this._super(a),this.xyz=a.xyz,this.angle=a.angle},_update:function(){if(0===this._xyz[0]&&0===this._xyz[1]&&0===this._xyz[2])return void this.warn("Rotation axis is [0,0,0] - won't build matrix.");this.matrix=xeogl.math.rotationMat4v(this._angle*xeogl.math.DEGTORAD,this._xyz,this._matrix)},_props:{xyz:{set:function(a){(this._xyz=this._xyz||new xeogl.math.vec3).set(a||[0,1,0]),this._needUpdate(0),this.fire("xyz",this._xyz)},get:function(){return this._xyz}},angle:{set:function(a){this._angle=a||0,this._needUpdate(0),this.fire("angle",this._angle)},get:function(){return this._angle}}},_getJSON:function(){var a={xyz:xeogl.math.vecToArray(this._xyz),angle:this._angle};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";xeogl.Quaternion=xeogl.Transform.extend({type:"xeogl.Quaternion",_init:function(a){this._super(a),this.xyzw=a.xyzw},_props:{xyzw:{set:function(a){var b=xeogl.math;(this._xyzw=this._xyzw||new b.vec4).set(a||b.identityQuaternion()),this.matrix=b.quaternionToMat4(this._xyzw,this._matrix||(this._matrix=xeogl.math.identityMat4())),this.fire("xyzw",this._xyzw)},get:function(){return this._xyzw}}},rotate:function(){var a=xeogl.math,b=a.vec4(),c=a.vec4();return function(d){b[0]=d[0],b[1]=d[1],b[2]=d[2],b[3]=d[3]*a.DEGTORAD,a.angleAxisToQuaternion(b,c),this.xyzw=a.mulQuaternions(this._xyzw,c,this._xyzw)}}(),_getJSON:function(){var a={xyzw:xeogl.math.vecToArray(this._xyzw)};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";xeogl.Scale=xeogl.Transform.extend({type:"xeogl.Scale",_init:function(a){this._super(a),this.xyz=a.xyz},_update:function(){this.matrix=xeogl.math.scalingMat4v(this._xyz,this._matrix)},_props:{xyz:{set:function(a){(this._xyz=this._xyz||new xeogl.math.vec3).set(a||[1,1,1]),this._needUpdate(0),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){var a={xyz:xeogl.math.vecToArray(this._xyz)};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";xeogl.Translate=xeogl.Transform.extend({type:"xeogl.Translate",_init:function(a){this._super(a),this.xyz=a.xyz},_update:function(){this.matrix=xeogl.math.translationMat4v(this._xyz,this._matrix)},_props:{xyz:{set:function(a){(this._xyz=this._xyz||new xeogl.math.vec3).set(a||[0,0,0]),this._needUpdate(0),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){var a={xyz:xeogl.math.vecToArray(this._xyz)};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";xeogl.Frustum=xeogl.Transform.extend({type:"xeogl.Frustum",_init:function(a){this._super(a),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=1e4,this.left=a.left,this.right=a.right,this.bottom=a.bottom,this.top=a.top,this.near=a.near,this.far=a.far},_update:function(){this.matrix=xeogl.math.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._matrix)},_props:{left:{set:function(a){this._left=void 0!==a&&null!==a?a:-1,this._needUpdate(0),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(a){this._right=void 0!==a&&null!==a?a:1,this._needUpdate(0),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(a){this._top=void 0!==a&&null!==a?a:1,this._needUpdate(0),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(a){this._bottom=void 0!==a&&null!==a?a:-1,this._needUpdate(0),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._needUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._needUpdate(0),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var a={left:this._left,right:this._right,top:this._top,bottom:this._bottom,near:this._near,far:this._far};return this._parent&&(a.parent=this._parent.id),a}})}(),function(){"use strict";var a=xeogl.math,b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3(),g=a.vec3();xeogl.Lookat=xeogl.Transform.extend({type:"xeogl.Lookat",_init:function(b){this._super(b),this._eye=a.vec3([0,0,10]),this._look=a.vec3([0,0,0]),this._up=a.vec3([0,1,0]),this.eye=b.eye,this.look=b.look,this.up=b.up,this.gimbalLockY=b.gimbalLockY},_update:function(){var b=a.mat4();return function(){a.lookAtMat4v(this._eye,this._look,this._up,b),this.matrix=b}}(),rotateEyeY:function(){var f=a.mat4();return function(g){var h=a.subVec3(this._eye,this._look,b);a.rotationMat4v(.0174532925*g,this._gimbalLockY?a.vec3([0,1,0]):this._up,f),h=a.transformPoint3(f,h,c),this.eye=a.addVec3(h,this._look,d),this._gimbalLockY&&(this.up=a.transformPoint3(f,this._up,e))}}(),rotateEyeX:function(){var h=a.mat4();return function(i){var j=a.subVec3(this._eye,this._look,b),k=a.cross3Vec3(a.normalizeVec3(j,c),a.normalizeVec3(this._up,d));a.rotationMat4v(.0174532925*i,k,h),j=a.transformPoint3(h,j,e),this.eye=a.addVec3(j,this._look,f),this.up=a.transformPoint3(h,this._up,g)}}(),rotateLookY:function(){var f=a.mat4();return function(g){var h=a.subVec3(this._look,this._eye,b);a.rotationMat4v(.0174532925*g,this._gimbalLockY?a.vec3([0,1,0]):this._up,f),h=a.transformPoint3(f,h,c),this.look=a.addVec3(h,this._eye,d),this._gimbalLockY&&(this.up=a.transformPoint3(f,this._up,e))}}(),rotateLookX:function(){var h=a.mat4();return function(i){var j=a.subVec3(this._look,this._eye,b),k=a.cross3Vec3(a.normalizeVec3(j,c),a.normalizeVec3(this._up,d));a.rotationMat4v(.0174532925*i,k,h),j=a.transformPoint3(h,j,e),this.look=a.addVec3(j,this._eye,f),this.up=a.transformPoint3(h,this._up,g)}}(),pan:function(h){var i,j=a.subVec3(this._eye,this._look,b),k=[0,0,0];if(0!==h[0]){var l=a.cross3Vec3(a.normalizeVec3(j,[]),a.normalizeVec3(this._up,c));i=a.mulVec3Scalar(l,h[0]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]}0!==h[1]&&(i=a.mulVec3Scalar(a.normalizeVec3(this._up,d),h[1]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]),0!==h[2]&&(i=a.mulVec3Scalar(a.normalizeVec3(j,e),h[2]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]),this.eye=a.addVec3(this._eye,k,f),this.look=a.addVec3(this._look,k,g)},zoom:function(f){var g=a.subVec3(this._eye,this._look,b),h=Math.abs(a.lenVec3(g,c)),i=Math.abs(h+f);if(!(i<.5)){var j=a.normalizeVec3(g,d);this.eye=a.addVec3(this._look,a.mulVec3Scalar(j,i),e)}},_props:{gimbalLockY:{set:function(a){a=!1!==a,this._gimbalLockY=a,this.fire("gimbalLockY",this._gimbalLockY)},get:function(){return this._gimbalLockY}},eye:{set:function(a){this._eye.set(a||[0,0,10]),this._update(),this.fire("eye",this._eye)},get:function(){return this._eye}},look:{set:function(a){this._look.set(a||[0,0,0]),this._update(),this.fire("look",this._look)},get:function(){return this._look}},up:{set:function(a){this._up.set(a||[0,1,0]),this._update(),this.fire("up",this._up)},get:function(){return this._up}},eyeLookDist:{get:function(){var b=new Float32Array(3);return function(){return a.lenVec3(a.subVec3(this._look,this._eye,b))}}()}},_getJSON:function(){var b=a.vecToArray,c={eye:b(this._eye),look:b(this._look),up:b(this._up),gimbalLockY:this._gimbalLockY};return this._parent&&(c.parent=this._parent.id),c}})}(),function(){"use strict";xeogl.Ortho=xeogl.Transform.extend({type:"xeogl.Ortho",_init:function(a){this._super(a),this.scale=a.scale,this.near=a.near,this.far=a.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)},_update:function(){var a,b,c,d,e=this.scene,f=this._scale,g=e.canvas.canvas,h=g.clientWidth,i=g.clientHeight,j=.5*f,k=h/i;h>i?(a=-j,b=j,c=j/k,d=-j/k):(a=-j*k,b=j*k,c=j,d=-j),this.matrix=xeogl.math.orthoMat4c(a,b,d,c,this._near,this._far,this.__tempMat||(this.__tempMat=xeogl.math.mat4()))},_props:{scale:{set:function(a){this._scale=void 0!==a&&null!==a?a:1,this._needUpdate(0),this.fire("scale",this._scale)},get:function(){return this._scale}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._needUpdate(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._needUpdate(),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var a={scale:this._scale,near:this._near,far:this._far};return this._parent&&(a.parent=this._parent.id),a},_destroy:function(){this._super(),this.scene.canvas.off(this._onCanvasBoundary)}})}(),function(){"use strict";xeogl.Perspective=xeogl.Transform.extend({type:"xeogl.Perspective",_init:function(a){this._super(a),this._dirty=!1,this._fov=50,this._near=.1,this._far=1e4,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=a.fov,this.fovAxis=a.fovAxis,this.near=a.near,this.far=a.far},_update:function(){var a=this.scene.canvas.canvas,b=a.clientWidth/a.clientHeight,c=this._fov,d=this._fovAxis;("x"==d||"min"==d&&b<1||"max"==d&&b>1)&&(c/=b),c=Math.min(c,120),this.matrix=xeogl.math.perspectiveMat4(c*(Math.PI/180),b,this._near,this._far,this._matrix)},_props:{fov:{set:function(a){this._fov=void 0!==a&&null!==a?a:50,this._renderer.imageDirty=!0,this._needUpdate(0),this.fire("fov",this._fov)},get:function(){return this._fov}},fovAxis:{set:function(a){a=a||"min",this._fovAxis!==a&&("x"!==a&&"y"!==a&&"min"!==a&&(this.error("Unsupported value for 'fovAxis': "+a+" - defaulting to 'min'"),a="min"),this._fovAxis=a,this._renderer.imageDirty=!0,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))},get:function(){return this._fovAxis}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._renderer.imageDirty=!0,this._needUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._renderer.imageDirty=!0,this._needUpdate(0),this.fire("far",this._far)},get:function(){return this._far}}},_getJSON:function(){var a={fov:this._fov,fovAxis:this._fovAxis,near:this._near,far:this._far};return this._parent&&(a.parent=this._parent.id),a},_destroy:function(){this._super(),this.scene.canvas.off(this._canvasResized)}})}(),xeogl.version="1.0.0";